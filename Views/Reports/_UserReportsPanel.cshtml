@using System.Security.Claims
@model UserRoles.ViewModels.PagedResult<UserRoles.ViewModels.ReportViewModel>


@{
    Layout = null;

    DateTime today = ViewBag.Today ?? DateTime.Today;
    bool hasToday = ViewBag.HasToday ?? false;

    bool isUser = User.IsInRole("User");
    bool isManager = User.IsInRole("Manager");
    bool isAdmin = User.IsInRole("Admin");

    string currentUserId = User.FindFirstValue(ClaimTypes.NameIdentifier);
    string targetUserId = ViewBag.TargetUserId as string;
    string addDate = ViewBag.AddDate as string;

    bool showAddReportForOthers =
        (isManager || isAdmin) && targetUserId != currentUserId;

    bool isViewingOthers = targetUserId != currentUserId;
    bool showReviewerColumn = true;
}
<style>
    /* ===== FORCE ACTION ICON VISIBILITY ===== */
    /* ===== FIX ACTION ICON CLICK ISSUE ===== */

    table {
        position: relative;
        z-index: 1;
    }

    .report-row {
        position: static !important;
    }

    .actions-cell {
        position: relative !important;
        z-index: 9999 !important;
        pointer-events: auto !important;
    }

    .row-actions {
        display: inline-flex !important;
        gap: 8px;
        align-items: center;
        justify-content: center;
        pointer-events: auto !important;
    }

        .row-actions span {
            cursor: pointer;
            font-size: 16px;
            user-select: none;
            pointer-events: auto !important;
        }

</style>


<!-- ================= HEADER ================= -->
<h5 class="mb-3">
    <strong>@ViewBag.ReportOwnerName</strong> Reports
</h5>

<!-- ================= ADD REPORT ================= -->
@if (showAddReportForOthers)
{
    <div class="card mb-3 shadow-sm">
        <div class="card-body py-3">

            <h6 class="mb-3">➕ Add Report</h6>

            <div class="d-flex align-items-center gap-2 mb-3">
                <input type="date"
                       id="addReportDate"
                       class="form-control"
                       style="max-width: 200px"
                       max="@DateTime.Today.ToString("yyyy-MM-dd")" />

                <button type="button"
                        class="btn btn-primary"
                        onclick="showInlineAddReport('@targetUserId')">
                    + Add Report
                </button>
            </div>

            <!-- ONLY CONTAINER -->
            <div id="inlineAddReportContainer" class="d-none"></div>

        </div>
    </div>
}

<!-- ================= SUMMARY ================= -->
<div class="d-flex justify-content-between align-items-center mb-2">
    <div class="text-muted">
        Total Reports: <strong>@Model.TotalItems</strong>
    </div>
    <span class="text-muted">
        Showing @Model.Items.Count of @Model.TotalItems reports
    </span>




    @if (User.IsInRole("Admin") || User.IsInRole("Manager"))
    {
        <a class="btn btn-outline-danger btn-sm"
           href="@Url.Action("DownloadPdf", "Reports", new { userId = ViewBag.TargetUserId })">
            ⬇ Download PDF
        </a>
    }
</div>

<!-- ================= REPORTS TABLE ================= -->
<div class="table-responsive">
    <table class="table table-bordered table-hover align-middle">
        <thead class="table-light text-center">
            <tr>
                <th>Date</th>
                <th>Task</th>
                <th>Note</th>
                @if (showReviewerColumn)
                {
                    <th>Reviewer Comment</th>
                }
                <th>Reported To</th>
                <th>Submitted By</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (Model.Items.Any())
            {
                foreach (var r in Model.Items)
                {
                    // ================= ROLE PERMISSIONS =================
                    bool canView = User.IsInRole("Admin") ||
                    User.IsInRole("Manager") ||
                    User.IsInRole("SubManager");

                    bool canEdit =
                    User.IsInRole("Admin") ||
                    (User.IsInRole("Manager") &&
                    (r.SubmittedByRole == "User" || r.SubmittedByRole == "SubManager")) || r.SubmittedByRole == "Admin" || (User.IsInRole("Manager")) ||
                    (User.IsInRole("SubManager") &&
                    r.SubmittedByRole == "User");

                    bool canDelete = User.IsInRole("Admin");

                    <tr class="report-row"
                        id="report-row-@r.Id"
                        data-report-id="@r.Id"
                        data-task="@r.Task"
                        data-note="@r.Note"
                        data-reviewer="@r.ReviewerComment"
                        data-userid="@r.ApplicationUserId">

                        <td>@r.Date.ToString("dd-MM-yyyy")</td>
                        <td class="report-task">@r.Task</td>
                        <td class="report-note">@r.Note</td>
                        @if (showReviewerColumn)
                        {
                            <td class="report-reviewer">
                                @(string.IsNullOrWhiteSpace(r.ReviewerComment) ? "—" : r.ReviewerComment)
                            </td>
                        }

                        <td>@r.ReportedTo</td>
                        <td class="text-center col-submitted">@r.SubmittedByRole</td>

                        <!-- ================= ACTIONS COLUMN ================= -->
                        <td class="actions-cell text-center">
                            <div class="row-actions">

                                <!-- VIEW -->
                                <a title="View"
                                   href="javascript:void(0)"
                                   onclick="viewReport(@r.Id)">
                                    👁
                                </a>

                                <!-- EDIT -->
                                @if (canEdit)
                                {
                                    <a title="Edit"
                                       href="javascript:void(0)"
                                       onclick="window.startInlineEdit(@r.Id)">
                                        ✏️
                                    </a>


                                }

                                <!-- DELETE -->
                                @if (canDelete)
                                {
                                    <a title="Delete"
                                       href="javascript:void(0)"
                                       onclick="deleteReport(@r.Id)">
                                        🗑
                                    </a>
                                }

                            </div>
                        </td>




     
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        No reports found
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@if (Model.TotalPages > 1)
{
    <div class="d-flex justify-content-center align-items-center gap-3 mt-3" id="reportsPagination">
        <button class="btn btn-outline-secondary btn-sm pagination-btn"
                data-userid="@ViewBag.TargetUserId"
                data-page="@(Model.Page - 1)"
                @(Model.Page == 1 ? "disabled" : "")>
            ← Previous
        </button>

        <span class="fw-semibold">
            Page @Model.Page of @Model.TotalPages
        </span>

        <button class="btn btn-outline-secondary btn-sm pagination-btn"
                data-userid="@ViewBag.TargetUserId"
                data-page="@(Model.Page + 1)"
                @(Model.Page == Model.TotalPages ? "disabled" : "")>
            Next →
        </button>
    </div>
}

<script>
    window.__isAdmin = @User.IsInRole("Admin").ToString().ToLower();
    window.__isManager = @User.IsInRole("Manager").ToString().ToLower();
    window.__isSubManager = @User.IsInRole("SubManager").ToString().ToLower();
</script>


    <script>
        let currentlyEditingRow = null;

        // ================= START INLINE EDIT =================
            window.startInlineEdit = function (reportId) {

            // Allow only one row editing at a time
            if (currentlyEditingRow) {
                alert("Finish editing the current report first.");
                return;
            }

            const row = document.getElementById(`report-row-${reportId}`);
            if (!row) return;

            currentlyEditingRow = reportId;

            const taskCell = row.querySelector(".report-task");
            const noteCell = row.querySelector(".report-note");
            const reviewerCell = row.querySelector(".report-reviewer");
            const actionsCell = row.querySelector(".actions-cell");

            const originalTask = row.dataset.task;
            const originalNote = row.dataset.note;
            const originalReviewer = row.dataset.reviewer || "";

              taskCell.innerHTML = `
      <textarea class="form-control form-control-sm char-limit"
                id="edit-task-${reportId}"
                maxlength="100"
                data-counter="task-counter-${reportId}">${originalTask}</textarea>
      <small id="task-counter-${reportId}" class="text-muted">
          ${100 - originalTask.length} characters remaining
      </small>
    `;

    noteCell.innerHTML = `
      <textarea class="form-control form-control-sm char-limit"
                id="edit-note-${reportId}"
                maxlength="100"
                data-counter="note-counter-${reportId}">${originalNote}</textarea>
      <small id="note-counter-${reportId}" class="text-muted">
          ${100 - originalNote.length} characters remaining
      </small>
    `;

    if (reviewerCell) {
        const reportUserId = row.dataset.userid || '';
        const currentUserId = '@currentUserId';
        const isOwnReport = (reportUserId === currentUserId);
        const isAdminUser = window.__isAdmin;

        if (isAdminUser || !isOwnReport) {
            reviewerCell.innerHTML = `
              <textarea class="form-control form-control-sm char-limit"
                        id="edit-reviewer-${reportId}"
                        maxlength="100"
                        data-counter="reviewer-counter-${reportId}">${originalReviewer}</textarea>
              <small id="reviewer-counter-${reportId}" class="text-muted">
                  ${100 - originalReviewer.length} characters remaining
              </small>
            `;
        } else {
            // Read-only for own reports
            reviewerCell.innerHTML = `
              <div class="report-text text-muted fst-italic">${originalReviewer || '—'}</div>
              <input type="hidden" id="edit-reviewer-${reportId}" value="${originalReviewer}" />
            `;
        }
    }


            // Replace actions with Update / Cancel
            actionsCell.innerHTML = `
                <button class="btn btn-sm btn-primary me-1"
                        onclick="submitInlineEdit(${reportId})">
                    Update
                </button>
                <button class="btn btn-sm btn-secondary"
                        onclick="cancelInlineEdit(${reportId})">
                    Cancel
                </button>
            `;
        };

        // ================= CANCEL INLINE EDIT =================
        window.cancelInlineEdit = function (reportId) {

            const row = document.getElementById(`report-row-${reportId}`);
            if (!row) return;

            row.querySelector(".report-task").textContent = row.dataset.task;
            row.querySelector(".report-note").textContent = row.dataset.note;
            const reviewerCell = row.querySelector(".report-reviewer");
            if (reviewerCell) {
                reviewerCell.textContent = row.dataset.reviewer || "—";
            }

            restoreRowActions(row, reportId);
            currentlyEditingRow = null;
        };

        // ================= SUBMIT INLINE EDIT =================
        window.submitInlineEdit = async function (reportId) {

            const row = document.getElementById(`report-row-${reportId}`);
            if (!row) return;

            const task = document.getElementById(`edit-task-${reportId}`).value.trim();
            const note = document.getElementById(`edit-note-${reportId}`).value.trim();
            const reviewInput = document.getElementById(`edit-reviewer-${reportId}`);
            const reviewerComment = reviewInput ? reviewInput.value.trim() : row.dataset.reviewer;

            if (!task || !note) {
                alert("Task and Note are required.");
                return;
            }

            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

            const res = await fetch("/Reports/InlineUpdate", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: new URLSearchParams({
                    id: reportId,
                    task,
                    note,
                    reviewerComment,
                    __RequestVerificationToken: token
                })
            });

            if (!res.ok) {
                alert("Failed to update report");
                return;
            }

            // Update UI with new values
            row.dataset.task = task;
            row.dataset.note = note;
            row.dataset.reviewer = reviewerComment;

            row.querySelector(".report-task").textContent = task;
            row.querySelector(".report-note").textContent = note;
            const reviewerCell = row.querySelector(".report-reviewer");
            if (reviewerCell) {
                reviewerCell.textContent = reviewerComment || "—";
            }

            restoreRowActions(row, reportId);
            currentlyEditingRow = null;
        };

        // ================= RESTORE ACTION ICONS =================
                function restoreRowActions(row, reportId) {

        let actionsHtml = `
            <a title="View"
               href="javascript:void(0)"
               onclick="window.viewReport(${reportId})">👁</a>
        `;

        // ✅ Edit allowed for Admin, Manager, SubManager
        if (window.__isuser || window.__isAdmin || window.__isManager || window.__isSubManager) {
            actionsHtml += `
                <a title="Edit"
                   href="javascript:void(0)"
                   onclick="window.startInlineEdit(${reportId})">✏️</a>
            `;
        }

        // ✅ Delete ONLY for Admin
        if (window.__isAdmin) {
            actionsHtml += `
                <a title="Delete"
                   href="javascript:void(0)"
                   onclick="window.deleteReport(${reportId})">🗑</a>
            `;
        }

        row.querySelector(".actions-cell").innerHTML = actionsHtml;
    }


    </script>


    @* <script>
        // ================= INLINE EDIT REPORT =================
        function openInlineEditReport(reportId) {

            const panel = document.getElementById("detailsPanel");
            if (!panel) {
                console.warn("detailsPanel not found");
                return;
            }

            const userId = "@ViewBag.TargetUserId";

            panel.dataset.userid = userId;
            panel.innerHTML = "<div class='text-muted p-3'>Loading edit form...</div>";

            fetch(`/Reports/EditReportPanel?reportId=${encodeURIComponent(reportId)}&userId=${encodeURIComponent(userId)}`)
                .then(r => {
                    if (!r.ok) throw r;
                    return r.text();
                })
                .then(html => {
                    panel.innerHTML = html;
                })
                .catch(async err => {
                    let msg = "Failed to load edit form";
                    if (err instanceof Response) {
                        try { msg = await err.text(); } catch {}
                    }
                    panel.innerHTML = `<div class="text-danger p-3">${msg}</div>`;
                });
        }
    </script> *@


    <script>
        document.getElementById("addReportDate")?.addEventListener("change", function () {

            const raw = this.value; // yyyy-MM-dd
            if (!raw) return;

            const [y, m, d] = raw.split("-");
            const formatted = `${d}-${m}-${y}`;

            const userId = "@ViewBag.TargetUserId";

            fetch(`/Reports/CheckReportExists?userId=${encodeURIComponent(userId)}&date=${encodeURIComponent(formatted)}`)
                .then(r => r.json())
                .then(data => {
                    if (data.exists) {
                        alert(`Report already exists on ${formatted}`);
                        this.value = "";
                    }
                })
                .catch(() => {
                    // ignore network errors here
                });
        });
    </script>

    <script>
        function showInlineAddReport(userId) {

            const dateInput = document.getElementById("addReportDate");
            if (!dateInput.value) {
                alert("Please select date");
                return;
            }

            const [y, m, d] = dateInput.value.split("-");
            const formattedDate = `${d}-${m}-${y}`;

            fetch(`/Reports/CheckReportExists?userId=${encodeURIComponent(userId)}&date=${encodeURIComponent(formattedDate)}`)
                .then(r => r.json())
                .then(data => {
                    if (data.exists) {
                        alert("Report already exists for selected date");
                        return;
                    }
                    loadAddReportForm(userId, formattedDate);
                })
                .catch(() => {
                    alert("Failed to check existing report");
                });
        }

        function loadAddReportForm(userId, formattedDate) {
            const container = document.getElementById("inlineAddReportContainer");
            if (!container) return;

            // show loading
            container.classList.remove("d-none");
            container.innerHTML = "<div class='text-muted p-3'>Loading add form...</div>";

            fetch(`/Reports/AddReportPanel?userId=${encodeURIComponent(userId)}&date=${encodeURIComponent(formattedDate)}`)
                .then(res => {
                    if (!res.ok) throw new Error();
                    return res.text();
                })
                .then(html => {
                    container.innerHTML = html;
                    container.classList.remove("d-none");       
                })
                .catch(() => {
                    container.innerHTML = "<div class='text-danger p-3'>Failed to load add form</div>";
                });
        }
    </script>

    <script>
        /* ========== CHAR COUNTER ========== */
        document.addEventListener("input", function (e) {
            if (!e.target.classList.contains("char-limit")) return;
            const counter = document.getElementById(e.target.dataset.counter);
            if (counter) {
                counter.textContent =
                    (100 - e.target.value.length) + " characters remaining";
            }
        });

        // Expose deleteReport used by panel buttons (calls existing controller endpoint)
                /* ================= DELETE REPORT INLINE ================= */
       
    </script>


    <script>
    window.deleteReport = async function (reportId) {

        if (!confirm("Are you sure you want to delete this report?")) {
            return;
        }

        const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

        const res = await fetch("/Reports/DeleteInline", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: new URLSearchParams({
                id: reportId,
                __RequestVerificationToken: token
            })
        });

        if (!res.ok) {
            alert("Failed to delete report");
            return;
        }

        // Remove row from table
        const row = document.getElementById(`report-row-${reportId}`);
        if (row) row.remove();
    };
</script>



    <script>
        document.addEventListener("input", function (e) {

            if (!e.target.classList.contains("char-limit")) return;

            const counterId = e.target.dataset.counter;
            const counter = document.getElementById(counterId);
            if (!counter) return;

            const remaining = 100 - e.target.value.length;
            counter.textContent = `${remaining} characters remaining`;
        });
    </script>


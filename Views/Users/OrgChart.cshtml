@using UserRoles.Models

@{
    var admin = ViewBag.Admin as Users;

    var managers = ViewBag.Managers as List<Users>
                   ?? new List<Users>();

    var subManagers = ViewBag.SubManagers as Dictionary<string, List<Users>>
                      ?? new Dictionary<string, List<Users>>();

    var subManagerUsers = ViewBag.SubManagerUsers as Dictionary<string, List<Users>>
                          ?? new Dictionary<string, List<Users>>();

    var adminUsers = ViewBag.AdminUsers as List<Users>
                     ?? new List<Users>();

    var currentRole = (ViewBag.CurrentRole as string) ?? "User";

}

<script>
    // expose simple client-side flag used by orgchart.js
    window.__isAdmin = @(currentRole == "Admin" ? "true" : "false");
</script>





<div class="org-wrapper-full">

    @* Toasts *@
    @if (TempData["Success"] != null)
    {
        <div class="toast-container-fixed">
            <div class="alert alert-success toast-message auto-dismiss">
                @TempData["Success"]
            </div>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="toast-container-fixed">
            <div class="alert alert-danger toast-message auto-dismiss">
                @TempData["Error"]
            </div>
        </div>
    }

    <!-- LINE DOWN FROM ADMIN -->
    @* <div class="org-line"></div> *@
    <div class="org-layout-full">

        <!-- ================= LEFT PANEL : TREE ================= -->
        <div class="org-left-panel">

            <!-- ================= ADMIN (show ONLY to Admin) ================= -->
            @if (currentRole == "Admin" && admin != null)
            {
                

                <div class="org-admin org-node"
                     data-id="ADMIN"
                     data-role="Admin"
                     ondragover="allowDrop(event)"
                     ondrop="drop(event,'ADMIN')">

                    <div class="org-box admin">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>@admin?.Name</strong>
                                <div class="role">Admin</div>
                            </div>

                            <a href="javascript:void(0)"
                               class="org-plus"
                               onclick="openAddModal('', 'ADMIN')">+</a>
                        </div>
                    </div>



                    @* Admin-held users (users with ParentUserId == null) *@
                    @if (adminUsers != null && adminUsers.Any())
                    {
                        <div class="org-admin-users">
                            @foreach (var auser in adminUsers)
                            {
                                <div class="org-box user org-node xsmall"
                                     data-id="@auser.Id"
                                     data-parent-id="ADMIN"
                                     data-role="User"
                                     draggable="true"
                                     @* onmousedown="prepareDrag(event)" *@
                                     ondragstart="drag(event)">



                                    <div class="node-actions-top above-name">
                                        @if (currentRole == "Admin" || currentRole == "Manager")
                                        {
                                            <a onclick="openEditModal('@auser.Id','@auser.Name','@auser.Email','User')">✏️</a>
                                        }

                                        @if (currentRole == "Admin")
                                        {
                                            <a onclick="openDeleteModal('@auser.Id','@auser.Name','User')">🗑</a>
                                        }

                                        @if (currentRole == "Admin" || currentRole == "Manager")
                                        {
                                            <a href="javascript:void(0)"
                                               onclick="loadReports('@auser.Id')">📊</a>
                                        }
                                    </div>

                                    <div class="node-title">@auser.Name</div>
                                </div>
                            }
                        </div>
                    }
                </div>
            }

            @foreach (var manager in managers)
            {
                <div class="tree-manager">

                    <!-- MANAGER NODE -->
                    <div class="org-box manager org-node"
                         data-id="@manager.Id"
                         data-role="Manager"
                         draggable="true"
                         ondragstart="drag(event)"
                         ondragover="allowDrop(event)"
                         ondrop="drop(event,'@manager.Id')">




                        @* ACTION ICONS: allow Admin and Manager to edit (delete Admin-only); reports available to both *@
                        <div class="node-actions-top above-name">
                            @if (currentRole == "Admin" || currentRole == "Manager")
                            {
                                <a onclick="openEditModal('@manager.Id','@manager.Name','@manager.Email','Manager')">✏️</a>
                            }
                            @if (currentRole == "Admin")
                            {
                                <a onclick="openDeleteModal('@manager.Id','@manager.Name','Manager')">🗑</a>
                            }

                            @if (currentRole == "Admin" || currentRole == "Manager")
                            {
                                <a href="javascript:void(0)"
                                   onclick="loadReports('@manager.Id')">📊</a>
                            }

                        </div>

                        <div class="manager-header">
                            <div>
                                <div class="node-title">@manager.Name</div>
                                <div class="role">Manager</div>
                            </div>

                            @* ADD USER button visible only to Admin *@
                            @if (currentRole == "Admin")
                            {
                                <a class="org-plus"
                                   onclick="openAddModal('User','@manager.Id')">+</a>
                            }
                        </div>
                    </div>

                    <!-- 🔽 CHILDREN -->
                    <div class="tree-users">

                        <!-- 👤 USERS (show users first under manager) -->       
                        @if (subManagerUsers.ContainsKey(manager.Id))
                        {
                            foreach (var user in subManagerUsers[manager.Id])
                            {
                                <div class="org-box user org-node xsmall"
                                     data-id="@user.Id"
                                     data-parent-id="@manager.Id"
                                     data-role="User"
                                     draggable="true"
                                     @* onmousedown="prepareDrag(event)" *@
                                     ondragstart="drag(event)">



                                    <!-- NODE ACTIONS: Admin + Manager can edit; delete still Admin only -->
                                    <div class="node-actions-top above-name">
                                        @if (currentRole == "Admin" || currentRole == "Manager")
                                        {
                                            <a onclick="openEditModal('@user.Id','@user.Name','@user.Email','User')">✏️</a>
                                        }

                                        @if (currentRole == "Admin")
                                        {
                                            <a onclick="openDeleteModal('@user.Id','@user.Name','User')">🗑</a>
                                        }

                                        @if (currentRole == "Admin" || currentRole == "Manager")
                                        {
                                            <a href="javascript:void(0)"
                                               onclick="loadReports('@user.Id')">📊</a>
                                        }
                                    </div>

                                    <div class="node-title">@user.Name</div>                    
                                </div>

                            }
                        }

                        <!-- 🔁 SUB-MANAGERS (render after users) -->
                        @if (manager != null && subManagers.ContainsKey(manager.Id))
                        {
                            foreach (var sub in subManagers[manager.Id])
                            {
                                if (sub != null)
                                {
                                    @await Html.PartialAsync("_TreeNode", sub)
                                }
                            }
                        }

                    </div>
                </div>
            }
            


        </div>

        <!-- ================= CENTER PANEL : DETAILS ================= -->
        <div class="org-right-panel">
            <h4 class="mb-2">Selected Details</h4>

            <div id="detailsPanel" class="p-2">
                Click a user or manager
            </div>

        </div>

    </div>

    <!-- ================= ADD / EDIT / DELETE MODALS and scripts left unchanged; 
         NOTE: removed duplicate inline drag/drop function definitions (orgchart.js is the single source) -->
</div>
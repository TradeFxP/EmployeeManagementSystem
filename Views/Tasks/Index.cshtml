@using UserRoles.ViewModels
@using UserRoles.Models
@inject Microsoft.AspNetCore.Identity.UserManager<Users> UserManager

@model UserRoles.ViewModels.TeamBoardViewModel

@{
    ViewData["Title"] = "Tasks";
    var userTeams = ViewBag.UserTeams as List<string> ?? new List<string>();
    var isAdmin = User.IsInRole("Admin");
    var isManager = User.IsInRole("Manager");
    var isSubManager = User.IsInRole("Sub-Manager") || User.IsInRole("SubManager");
    var canAssign = isAdmin || isManager || isSubManager;
}

<style>
    .modal-action-buttons {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid #f0f0f0;
    }

    .modal-action-btn {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 1.4rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .modal-action-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    }

    .modal-action-btn:active {
        transform: translateY(-1px);
    }

    .btn-modal-history {
        background-color: #eef2ff;
        color: #4f46e5;
    }

    .btn-modal-assign {
        background-color: #f3f4f6;
        color: #4b5563;
    }

    .btn-modal-edit {
        background-color: #fff7ed;
        color: #ea580c;
    }

    .modal-action-btn-sm {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 1.1rem;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .modal-action-btn-sm:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    /* Nested Dropdown Styling */
    .nested-dropdown-group {
        border: 1px solid #e2e8f0;
        padding: 6px 14px;
        background: #f8fafc;
        border-radius: 12px;
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
    }
    
    .nested-dropdown-group:focus-within {
        border-color: #6366f1 !important;
        background: #ffffff !important;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.12) !important;
    }
    
    .nested-dropdown-group select {
        border: none !important;
        background: transparent !important;
        padding-right: 25px !important;
        box-shadow: none !important;
        font-size: 1rem;
        color: #1e293b;
        cursor: pointer;
        min-width: 140px;
        width: auto;
        max-width: none;
        flex: 1 1 auto;
        white-space: nowrap;
    }

    .nested-dropdown-group select:disabled {
        cursor: not-allowed;
        opacity: 0.4;
    }

    .field-group {
        transition: all 0.2s ease;
        padding: 8px;
        border-radius: 8px;
    }
    
    .field-group:hover {
        background: #f8fafc;
    }

    .edit-options-list {
        max-height: 250px;
        overflow-y: auto;
        padding: 8px;
        background: #fdfdfd;
        border: 1px dashed #cbd5e1;
        border-radius: 8px;
        margin-bottom: 10px;
    }

    .btn-xs {
        padding: 0.2rem 0.5rem;
        font-size: 0.7rem;
        border-radius: 4px;
        line-height: 1;
    }

    .parent-group-container {
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        background: #ffffff;
        transition: all 0.2s ease;
    }

    .parent-group-container:hover {
        border-color: #6366f1;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.08);
    }

    .child-option-row input:focus {
        background: #fff !important;
        border-color: #6366f1 !important;
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1) !important;
    }

    .standalone-option-row:hover {
        transform: translateX(4px);
    }

    .edit-options-list::-webkit-scrollbar {
        width: 6px;
    }
    .edit-options-list::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 10px;
    }
    .edit-options-list::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
    }
</style>

<!-- MOBILE SIDEBAR OVERLAY -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<div class="app-wrapper">

    <!-- LEFT SIDEBAR -->
    <aside class="left-sidebar" id="leftSidebar">

        <h5>Boards</h5>

        <div class="list-group list-group-flush">

            <!-- ================= PROJECT SECTION (All Users) ================= -->
            <button type="button"
                class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                onclick="toggleProjectPanel()">
                <span>
                    <i class="bi bi-folder2 me-2"></i> Project
                </span>
                <span id="projectArrow">▼</span>
            </button>

            <div id="projectDropdown" style="display:none;">
                <div id="projectList"></div>
                @if (isAdmin)
                {
                    <button type="button" class="list-group-item list-group-item-action ps-4"
                        onclick="openCreateProjectModal()">
                        <i class="bi bi-plus-lg me-2"></i> New Project
                    </button>
                }
            </div>

            @if (isAdmin)
            {
                <!-- ================= EMPLOYEES SECTION ================= -->
                <button type="button"
                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                    onclick="loadEmployeesAdminPanel()">
                    <span>
                        <i class="bi bi-person-badge-fill me-2"></i> Employees
                    </span>
                </button>

                <!-- ================= TEAM TASKS ================= -->
                <button type="button"
                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                    onclick="toggleTeamTasks()">
                    <span>
                        <i class="bi bi-people-fill me-2"></i> Team Tasks
                    </span>
                    <span id="teamArrow">▲</span>
                </button>

                <div id="teamTasksDropdown" style="display:block;">
                    <div id="adminTeamList"></div>
                    <!-- The team list is loaded dynamically, we'll need to handle it in JS or just let it be -->

                    <div class="mt-2 pt-2 px-3" style="border-top: 1px solid rgba(255,255,255,0.08);">
                        <div id="addTeamInputContainer" style="display:none;" class="mb-2">
                            <input type="text" id="newTeamNameInput"
                                class="form-control form-control-sm bg-dark text-white border-secondary"
                                placeholder="Enter team name..." />
                            <div class="d-flex justify-content-end mt-1 gap-1">
                                <button class="btn btn-xs btn-secondary" onclick="toggleAddTeamInput()">Cancel</button>
                                <button class="btn btn-xs btn-primary" onclick="submitCreateTeam()">Add</button>
                            </div>
                        </div>

                        <button type="button" class="btn btn-sm w-100 text-start"
                            style="color: rgba(255,255,255,0.5); border: 1px dashed rgba(255,255,255,0.15);"
                            onclick="toggleAddTeamInput()">
                            <i class="bi bi-plus-circle me-2"></i> Add Team
                        </button>
                    </div>
                </div>
            }
            else
            {
                <!-- ================= USER/MANAGER: MY TEAM ================= -->
                <button type="button"
                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                    onclick="toggleMyTasks()">
                    <span>
                        <i class="bi bi-kanban-fill me-2"></i> My Team
                    </span>
                    <span id="myTasksArrow">▼</span>
                </button>

                <div id="myTasksDropdown" style="display:none;">
                        @if (userTeams.Any())
                        {
                            @foreach (var team in userTeams)
                            {
                                var icon = "bi-people";
                                var teamSafeId = "team_" + team.Replace(" ", "_");
                                
                                <div class="team-sidebar-item">
                                    <button type="button" class="list-group-item list-group-item-action ps-4 team-btn d-flex align-items-center" 
                                            data-team="@team"
                                            onclick="loadTeamBoard('@team')"
                                            @(canAssign ? $"ondblclick=toggleTeamItem('{teamSafeId}')" : "")
                                            title="@(canAssign ? "Single-click: Board | Double-click: Toggle Assign" : "Click to view board")">
                                        <i class="bi @icon me-2"></i> @team Team
                                    </button>
                                    
                                    @if (canAssign)
                                    {
                                        <div id="@teamSafeId" style="display:none;">
                                            <button type="button" class="list-group-item list-group-item-action ps-5 py-2 border-0 text-info bg-dark" 
                                                    onclick="loadAssignedTasksOverview('@team')">
                                                <i class="bi bi-person-check me-2"></i> Assign Task
                                            </button>
                                        </div>
                                    }
                                </div>
                            }
                        }
                    else
                    {
                        <div class="text-muted ps-4 py-2" style="font-size: 0.825rem;">
                            No teams assigned
                        </div>
                    }
                </div>
            }

        </div>
    </aside>

    <!-- RIGHT CONTENT AREA -->
    <div class="right-content">
        <div id="taskBoardContainer"></div>
    </div>


    <!-- ═══════ IMAGE LIGHTBOX MODAL ═══════ -->
    <div class="modal fade" id="lightboxModal" tabindex="-1" style="background: rgba(0,0,0,0.85); z-index: 1080;" data-bs-backdrop="false">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content" style="background: transparent; border: none; box-shadow: none;">
                <div class="modal-header border-0 p-0 position-absolute" style="top: -40px; right: 0; z-index: 1060;">
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0 text-center">
                    <img id="lightboxImage" src="" style="max-width: 100%; max-height: 85vh; object-fit: contain; border-radius: 8px; box-shadow: 0 0 40px rgba(0,0,0,0.5);" />
                    <div class="mt-3">
                        <a id="lightboxDownload" href="" download="image.jpg" class="btn btn-outline-light btn-sm">
                            <i class="bi bi-download me-1"></i> Download
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════ JS: EXPOSE USER ROLE ═══════ -->
    <script>
        var currentUserRole = '@(User.IsInRole("Admin") ? "Admin" : User.IsInRole("Manager") ? "Manager" : User.IsInRole("Sub-Manager") ? "Sub-Manager" : "User")';
        var isAdmin = @(User.IsInRole("Admin") ? "true" : "false");
        var isManager = @((User.IsInRole("Manager") || User.IsInRole("Sub-Manager")) ? "true" : "false");
        window.isAdmin = isAdmin;
        window.isManager = isManager;
    </script>

    <!-- ═══════ REVIEW TASK MODAL (ADMIN ONLY) ═══════ -->
    <div class="modal fade" id="reviewTaskModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 16px 16px 0 0;">
                    <h5 class="modal-title text-white">
                        <i class="bi bi-clipboard-check me-2"></i>Review Task
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <input type="hidden" id="reviewTaskId" />

                    <div class="mb-3">
                        <label class="form-label fw-bold">Task</label>
                        <div id="reviewTaskTitle" class="form-control-plaintext fs-5 fw-semibold"></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Decision</label>
                        <div class="d-flex gap-3">
                            <div class="form-check form-check-inline flex-fill">
                                <input class="form-check-input" type="radio" name="reviewDecision" id="reviewPass"
                                    value="pass" checked>
                                <label class="form-check-label w-100 text-center py-2 rounded border review-radio-pass"
                                    for="reviewPass">
                                    <i class="bi bi-check-circle-fill text-success me-1"></i> Pass
                                </label>
                            </div>
                            <div class="form-check form-check-inline flex-fill">
                                <input class="form-check-input" type="radio" name="reviewDecision" id="reviewFail"
                                    value="fail">
                                <label class="form-check-label w-100 text-center py-2 rounded border review-radio-fail"
                                    for="reviewFail">
                                    <i class="bi bi-x-circle-fill text-danger me-1"></i> Fail
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Review Note <span class="text-muted fw-normal">(required for
                                fail)</span></label>
                        <textarea id="reviewNote" class="form-control" rows="3"
                            placeholder="Add your review comments..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0 px-4 pb-4">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary px-4" id="submitReviewBtn" onclick="submitReview()">
                        <i class="bi bi-send me-1"></i> Submit Review
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════ ARCHIVED TASK DETAIL MODAL ═══════ -->
    <div class="modal fade" id="archivedTaskModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, #1a1a2e, #16213e); border-radius: 16px 16px 0 0;">
                    <h5 class="modal-title text-white">
                        <i class="bi bi-archive me-2"></i>Archived Task Overview
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4" id="archivedTaskBody">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════ TASK OVERVIEW MODAL ═══════ -->
    <div class="modal fade" id="taskOverviewModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
                <div class="modal-header d-flex align-items-center"
                    style="background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 16px 16px 0 0;">
                    <h5 class="modal-title text-white mb-0">
                        <i class="bi bi-card-text me-2"></i>Task Overview
                    </h5>
                    <div id="taskOverviewActions" class="ms-auto d-flex gap-2 me-3"></div>
                    <button type="button" class="btn-close btn-close-white ms-0" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4" id="taskOverviewBody">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addColumnModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Add Column</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" id="addColumnTeam" />

                    <div class="mb-3">
                        <label class="form-label">Column Name</label>
                        <input type="text" id="newColumnName" class="form-control" placeholder="e.g. QA Review"
                            required />
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" id="addColumnSubmit">Add</button>
                </div>

            </div>
        </div>
    </div>


    <div class="modal fade" id="createTaskModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-0 pb-0" style="background: linear-gradient(135deg, #6366f1, #4f46e5); color: #fff;">
                    <h5 class="modal-title fw-bold"><i class="bi bi-plus-circle me-2"></i>Create Task</h5>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" id="taskColumnId" />

                    <div class="mb-3" id="groupCreateTaskTitle">
                        <label class="form-label mb-1" id="labelCreateTaskTitle">Title</label>
                        <input type="text" id="taskTitle" class="form-control" placeholder="Enter task title..." required />
                    </div>

                    <div class="mb-3" id="groupCreateTaskDescription">
                        <label class="form-label mb-1" id="labelCreateTaskDescription">Description</label>
                        <textarea id="taskDescription" class="form-control" rows="3" placeholder="Add a description..."></textarea>
                    </div>

                    <div class="mb-3" id="groupCreateTaskPriority">
                        <label class="form-label mb-1" id="labelCreateTaskPriority">Priority</label>
                        <select id="taskPriority" class="form-select">
                            <option value="0">🟢 Low</option>
                            <option value="1" selected>🟡 Medium</option>
                            <option value="2">🟠 High</option>
                            <option value="3">🔴 Critical</option>
                        </select>
                    </div>

                    <div class="mb-3" id="groupCreateTaskDueDate">
                        <label class="form-label mb-1" id="labelCreateTaskDueDate">Due Date & Time</label>
                        <input type="datetime-local" id="taskDueDate" class="form-control" />
                    </div>

                    @* <div class="mb-3">
                    <label class="form-label">Link to Project (optional - for auto ID)</label>
                    <select id="taskProjectId" class="form-select">
                    <option value="">-- No Project --</option>
                    <!-- Dynamically loaded -->
                    </select>
                    <small class="text-muted">Selecting a project generates an ID like P1T1, P1T2...</small>
                    </div>*@

                    <!-- Custom Fields Container -->
                    <div id="customFieldsContainer"></div>
                </div>

                <div class="modal-footer bg-light border-0 py-3">
                    @if (User.IsInRole("Admin") || User.IsInRole("Manager") || User.IsInRole("SubManager") || User.IsInRole("User"))
                    {
                        <div class="me-auto d-flex gap-2">
                            <button class="btn btn-sm btn-outline-secondary px-3 fw-bold" style="border-radius: 8px;"
                                onclick="openManageFieldsModal(); event.preventDefault();">
                                <i class="bi bi-gear me-1"></i> Manage Fields
                            </button>
                            <button class="btn btn-sm btn-outline-primary px-3 fw-bold" style="border-radius: 8px;"
                                onclick="addNewCustomField(); event.preventDefault();">
                                <i class="bi bi-plus-lg me-1"></i> Add Field
                            </button> 
                        </div>
                    }
                    <button class="btn btn-secondary px-4 fw-bold" style="border-radius: 8px;" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary px-4 fw-bold shadow-sm" style="border-radius: 8px;" onclick="submitCreateTask()">Create</button>
                </div>

            </div>
        </div>
    </div>

    <!-- EDIT TASK MODAL -->
    <div class="modal fade" id="editTaskModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-0 pb-0" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: #fff;">
                    <h5 class="modal-title fw-bold"><i class="bi bi-pencil-square me-2"></i>Edit Task</h5>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" id="editTaskId" />

                    <div class="mb-3" id="groupEditTaskTitle">
                        <label class="form-label mb-1" id="labelEditTaskTitle">Title</label>
                        <input type="text" id="editTaskTitle" class="form-control" required />
                    </div>

                    <div class="mb-3" id="groupEditTaskDescription">
                        <label class="form-label mb-1" id="labelEditTaskDescription">Description</label>
                        <textarea id="editTaskDescription" class="form-control" rows="4"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3" id="groupEditTaskPriority">
                            <label class="form-label mb-1" id="labelEditTaskPriority">Priority</label>
                            <select id="editTaskPriority" class="form-select">
                                <option value="0">🟢 Low</option>
                                <option value="1">🟡 Medium</option>
                                <option value="2">High</option>
                                <option value="3">🔴 Critical</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3" id="groupEditTaskDueDate">
                            <label class="form-label mb-1" id="labelEditTaskDueDate">Due Date & Time</label>
                            <input type="datetime-local" id="editTaskDueDate" class="form-control" />
                        </div>
                        <div class="col-md-6 mb-3" id="groupEditTaskAssignTo">
                             <div class="d-flex justify-content-between align-items-center mb-1">
                                <label class="form-label mb-0" id="labelEditTaskAssignTo">Assign To</label>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-link text-secondary p-0 me-2" title="Rename Assign To" onclick="renameField('labelEditTaskAssignTo')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button type="button" class="btn btn-link text-danger p-0" title="Delete Assign To" onclick="hideField('groupEditTaskAssignTo')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                            </div>
                            <select id="editTaskAssignedTo" class="form-select">
                                <option value="">-- Unassigned --</option>
                                @if (Model != null && Model.AssignableUsers != null)
                                {
                                    var isViewerSubManager = User.IsInRole("Sub-Manager") || User.IsInRole("SubManager");
                                    var isViewerManager = User.IsInRole("Manager");
                                    var isViewerAdmin = User.IsInRole("Admin");

                                    var filteredManagement = Model.AssignableUsers.Where(u => {
                                        if (!Model.UserRolesMap.ContainsKey(u.Id)) return false;
                                        var r = Model.UserRolesMap[u.Id];
                                        var isTargetAdmin = r == "Admin";
                                        var isTargetManager = r == "Manager";
                                        var isTargetSubManager = r == "Sub-Manager" || r == "SubManager";

                                        if (!isTargetAdmin && !isTargetManager && !isTargetSubManager) return false;

                                        if (isViewerSubManager) return isTargetSubManager;
                                        if (isViewerManager) return isTargetManager || isTargetSubManager;
                                        return true;
                                    }).ToList();

                                    var filteredRegular = Model.AssignableUsers.Where(u => {
                                        if (Model.UserRolesMap.ContainsKey(u.Id)) {
                                            var r = Model.UserRolesMap[u.Id];
                                            if (r == "Admin" || r == "Manager" || r == "Sub-Manager" || r == "SubManager") return false;
                                        }
                                        return true;
                                    }).ToList();

                                    @if (filteredManagement.Any())
                                    {
                                        <optgroup label="Management">
                                            @foreach (var u in filteredManagement)
                                            {
                                                var role = Model.UserRolesMap.ContainsKey(u.Id) ? Model.UserRolesMap[u.Id] : "User";
                                                <option value="@u.Id">[@role] @(string.IsNullOrEmpty(u.Name) ? u.UserName : u.Name)</option>
                                            }
                                        </optgroup>
                                    }

                                    @if (filteredRegular.Any())
                                    {
                                        <optgroup label="Team Members">
                                            @foreach (var u in filteredRegular)
                                            {
                                                var role = Model.UserRolesMap.ContainsKey(u.Id) ? Model.UserRolesMap[u.Id] : "User";
                                                <option value="@u.Id">[@role] @(string.IsNullOrEmpty(u.Name) ? u.UserName : u.Name)</option>
                                            }
                                        </optgroup>
                                    }
                                }
                            </select>
                        </div>
                         @*
                        <div class="col-md-6 mb-3" id="groupEditTaskMoveTo">
                           <label class="form-label mb-1" id="labelEditTaskMoveTo">Move To Column</label>
                            <select id="editTaskMoveTo" class="form-select" onchange="moveTaskFromEditModal()">
                                <!-- Dynamically populated -->
                            </select>
                        </div>*@
                    </div>

                    <!-- Custom Fields Container -->
                    <div id="editCustomFieldsContainer"></div>
                </div>

                <div class="modal-footer bg-light border-0 py-3">
                    @if (User.IsInRole("Admin") || User.IsInRole("Manager") || User.IsInRole("SubManager") || User.IsInRole("User"))
                    {
                        <div class="me-auto d-flex gap-2">
                            <button class="btn btn-sm btn-outline-secondary px-3 fw-bold" style="border-radius: 8px;"
                                onclick="openManageFieldsModal(); event.preventDefault();">
                                <i class="bi bi-gear me-1"></i> Manage Fields
                            </button>
                            <button class="btn btn-sm btn-outline-primary px-3 fw-bold" style="border-radius: 8px;"
                                onclick="addNewCustomField(); event.preventDefault();">
                                <i class="bi bi-plus-lg me-1"></i> Add Field
                            </button> 
                        </div>
                    }
                    <button class="btn btn-secondary px-4 fw-bold" style="border-radius: 8px;" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary px-4 fw-bold shadow-sm" style="border-radius: 8px;" onclick="submitEditTask()">Save Changes</button>
                </div>

            </div>
        </div>
    </div>


    <div class="modal fade" id="assignTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Assign Task</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" id="assignTaskId" />

                    <label class="form-label">Assign to</label>
                    <select id="assignUserSelect" class="form-select">
                        <option value="">-- Select User --</option>
                        @if (Model != null && Model.AssignableUsers != null && Model.AssignableUsers.Any())
                        {
                            var isViewerSubManager = User.IsInRole("Sub-Manager") || User.IsInRole("SubManager");
                            var isViewerManager = User.IsInRole("Manager");
                            var isViewerAdmin = User.IsInRole("Admin");

                            var filteredManagement = Model.AssignableUsers.Where(u => {
                                if (!Model.UserRolesMap.ContainsKey(u.Id)) return false;
                                var r = Model.UserRolesMap[u.Id];
                                var isTargetAdmin = r == "Admin";
                                var isTargetManager = r == "Manager";
                                var isTargetSubManager = r == "Sub-Manager" || r == "SubManager";

                                if (!isTargetAdmin && !isTargetManager && !isTargetSubManager) return false;

                                if (isViewerSubManager) return isTargetSubManager;
                                if (isViewerManager) return isTargetManager || isTargetSubManager;
                                return true;
                            }).ToList();

                            var filteredRegular = Model.AssignableUsers.Where(u => {
                                if (Model.UserRolesMap.ContainsKey(u.Id)) {
                                    var r = Model.UserRolesMap[u.Id];
                                    if (r == "Admin" || r == "Manager" || r == "Sub-Manager" || r == "SubManager") return false;
                                }
                                return true;
                            }).ToList();

                            @if (filteredManagement.Any())
                            {
                                <optgroup label="Management">
                                    @foreach (var u in filteredManagement)
                                    {
                                        var role = Model.UserRolesMap.ContainsKey(u.Id) ? Model.UserRolesMap[u.Id] : "User";
                                        <option value="@u.Id">[@role] @(string.IsNullOrEmpty(u.Name) ? u.UserName : u.Name)</option>
                                    }
                                </optgroup>
                            }

                            @if (filteredRegular.Any())
                            {
                                <optgroup label="Team Members">
                                    @foreach (var u in filteredRegular)
                                    {
                                        var role = Model.UserRolesMap.ContainsKey(u.Id) ? Model.UserRolesMap[u.Id] : "User";
                                        <option value="@u.Id">[@role] @(string.IsNullOrEmpty(u.Name) ? u.UserName : u.Name)</option>
                                    }
                                </optgroup>
                            }
                        }
                        else
                        {
                            <option disabled>No users available</option>
                        }
                    </select>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button class="btn btn-primary" onclick="assignTask()">
                        Assign
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- CREATE PROJECT MODAL -->
    <div class="modal fade" id="createProjectModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-folder-plus me-2"></i>Create Project</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Project Name</label>
                        <input type="text" id="newProjectName" class="form-control" placeholder="Enter project name" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description (optional)</label>
                        <textarea id="newProjectDescription" class="form-control" rows="3"
                            placeholder="Project description"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" onclick="submitCreateProject()">Create Project</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MANAGE CUSTOM FIELDS MODAL (Admin Only) -->
    <div class="modal fade" id="manageFieldsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-0 pb-0" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: #fff;">
                    <h5 class="modal-title fw-bold"><i class="bi bi-sliders me-2"></i>Manage Custom Fields</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- SYSTEM FIELDS VISIBILITY -->
                    <div class="card mb-3 border-info shadow-sm">
                        <div class="card-header bg-info text-white py-2">
                            <i class="bi bi-toggle-on me-1"></i> System Fields Visibility
                        </div>
                        <div class="card-body py-2">
                            <div class="row row-cols-1 row-cols-md-2 g-2">
                                <div class="col">
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" id="showOtherCheckbox" onchange="updateTeamSettings()">
                                        <label class="form-check-label fw-bold" for="showOtherCheckbox">Show Other</label>
                                    </div>
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" id="showTitleCheckbox" @(Model?.TeamSettings?.IsTitleVisible ?? true ? "checked" : "") onchange="updateTeamSettings()">
                                        <label class="form-check-label" for="showTitleCheckbox">Show Title Field</label>
                                    </div>
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" id="showDescriptionCheckbox" @(Model?.TeamSettings?.IsDescriptionVisible ?? true ? "checked" : "") onchange="updateTeamSettings()">
                                        <label class="form-check-label" for="showDescriptionCheckbox">Show Description Field</label>
                                    </div>
                                </div>
                                <div class="col text-md-end text-start">
                                    <div class="form-check form-switch mb-2 d-md-inline-block">
                                        <input class="form-check-input" type="checkbox" id="showPriorityCheckbox" @(Model?.TeamSettings?.IsPriorityVisible ?? true ? "checked" : "") onchange="updateTeamSettings()">
                                        <label class="form-check-label me-md-5" for="showPriorityCheckbox">Show Priority</label>
                                    </div>
                                    <br class="d-none d-md-block" />
                                    <div class="form-check form-switch mb-2 d-md-inline-block">
                                        <input class="form-check-input" type="checkbox" id="showDueDateCheckbox" @(Model?.TeamSettings?.IsDueDateVisible ?? true ? "checked" : "") onchange="updateTeamSettings()">
                                        <label class="form-check-label me-md-5" for="showDueDateCheckbox">Show Due Date</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Existing Fields List -->
                    <h6 class="mb-3">Existing Fields</h6>
                    <div id="fieldsList" class="mb-4">
                        <!-- Dynamically loaded fields -->
                    </div>

                    <!-- Unified Add New Field Form -->
                    <div class="border-top pt-3 mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0 text-dark fw-bold" style="font-size: 0.9rem;">Add New Activity Field</h6>
                            <span class="text-muted" style="font-size: 10px;">Quick Configuration</span>
                        </div>
                        <div class="row g-2 align-items-end mb-2">
                            <div class="col-md-5">
                                <label class="x-small fw-bold text-muted mb-1 text-uppercase" style="font-size: 9px; letter-spacing: 0.5px;">Label Name</label>
                                <input type="text" id="newFieldName" class="form-control form-control-sm border-secondary-subtle"
                                    placeholder="e.g., Estimated Hours" style="font-size: 0.8rem; height: 36px; padding: 0.4rem 0.8rem;" />
                            </div>
                            <div class="col-md-4">
                                <label class="x-small fw-bold text-muted mb-1 text-uppercase" style="font-size: 9px; letter-spacing: 0.5px;">Input Type</label>
                                <select id="newFieldType" class="form-select form-select-sm border-secondary-subtle" style="font-size: 0.8rem; height: 36px; padding: 0.4rem 0.8rem;" onchange="toggleNewOptionsSection()">
                                    <option value="Text">🔤 Text</option>
                                    <option value="Number">🔢 Number</option>
                                    <option value="Date">📅 Date</option>
                                    <option value="Time">🕐 Time</option>
                                    <option value="DateTime">🗓️ Date & Time</option>
                                    <option value="Dropdown">▼ Dropdown</option>
                                    <option value="List">📋 List (Columns)</option>
                                    <option value="Image">🖼️ Image</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <div class="d-flex align-items-center gap-2">
                                    <div class="form-check form-switch mb-0">
                                        <input class="form-check-input" style="transform: scale(0.75);" type="checkbox" id="newFieldRequired" />
                                        <label class="form-check-label" style="font-size: 0.75rem; color: #64748b;" for="newFieldRequired">Req</label>
                                    </div>
                                    <button class="btn btn-primary btn-sm flex-grow-1" style="height: 36px; font-size: 0.85rem; font-weight: 600; border-radius: 8px;" onclick="createNewField()">
                                        <i class="bi bi-plus-lg me-1"></i> Add
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Dropdown Options (Compact inline row) -->
                        <div id="newFieldOptionsSection" class="mt-2 p-2 bg-light border rounded d-none">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <label class="x-small fw-bold text-muted text-uppercase" style="font-size: 9px;">Configure Options</label>
                                <div class="d-flex gap-1">
                                    <button type="button" class="btn btn-xs btn-outline-primary" style="font-size: 9px; padding: 1px 6px;" onclick="addParentGroup('', 'newFieldOptionsList')">+ Group</button>
                                    <button type="button" class="btn btn-xs btn-outline-secondary" style="font-size: 9px; padding: 1px 6px;" onclick="addStandaloneOption('', 'newFieldOptionsList')">+ Opt</button>
                                </div>
                            </div>
                            <div id="newFieldOptionsList" class="p-1 bg-white border rounded" style="max-height: 120px; overflow-y: auto;">
                                <!-- Dynamic options -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════ EXCEL IMPORT MODAL ═══════ -->
    <div class="modal fade" id="excelImportModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
                <div class="modal-header border-0 pb-0" style="background: linear-gradient(135deg, #0d9488, #0891b2); border-radius: 16px 16px 0 0;">
                    <h5 class="modal-title text-white fw-bold">
                        <i class="bi bi-file-earmark-spreadsheet me-2"></i>Import Tasks from Excel
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" onclick="resetExcelImport()"></button>
                </div>
                <div class="modal-body p-0">
                    <!-- Tab Navigation -->
                    <ul class="nav nav-tabs px-4 pt-3" id="importTabs">
                        <li class="nav-item">
                            <button class="nav-link active" data-tab="upload" onclick="switchImportTab('upload')">
                                <i class="bi bi-cloud-arrow-up me-1"></i> Upload
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-tab="history" onclick="switchImportTab('history')">
                                <i class="bi bi-clock-history me-1"></i> Import History
                            </button>
                        </li>
                    </ul>

                    <!-- UPLOAD TAB -->
                    <div id="importTab-upload" class="import-tab-content p-4">
                        <input type="hidden" id="importTeamName" />

                        <!-- Step 1: Upload Zone -->
                        <div id="excelUploadStep">
                            <div id="excelDropZone" class="excel-drop-zone"
                                 ondrop="handleExcelDrop(event)"
                                 ondragover="handleExcelDragOver(event)"
                                 ondragleave="handleExcelDragLeave(event)">
                                <div class="drop-zone-content">
                                    <i class="bi bi-cloud-arrow-up-fill drop-zone-icon"></i>
                                    <h5>Drag & Drop Excel File Here</h5>
                                    <p class="text-muted mb-3">or click to browse — supports .xlsx files</p>
                                    <label class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-folder2-open me-1"></i> Browse Files
                                        <input type="file" id="excelFileInput" accept=".xlsx,.xls"
                                               style="display:none;" onchange="handleExcelFileSelect(this)" />
                                    </label>
                                </div>
                            </div>
                            <div id="excelFileInfo" class="file-info-bar d-none">
                                <div class="d-flex align-items-center gap-2">
                                    <i class="bi bi-file-earmark-excel-fill text-success fs-4"></i>
                                    <div>
                                        <div class="fw-bold" id="excelFileName"></div>
                                        <small class="text-muted" id="excelFileSize"></small>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-outline-danger" onclick="clearExcelFile()">
                                    <i class="bi bi-x-lg"></i> Remove
                                </button>
                            </div>
                        </div>

                        <!-- Step 2: Preview -->
                        <div id="excelPreviewStep" class="d-none">
                            <div class="preview-stats d-flex gap-3 mb-3">
                                <div class="stat-card">
                                    <i class="bi bi-table text-primary"></i>
                                    <div>
                                        <div class="stat-value" id="previewTotalRows">0</div>
                                        <small class="text-muted">Total Rows</small>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <i class="bi bi-columns-gap text-info"></i>
                                    <div>
                                        <div class="stat-value" id="previewTotalCols">0</div>
                                        <small class="text-muted">Columns</small>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <i class="bi bi-check-circle text-success"></i>
                                    <div>
                                        <div class="stat-value">Ready</div>
                                        <small class="text-muted">Status</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Column Mapping -->
                            <div class="mapping-section mb-3">
                                <h6 class="fw-bold mb-2"><i class="bi bi-signpost-2 me-1"></i> Column Mapping</h6>
                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <label class="form-label small fw-bold">Title Column</label>
                                        <select id="mappingTitleCol" class="form-select form-select-sm">
                                            <option value="-1">Auto (first column)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label small fw-bold">Description Column</label>
                                        <select id="mappingDescCol" class="form-select form-select-sm">
                                            <option value="-1">None</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label small fw-bold">Target Board Column</label>
                                        <select id="importTargetColumn" class="form-select form-select-sm">
                                        </select>
                                    </div>
                                </div>
                                <small class="text-muted mt-1 d-block">
                                    <i class="bi bi-info-circle me-1"></i>
                                    All other Excel columns will be created as custom fields on the board automatically.
                                </small>
                            </div>

                            <!-- Preview Table -->
                            <div class="preview-table-wrapper">
                                <h6 class="fw-bold mb-2"><i class="bi bi-eye me-1"></i> Data Preview (first 5 rows)</h6>
                                <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                                    <table class="table table-sm table-bordered table-hover mb-0" id="previewTable">
                                        <thead id="previewTableHead" class="table-dark"></thead>
                                        <tbody id="previewTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Progress -->
                        <div id="excelProgressStep" class="d-none">
                            <div class="text-center py-4">
                                <div class="import-progress-circle mb-3">
                                    <i class="bi bi-gear-fill spinning-icon"></i>
                                </div>
                                <h5 class="fw-bold" id="importProgressTitle">Importing Tasks...</h5>
                                <p class="text-muted" id="importProgressSubtitle">Please wait while we process your Excel file</p>
                                <div class="progress mt-3" style="height: 8px; border-radius: 4px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" id="importProgressBar"
                                         role="progressbar" style="width: 0%; background: linear-gradient(135deg, #0d9488, #0891b2);"></div>
                                </div>
                                <small class="text-muted mt-2 d-block" id="importProgressText">Starting...</small>
                            </div>
                        </div>

                        <!-- Step 4: Results -->
                        <div id="excelResultStep" class="d-none">
                            <div class="text-center py-3">
                                <div id="resultIconSuccess" class="d-none">
                                    <div class="result-icon result-success"><i class="bi bi-check-circle-fill"></i></div>
                                    <h4 class="fw-bold text-success mt-2">Import Successful!</h4>
                                </div>
                                <div id="resultIconPartial" class="d-none">
                                    <div class="result-icon result-warning"><i class="bi bi-exclamation-triangle-fill"></i></div>
                                    <h4 class="fw-bold text-warning mt-2">Import Completed with Errors</h4>
                                </div>
                                <div id="resultIconFail" class="d-none">
                                    <div class="result-icon result-danger"><i class="bi bi-x-circle-fill"></i></div>
                                    <h4 class="fw-bold text-danger mt-2">Import Failed</h4>
                                </div>

                                <div class="result-stats d-flex justify-content-center gap-4 mt-3 mb-3">
                                    <div class="text-center">
                                        <div class="fs-3 fw-bold text-success" id="resultSuccessCount">0</div>
                                        <small class="text-muted">Imported</small>
                                    </div>
                                    <div class="text-center">
                                        <div class="fs-3 fw-bold text-danger" id="resultErrorCount">0</div>
                                        <small class="text-muted">Errors</small>
                                    </div>
                                    <div class="text-center">
                                        <div class="fs-3 fw-bold text-info" id="resultDuration">0s</div>
                                        <small class="text-muted">Duration</small>
                                    </div>
                                </div>

                                <p class="text-muted" id="resultMessage"></p>

                                <div id="resultErrors" class="d-none mt-3">
                                    <h6 class="fw-bold text-danger"><i class="bi bi-bug me-1"></i> Error Details</h6>
                                    <div class="bg-light border rounded p-2 text-start small" id="resultErrorList"
                                         style="max-height: 120px; overflow-y: auto;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- HISTORY TAB -->
                    <div id="importTab-history" class="import-tab-content p-4 d-none">
                        <div id="importHistoryContent">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="text-muted mt-2">Loading import history...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer border-0 px-4 pb-4">
                    <button class="btn btn-secondary" data-bs-dismiss="modal" onclick="resetExcelImport()">Close</button>
                    <button class="btn btn-primary px-4 d-none" id="btnPreviewExcel" onclick="previewExcelFile()">
                        <i class="bi bi-eye me-1"></i> Preview Data
                    </button>
                    <button class="btn px-4 d-none" id="btnStartImport" onclick="startExcelImport()"
                            style="background: linear-gradient(135deg, #0d9488, #0891b2); color: #fff; font-weight: 600;">
                        <i class="bi bi-download me-1"></i> Import <span id="btnImportCount"></span> Tasks
                    </button>
                    <button class="btn btn-outline-primary px-4 d-none" id="btnImportMore" onclick="resetExcelImport()">
                        <i class="bi bi-plus-lg me-1"></i> Import Another File
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* ═══════ PREMIUM UI/UX ENHANCEMENTS ═══════ */
        .modal-content { border-radius: 16px; overflow: hidden; }
        .modal-header { border-bottom: none !important; padding: 1.5rem 2rem; }
        .modal-body { padding: 2rem; }
        .modal-footer { border-top: none !important; padding: 1.5rem 2rem; }
        
        .form-control, .form-select {
            border-radius: 10px;
            padding: 0.6rem 1rem;
            border: 1px solid #e2e8f0;
            background-color: #f8fafc;
            transition: all 0.2s ease;
        }
        .form-control:focus, .form-select:focus {
            background-color: #fff;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border: none;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2), 0 2px 4px -1px rgba(37, 99, 235, 0.1);
            font-weight: 600;
            padding: 0.6rem 1.5rem;
            border_radius: 10px;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3);
        }
        
        .btn-outline-primary {
            border: 2px solid #3b82f6;
            color: #3b82f6;
            font-weight: 600;
            border-radius: 10px;
        }
        .btn-outline-primary:hover {
            background-color: #3b82f6;
            color: #fff;
        }

        /* Existing Field Item Enhancements */
        .field-item:hover {
            border-color: #3b82f6 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08) !important;
        }
        
        /* ═══════ EXCEL IMPORT MODAL STYLES ═══════ */
        .excel-drop-zone {
            border: 2px dashed #0d9488;
            border-radius: 16px;
            padding: 48px 24px;
            text-align: center;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f0fdfa, #ecfdf5);
            cursor: pointer;
        }
        .excel-drop-zone.drag-over {
            border-color: #0891b2;
            background: linear-gradient(135deg, #ccfbf1, #cffafe);
            transform: scale(1.01);
        }
        .drop-zone-icon {
            font-size: 3rem;
            color: #0d9488;
            display: block;
            margin-bottom: 12px;
        }
        .file-info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #f0fdfa;
            border: 1px solid #99f6e4;
            border-radius: 12px;
            margin-top: 12px;
        }
        .stat-card {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f8faff;
            border: 1px solid #e8eaff;
            border-radius: 10px;
            padding: 12px 16px;
            flex: 1;
        }
        .stat-card i { font-size: 1.5rem; }
        .stat-value { font-size: 1.2rem; font-weight: 700; color: #1a1a2e; }
        .mapping-section {
            background: #f8f9ff;
            border: 1px solid #e8eaff;
            border-radius: 12px;
            padding: 16px;
        }
        .preview-table-wrapper {
            background: #fff;
            border: 1px solid #e8eaff;
            border-radius: 12px;
            padding: 16px;
        }
        #previewTable th {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        #previewTable td {
            font-size: 0.8rem;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .import-progress-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0d9488, #0891b2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }
        .spinning-icon {
            font-size: 2rem;
            color: #fff;
            animation: spin 2s linear infinite;
        }
        @@keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .result-icon {
            font-size: 3rem;
        }
        .result-success { color: #10b981; }
        .result-warning { color: #f59e0b; }
        .result-danger { color: #ef4444; }
        .import-tab-content { min-height: 300px; }
        .import-history-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #f8faff;
            border: 1px solid #e8eaff;
            border-radius: 10px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }
        .import-history-card:hover {
            background: #eef2ff;
            border-color: #c7d2fe;
        }
        #importTabs .nav-link {
            color: #6b7280;
            font-weight: 600;
            font-size: 0.9rem;
            border: none;
            border-bottom: 2px solid transparent;
            padding: 8px 16px;
        }
        #importTabs .nav-link.active {
            color: #0d9488;
            border-bottom-color: #0d9488;
            background: none;
        }
    </style>

</div> <!-- /.app-wrapper -->

<!-- Task History Modal -->
<div class="modal fade" id="taskHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-clock-history"></i> Task History - <span id="historyModalTaskId"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div id="historyTimeline" class="p-3">
                    <!-- Timeline content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>


    <!-- ═══════ BOARD PERMISSION MODAL (Admin Only) ═══════ -->
    <div class="modal fade" id="boardPermissionModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
                <div class="modal-header bg-dark text-white d-flex justify-content-between align-items-center" 
                     style="border-radius: 16px 16px 0 0; cursor: pointer;" 
                     ondblclick="bootstrap.Modal.getInstance(this.closest('.modal')).hide()"
                     title="Double-click to close">
                    <h5 class="modal-title">
                        <i class="bi bi-shield-lock me-2 text-info"></i>Board Permissions
                    </h5>
                    <div class="d-flex align-items-center gap-2 me-3">
                        <button id="toggleDragDropMode" class="btn btn-sm btn-outline-info border-0" onclick="toggleBoardPermissionMode()" title="Configure Drag & Drop Rules">
                            <i class="bi bi-arrows-move me-1"></i>Drag & Drop
                        </button>
                        <div class="vr bg-white-50 mx-1" style="height: 20px;"></div>
                        <label class="small text-white-50 mb-0">Role Filter:</label>
                        <select id="boardRoleFilter" class="form-select form-select-sm bg-secondary text-white border-0" onchange="filterBoardPermissions()" style="width: auto; min-width: 140px;">
                            <option value="All">All Members</option>
                            <option value="Manager">Manager</option>
                            <option value="Sub Manager">Sub Manager</option>
                            <option value="User">User</option>
                        </select>
                    </div>
                    <button type="button" class="btn-close btn-close-white ms-0" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light text-muted small text-uppercase fw-bold">
                                <tr>
                                    <th class="ps-4 py-3">Member</th>
                                    <th class="text-center small text-uppercase fw-bold text-muted" style="font-size: 0.65rem;">Add Col</th>
                                    <th class="text-center small text-uppercase fw-bold text-muted" style="font-size: 0.65rem;">Rename</th>
                                    <th class="text-center small text-uppercase fw-bold text-muted" style="font-size: 0.65rem;">Reorder</th>
                                    <th class="text-center small text-uppercase fw-bold text-muted" style="font-size: 0.65rem;">Del Col</th>
                                    <th class="text-center small text-uppercase fw-bold text-muted" style="font-size: 0.65rem;">Edit All</th>
                                    <th class="text-center small text-uppercase fw-bold text-muted" style="font-size: 0.65rem;">Delete Task</th>
                                    <th class="text-center small text-uppercase fw-bold text-muted" style="font-size: 0.65rem;">Review</th>
                                    <th class="text-center small text-uppercase fw-bold text-muted" style="font-size: 0.65rem;">Import Excel</th>
                                    <th class="text-center small text-uppercase fw-bold text-muted" style="font-size: 0.65rem;">Assign</th>
                                    <th class="text-center small text-uppercase fw-bold text-muted" style="font-size: 0.65rem;">All</th>
                                </tr>
                            </thead>
                            <tbody id="permissionTableBody">
                                <!-- Loaded via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button class="btn btn-secondary px-4" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>



<!-- MOBILE SIDEBAR TOGGLE BUTTON -->
<button class="sidebar-toggle d-md-none" id="sidebarToggle" onclick="toggleSidebar()" aria-label="Toggle sidebar">
    <i class="bi bi-list"></i>
</button>

<script>
    // ===== SIDEBAR TOGGLE (MOBILE) =====
    function toggleSidebar() {
        const sidebar = document.getElementById('leftSidebar');
        const overlay = document.getElementById('sidebarOverlay');
        sidebar.classList.toggle('open');
        overlay.classList.toggle('active');
    }

    function closeSidebar() {
        const sidebar = document.getElementById('leftSidebar');
        const overlay = document.getElementById('sidebarOverlay');
        sidebar.classList.remove('open');
        overlay.classList.remove('active');
    }

    // Close sidebar when a team/project is selected on mobile
    document.addEventListener('click', function (e) {
        if (window.innerWidth < 768 && e.target.closest('.team-btn, .project-btn')) {
            closeSidebar();
        }
    });
</script>


<script>
    // expose admin flag to JS as boolean
    const __isTasksAdmin = @((isAdmin).ToString().ToLower());

    // ===== ADMIN TEAM MANAGEMENT =====

    function toggleAddTeamInput() {
        const container = document.getElementById('addTeamInputContainer');
        const input = document.getElementById('newTeamNameInput');

        if (container.style.display === 'none') {
            container.style.display = 'block';
            input.value = '';
            input.focus();

            // Enter key to submit
            input.onkeydown = function (e) {
                if (e.key === 'Enter') submitCreateTeam();
            };
        } else {
            container.style.display = 'none';
        }
    }

    function submitCreateTeam() {
        const input = document.getElementById('newTeamNameInput');
        const name = input.value.trim();

        if (!name) {
            toggleAddTeamInput();
            return;
        }

        fetch('/Teams/Create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ Name: name })
        })
            .then(res => {
                if (!res.ok) return res.text().then(t => { throw new Error(t); });
                return res.json();
            })
            .then(() => {
                toggleAddTeamInput();
                loadAdminTeamList(); // Refresh list
            })
            .catch(err => {
                console.error(err);
                alert('Failed to add team: ' + err.message);
            });
    }

    function loadAdminTeamList(autoLoadFirst = false) {
        const container = document.getElementById('adminTeamList');
        if (!container) return;

        fetch('/Teams/GetAll')
            .then(res => res.json())
            .then(teams => {
                if (teams.length === 0) {
                    container.innerHTML = '<div class="text-muted ps-4 py-2 small">No teams found</div>';
                    return;
                }

                container.innerHTML = teams.map(t => {
                    let safeName = t.name.replace(/ /g, '_');
                    let teamId = 'teamAdmin_' + safeName;
                    
                    let icon = "bi-people";
                    
                    let deleteBtn = `
                        <button class="btn btn-sm btn-link text-danger p-0 me-2" 
                                style="opacity:0.5;"
                                onmouseover="this.style.opacity=1"
                                onmouseout="this.style.opacity=0.5"
                                onclick="deleteTeam(${t.id}, '${t.name}')" 
                                title="Delete Team">
                            <i class="bi bi-trash"></i>
                        </button>`;
                    
                    let assignBtn = '';
                    if (@(canAssign ? "true" : "false")) {
                        assignBtn = `
                            <button type="button" class="list-group-item list-group-item-action ps-5 py-2 border-0 text-info bg-dark" 
                                onclick="loadAssignedTasksOverview('${t.name}')">
                                <i class="bi bi-person-check me-2"></i> Assign Task
                            </button>`;
                    }

                    return `
                    <div class="team-sidebar-item">
                        <div class="d-flex align-items-center group-hover-container px-0">
                            <button type="button"
                                    class="list-group-item list-group-item-action bg-dark text-white team-btn flex-grow-1 text-start border-0 py-2 ps-4 d-flex align-items-center"
                                    data-team="${t.name}"
                                    onclick="loadTeamBoard('${t.name}')"
                                    ondblclick="toggleTeamItem('${teamId}')"
                                    title="Single-click: Board | Double-click: Toggle Assign">
                                <i class="bi ${icon} me-2"></i> ${t.name}
                            </button>
                            ${deleteBtn}
                        </div>
                        <div id="${teamId}" style="display:none;">
                            ${assignBtn}
                        </div>
                    </div>
                    `;
                }).join('');

                // Re-highlight if needed
                if (typeof currentTeamName !== 'undefined') {
                    document.querySelectorAll(`.team-btn[data-team="${currentTeamName}"]`)
                        .forEach(b => b.classList.add('active'));
                }

                // Auto-load first team removed — user must click 'Open Board' explicitly
            });
    }

    function deleteTeam(id, name) {
        if (!confirm(`Delete team '${name}'? This cannot be undone.`)) return;

        fetch('/Teams/Delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(id)
        })
            .then(res => {
                if (!res.ok) throw new Error('Failed to delete');
                loadAdminTeamList();
                // clear board if deleted team was active
                const boardContainer = document.getElementById('taskBoardContainer');
                boardContainer.innerHTML = '';
            })
            .catch(err => alert(err.message));
    }

    // Load team list on page load (no auto-board-load)
    document.addEventListener('DOMContentLoaded', function () {
        if (__isTasksAdmin) {
            loadAdminTeamList(false);
        }
    });

    // open add column modal (admin only)
    function openAddColumnModal(teamName) {
        if (!__isTasksAdmin && (!window.boardPermissions || !window.boardPermissions.canAddColumn)) return;
        document.getElementById("addColumnTeam").value = teamName;
        document.getElementById("newColumnName").value = "";

        const modal = new bootstrap.Modal(document.getElementById("addColumnModal"));
        modal.show();
    }

    // save new column (admin only)
    document.getElementById('addColumnSubmit')?.addEventListener('click', function () {
        if (!__isTasksAdmin && (!window.boardPermissions || !window.boardPermissions.canAddColumn)) return;
        const team = document.getElementById('addColumnTeam').value;
        const columnName = document.getElementById('newColumnName').value.trim();
        if (!columnName) { alert('Column name is required'); return; }

        fetch('/Tasks/AddColumn', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ team: team, columnName: columnName })
        })
            .then(res => { if (!res.ok) throw new Error('Failed'); return res.text(); })
            .then(() => {
                bootstrap.Modal.getInstance(document.getElementById('addColumnModal'))?.hide();
                // reload the board for the team
                loadTeamBoard(team);
            })
            .catch(() => alert('Failed to add column'));
    });
</script>

@{
    ViewData["Title"] = "Task Board";
}


<link rel="stylesheet" href="~/css/taskHistory.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="~/js/customFields.js"></script>
<script src="~/js/taskHistory.js"></script>
<script src="~/js/column_filter.js"></script>
<script src="~/js/index_ui.js"></script>
<script src="~/js/board-permissions.js"></script>

<script>
    function enableColumnDrag() {
        if (!__isTasksAdmin) return;

        const board = document.querySelector('#kanbanBoard');
        if (!board) {
            console.warn('Kanban board not found');
            return;
        }

        // 🔥 SAFETY: remove old sortable safely
        if (board._sortableInstance) {
            board._sortableInstance.destroy();
            board._sortableInstance = null;
        }

        board._sortableInstance = new Sortable(board, {
            animation: 150,
            direction: 'horizontal',
            draggable: '.kanban-column:not(.col-history)',
            handle: '.column-drag-handle',
            filter: '.col-history',

            onEnd: function () {
                const columnIds = Array.from(
                    board.querySelectorAll('.kanban-column:not(.col-history)')
                ).map(c => parseInt(c.dataset.columnId)).filter(id => !isNaN(id));

                if (columnIds.length === 0) return;

                fetch('/Tasks/ReorderColumns', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(columnIds)
                })
                    .then(res => {
                        if (res.ok) {
                            showToast('✅ Column order updated!', 'success');
                        } else {
                            showToast('Failed to save column order', 'danger');
                        }
                    })
                    .catch(() => showToast('Failed to save column order', 'danger'));
            }
        });

    }


    // NOTE: openCreateTaskModal and submitCreateTask are defined later in this file.
    // Removed duplicate definitions to avoid function override/conflict

    function startRename(columnId) {
        if (!__isTasksAdmin) return;
        document.getElementById(`column-title-${columnId}`).style.display = 'none';
        document.getElementById(`column-rename-${columnId}`).style.display = 'flex';
    }

    function cancelRename(columnId) {
        document.getElementById(`column-rename-${columnId}`).style.display = 'none';
        document.getElementById(`column-title-${columnId}`).style.display = 'block';
    }

    function saveColumnName(columnId) {
        if (!__isTasksAdmin) return;
        const input = document.getElementById(`column-input-${columnId}`);
        const newName = input?.value?.trim();
        if (!newName) { alert('Column name required'); return; }

        fetch('/Tasks/RenameColumn', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ columnId: columnId, name: newName })
        })
            .then(res => { if (!res.ok) throw new Error(); return res.text(); })
            .then(() => {
                document.getElementById(`column-title-${columnId}`).innerText = newName;
                cancelRename(columnId);
            })
            .catch(() => alert('Rename failed'));
    }

    function confirmDeleteColumn(columnId) {
        if (!__isTasksAdmin) return;
        if (!confirm('Delete this column?')) return;
        fetch('/Tasks/DeleteColumn', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ columnId }) })
            .then(res => { if (!res.ok) return res.text().then(t => { throw new Error(t); }); return res.text(); })
            .then(() => document.querySelector(`[data-column-id='${columnId}']`)?.remove())
            .catch(err => alert(err.message));
    }
</script>

<script>
    // ════════ SignalR Real-Time Logic ════════
    var taskHubConnection = new signalR.HubConnectionBuilder()
        .withUrl("/taskHub")
        .withAutomaticReconnect()
        .build();

    taskHubConnection.on("TaskMoved", function (data) {
        console.log("Task moved received:", data);
        handleTaskMovedUpdate(data);
    });

    taskHubConnection.on("TaskReviewed", function (data) {
        console.log("Task reviewed received:", data);
        handleTaskReviewedUpdate(data);
    });

    taskHubConnection.on("TaskRemoved", function (data) {
        console.log("Task removed received:", data);
        handleTaskRemovedUpdate(data);
    });

    taskHubConnection.on("TaskAdded", function (data) {
        console.log("Task added received:", data);
        handleTaskAddedUpdate(data);
    });

    taskHubConnection.on("TaskAssigned", function (data) {
        console.log("Task assigned received:", data);
        handleTaskAssignedUpdate(data);
    });

    taskHubConnection.on("NewMoveRequest", function (data) {
        console.log("New move request received:", data);
        if (typeof showToast === 'function') {
            showToast(`📩 New Move Request from ${data.requestedBy} for task: ${data.taskTitle}`, 'info', 10000);
        }
        const badge = document.getElementById('moveRequestBadge');
        if (badge) {
            badge.textContent = parseInt(badge.textContent || 0) + 1;
            badge.classList.remove('d-none');
        }
    });

    taskHubConnection.on("MoveRequestHandled", function (data) {
        console.log("Move request handled received:", data);
        if (typeof showToast === 'function') {
            const status = data.approved ? '✅ Approved' : '❌ Rejected';
            showToast(`Move Request ${status}: ${data.reply || ''}`, data.approved ? 'success' : 'warning', 10000);
        }
    });

    taskHubConnection.on("PermissionsUpdated", function (userId, teamName) {
        console.log("Permissions updated received for:", userId, teamName);
        const currentUserId = '@UserManager.GetUserId(User)';
        if (userId === currentUserId && window.currentTeamName && window.currentTeamName.toLowerCase().trim() === teamName.toLowerCase().trim()) {
            if (typeof loadTeamBoard === "function") {
                loadTeamBoard(window.currentTeamName);
                if (typeof showToast === "function") {
                    showToast("🔔 Your board permissions have been updated.", "info");
                }
            }
        }
    });

    taskHubConnection.on("ProjectAccessUpdated", function () {
        console.log("Project access updated received");
        if (typeof loadProjectList === "function") {
            loadProjectList();
            showToast("📁 A new project has been assigned to you.", "success");
        }
    });

    taskHubConnection.start()
        .then(() => {
            console.log("SignalR Connected");
            if (window.currentTeamName) {
                taskHubConnection.invoke("JoinTeamGroup", window.currentTeamName);
            }
        })
        .catch(err => console.error("SignalR Connection Error: ", err));

    function handleTaskMovedUpdate(data) {
        const card = document.querySelector(`.task-card[data-task-id="${data.taskId}"]`);
        if (!card) return;

        const targetColumn = document.querySelector(`.kanban-column[data-column-id="${data.newColumnId}"]`);
        if (!targetColumn) return;

        const taskList = targetColumn.querySelector('.kanban-tasks');
        if (!taskList) return;

        // Move the element
        taskList.appendChild(card);
        
        // Update attributes
        card.dataset.columnId = data.newColumnId;

        // UI Adjustments (Buttons / Badges)
        const colName = data.columnName.toLowerCase().trim();
        const isReview = colName === 'review';
        const isCompleted = colName === 'completed';
        const isRestricted = isReview || isCompleted;

        const assignBtn = card.querySelector('.action-btn-assign');
        const editBtn = card.querySelector('.action-btn-edit');
        const reviewBtn = card.querySelector('.action-btn-review');
        const archiveBtn = card.querySelector('.action-btn-archive');

        if (assignBtn) assignBtn.style.display = isRestricted ? 'none' : 'inline-flex';
        if (editBtn) editBtn.style.display = isRestricted ? 'none' : 'inline-flex';
        if (reviewBtn) reviewBtn.style.display = isReview ? 'inline-flex' : 'none';
        if (archiveBtn) archiveBtn.style.display = isCompleted ? 'inline-flex' : 'none';

        const pendingBadge = card.querySelector('.review-badge-pending');
        const failBadge = card.querySelector('.review-badge-fail');
        const passBadge = card.querySelector('.review-badge-pass');

        if (isReview) {
            if (pendingBadge) pendingBadge.style.display = 'inline-flex';
            if (failBadge) failBadge.style.display = 'none';
            if (passBadge) passBadge.style.display = 'none';
        } else {
            if (pendingBadge) pendingBadge.style.display = 'none';
        }

        updateColumnCounts();
        if (typeof filterBoardTasks === 'function') filterBoardTasks();
        if (window.currentTeamName && typeof loadArchivedTasks === 'function') loadArchivedTasks(window.currentTeamName);
        showToast(`Task #${data.taskId} moved to ${data.columnName}`, 'info');
    }

    function handleTaskReviewedUpdate(data) {
        const card = document.querySelector(`.task-card[data-task-id="${data.taskId}"]`);
        if (!card) return;

        const passBadge = card.querySelector('.review-badge-pass');
        const failBadge = card.querySelector('.review-badge-fail');
        const pendingBadge = card.querySelector('.review-badge-pending');

        if (data.passed) {
            if (passBadge) passBadge.style.display = 'inline-flex';
            if (failBadge) failBadge.style.display = 'none';
        } else {
            if (failBadge) failBadge.style.display = 'inline-flex';
            if (passBadge) passBadge.style.display = 'none';
        }
        if (pendingBadge) pendingBadge.style.display = 'none';

        // If moved columns due to review
        if (data.newColumnId) {
            const currentColumnId = parseInt(card.dataset.columnId);
            if (currentColumnId !== data.newColumnId) {
                handleTaskMovedUpdate({
                    taskId: data.taskId,
                    newColumnId: data.newColumnId,
                    columnName: data.columnName
                });
            }
        }
    }

    function handleTaskRemovedUpdate(data) {
        const card = document.querySelector(`.task-card[data-task-id="${data.taskId}"]`);
        if (card) {
            card.remove();
            updateColumnCounts();
            if (typeof filterBoardTasks === 'function') filterBoardTasks();
            if (window.currentTeamName && typeof loadArchivedTasks === 'function') loadArchivedTasks(window.currentTeamName);
            showToast(`Task #${data.taskId} moved to another team`, 'info');
        }
    }

    function handleTaskAddedUpdate(data) {
        // Prevent duplicates
        if (document.querySelector(`.task-card[data-task-id="${data.taskId}"]`)) return;

        // Ensure we are on the same team
        if (window.currentTeamName && data.teamName && window.currentTeamName.toLowerCase() !== data.teamName.toLowerCase()) {
            return; 
        }

        fetch(`/Tasks/GetTaskCardPartial?taskId=${data.taskId}`)
            .then(res => {
                if (!res.ok) throw new Error("Failed to fetch card");
                return res.text();
            })
            .then(html => {
                const targetColumn = document.querySelector(`.kanban-column[data-column-id="${data.columnId}"]`);
                if (!targetColumn) {
                    // If column not found, maybe board needs full reload or it's a dynamic column
                    console.warn("Target column not found for TaskAdded event, reloading board...");
                    if (window.currentTeamName) loadTeamBoard(window.currentTeamName);
                    return;
                }

                const taskList = targetColumn.querySelector('.kanban-tasks');
                if (!taskList) return;

                taskList.insertAdjacentHTML('afterbegin', html);
                updateColumnCounts();
                if (typeof filterBoardTasks === 'function') filterBoardTasks();
                if (window.currentTeamName && typeof loadArchivedTasks === 'function') loadArchivedTasks(window.currentTeamName);
                showToast(`New task #${data.taskId} added to this board`, 'success');
            })
            .catch(err => console.error("Error adding task:", err));
    }

    function handleTaskAssignedUpdate(data) {
        const card = document.querySelector(`.task-card[data-task-id="${data.taskId}"]`);
        if (!card) return;

        fetch(`/Tasks/GetTaskCardPartial?taskId=${data.taskId}`)
            .then(res => res.text())
            .then(html => {
                // Replace entire card to ensure all UI elements are correct
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                const newCard = tempDiv.firstElementChild;
                card.parentNode.replaceChild(newCard, card);
                
                // Re-apply filters to correctly show/hide the updated card
                if (typeof filterBoardTasks === 'function') filterBoardTasks();
                if (window.currentTeamName && typeof loadArchivedTasks === 'function') loadArchivedTasks(window.currentTeamName);

                showToast(`Task #${data.taskId} assigned to ${data.assignedTo}`, 'success');
            })
            .catch(err => console.error("Error updating assigned task:", err));
    }

    function loadTeamBoard(team) {
        if (!team) {
            console.error("loadTeamBoard called with empty team name");
            return;
        }
        // ✅ JOIN GROUP
        if (taskHubConnection.state === signalR.HubConnectionState.Connected) {
            if (window.currentTeamName) {
                taskHubConnection.invoke("LeaveTeamGroup", window.currentTeamName);
            }
            taskHubConnection.invoke("JoinTeamGroup", team);
        }

        // ✅ SAVE CURRENT TEAM
        window.currentTeamName = team;

        const container = document.getElementById('taskBoardContainer');
        if (!container) return;

        container.innerHTML = "<div class='text-center py-5'><div class='spinner-border text-info mb-2'></div><br><span class='text-muted'>Loading board...</span></div>";

        fetch(`/Tasks/TeamBoard?team=${encodeURIComponent(team)}`)
            .then(res => {
                if (!res.ok) throw new Error("Failed to load board");
                return res.text();
            })
            .then(html => {
                container.innerHTML = html;

                // highlight active team button
                document.querySelectorAll('.team-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll(`.team-btn[data-team]`).forEach(b => {
                    if (b.dataset.team === team) b.classList.add('active');
                });

                // Execute scripts from the dynamically loaded content
                const scripts = container.querySelectorAll('script');
                scripts.forEach(script => {
                    const newScript = document.createElement('script');
                    if (script.src) {
                        newScript.src = script.src;
                    } else {
                        newScript.textContent = script.textContent;
                    }
                    document.body.appendChild(newScript);
                    // Remove after execution to avoid duplicates if re-rendered
                    setTimeout(() => newScript.remove(), 100);
                });

                if (typeof syncBoardPermissions === "function") {
                    syncBoardPermissions();
                }
                if (typeof enableColumnDrag === "function") {
                    enableColumnDrag();
                }
                if (typeof enableTaskDragDrop === "function") {
                    enableTaskDragDrop();
                }
            })
            .catch(err => {
                container.innerHTML = "<div class='text-danger p-4'>Error loading board. Please try again.</div>";
                console.error(err);
            });
    }

    function loadAssignedTasksOverview(team) {
        const container = document.getElementById('taskBoardContainer');
        if (!container) return;

        container.innerHTML = "<div class='text-center py-5'><div class='spinner-border text-primary mb-2'></div><br><span class='text-muted'>Loading assigned tasks...</span></div>";

        fetch(`/Tasks/AssignedTasksOverview?team=${encodeURIComponent(team)}`)
            .then(res => {
                if (!res.ok) throw new Error("Failed to load overview");
                return res.text();
            })
            .then(html => {
                container.innerHTML = html;
                window.currentTeamName = team; // Keep track of the team
                
                // Highlight corresponding team button if possible
                document.querySelectorAll('.team-btn').forEach(b => b.classList.remove('active'));
            })
            .catch(err => {
                container.innerHTML = "<div class='text-danger p-4'>Error loading assigned tasks overview.</div>";
                console.error(err);
            });
    }
</script>


<script>
    function focusColumn(columnId) {
        const board = document.getElementById('kanbanBoard');
        const backBtn = document.getElementById('backToBoardBtn');
        if (!board) return;

        board.classList.add('single-column-view');
        board.querySelectorAll('.kanban-column').forEach(col => {
            const id = parseInt(col.dataset.columnId);
            if (id === columnId) { col.classList.add('focused-column'); col.classList.remove('hidden-column'); }
            else { col.classList.remove('focused-column'); col.classList.add('hidden-column'); }
        });
        if (backBtn) backBtn.style.display = 'inline-block';
    }


    function focusTask(taskId) {
        taskId = parseInt(taskId);
        if (isNaN(taskId)) return;

        const body = document.getElementById('taskOverviewBody');
        const headerActions = document.getElementById('taskOverviewActions');

        body.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';
        if (headerActions) headerActions.innerHTML = '';

        const modal = new bootstrap.Modal(document.getElementById('taskOverviewModal'));
        modal.show();

        fetch(`/Tasks/GetTaskDetail?id=${taskId}`)
            .then(res => {
                if (!res.ok) throw new Error('Task not found');
                return res.json();
            })
            .then(t => {
                const customPriorityObj = (t.customFields || []).find(f => f.fieldName && f.fieldName.trim().toLowerCase() === 'priority');
                const effectivePriority = (customPriorityObj && customPriorityObj.value) ? customPriorityObj.value : t.priority;
                
                const priorityClassMap = { 'low': 'secondary', 'medium': 'info', 'high': 'warning', 'critical': 'danger' };
                const priorityBadgeClass = priorityClassMap[effectivePriority.toLowerCase()] || 'secondary';
                const priorityBadge = `<span class="badge bg-${priorityBadgeClass}">${escapeHtml(effectivePriority.toUpperCase())}</span>`;

                const dueDateBadge = t.dueDate ? 
                    `<span class="badge bg-light text-dark border d-flex align-items-center gap-1">
                        <i class="bi bi-calendar-event text-danger"></i>
                        Due Date: ${formatDate(t.dueDate)}
                    </span>` : '';

                const reviewColors = { 'Passed': 'success', 'Failed': 'danger', 'Pending': 'warning', 'None': 'secondary' };
                const reviewBadge = t.reviewStatus && t.reviewStatus !== 'None' ?
                    `<span class="badge bg-${reviewColors[t.reviewStatus] || 'secondary'}">${escapeHtml(t.reviewStatus)}</span>` : '';

                const colName = (t.column || t.status || "").toLowerCase().trim();
                const isCompleted = colName === 'completed' || colName === 'complete' || colName === 'done';
                const isReview = colName === 'review';

                if (headerActions) {
                    headerActions.innerHTML = `
                        <button class="modal-action-btn-sm btn-modal-history" title="History" onclick="openTaskHistoryFromModal(${t.id})">
                            <i class="bi bi-clock-history"></i>
                        </button>
                        
                        ${(isAdmin || document.getElementById('kanbanBoard')?.dataset.permAssignTask === 'true') && !isCompleted ? `
                        <button class="modal-action-btn-sm btn-modal-assign" title="Assign" onclick="showAssignUIFromModal(${t.id})">
                            <i class="bi bi-person-plus"></i>
                        </button>` : ''}

                        ${!isCompleted || isAdmin ? `
                        <button class="modal-action-btn-sm btn-modal-edit" title="Edit" onclick="openEditTaskFromModal(${t.id})">
                            <i class="bi bi-pencil-square"></i>
                        </button>` : ''}
                    `;
                }

                const prioMap = {
                    'critical': { color: '#ef4444', bg: '#ef444415', border: '#ef444440', icon: 'bi-exclamation-triangle-fill' },
                    'high': { color: '#f59e0b', bg: '#f59e0b15', border: '#f59e0b40', icon: 'bi-arrow-up-circle-fill' },
                    'medium': { color: '#3b82f6', bg: '#3b82f615', border: '#3b82f640', icon: 'bi-dash-circle-fill' },
                    'low': { color: '#94a3b8', bg: '#94a3b815', border: '#94a3b840', icon: 'bi-arrow-down-circle-fill' }
                };
                const prio = prioMap[effectivePriority.toLowerCase()] || prioMap['low'];

                const getInitials = (name) => {
                    if (!name) return '?';
                    const parts = name.replace(/[^a-zA-Z ]/g, '').trim().split(' ');
                    return parts.length > 1 ? (parts[0][0] + parts[1][0]).toUpperCase() : name.substring(0, 2).toUpperCase();
                };

                const taskTypeObj = (t.customFields || []).find(f => f.fieldName && f.fieldName.trim().toLowerCase() === 'task type');
                const taskType = taskTypeObj ? taskTypeObj.value : null;
                
                let taskTypeBadge = '';
                if (taskType) {
                    const typeIconMap = {
                        "story": "bi-journal-text",
                        "bug": "bi-bug-fill",
                        "feature": "bi-star-fill",
                        "enhancement": "bi-rocket-takeoff-fill"
                    };
                    const typeColorMap = {
                        "story": "#6366f1",
                        "bug": "#ef4444",
                        "feature": "#f59e0b",
                        "enhancement": "#10b981"
                    };
                    const typeIcon = typeIconMap[taskType.toLowerCase()] || "bi-tag-fill";
                    const typeColor = typeColorMap[taskType.toLowerCase()] || "#64748b";
                    
                    taskTypeBadge = `<span title="Type: ${escapeHtml(taskType)}" style="background: ${typeColor}15; color: ${typeColor}; border: 1px solid ${typeColor}30; width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: 700; font-size: 0.8rem;">
                        <i class="bi ${typeIcon}"></i>
                    </span>`;
                }

                body.innerHTML = `
                    <!-- Title + Badges -->
                    <div style="border-left: 5px solid ${prio.color}; padding-left: 16px; margin-bottom: 16px;">
                        <h4 style="font-weight: 700; color: #1e293b; margin: 0 0 8px 0; font-size: 1.5rem;">${escapeHtml(t.title)}</h4>
                        <div class="d-flex gap-2 flex-wrap align-items-center">
                            <span style="background: ${prio.bg}; color: ${prio.color}; border: 1px solid ${prio.border}; padding: 3px 12px; border-radius: 50px; font-weight: 700; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                <i class="bi ${prio.icon}" style="margin-right: 4px;"></i>${escapeHtml(effectivePriority.toUpperCase())}
                            </span>
                            ${taskTypeBadge}
                            ${reviewBadge}
                            <span style="background: #f1f5f9; color: #475569; padding: 3px 12px; border-radius: 50px; font-weight: 600; font-size: 0.7rem; border: 1px solid #e2e8f0;">${escapeHtml(t.column || t.status)}</span>
                            ${t.dueDateFormatted ? `<span style="color: #dc2626; padding: 3px 12px; border-radius: 50px; font-weight: 600; font-size: 0.7rem; border: 1px solid #fecaca; background: #fef2f2;"><i class="bi bi-calendar-event" style="margin-right: 4px;"></i>${t.dueDateFormatted}</span>` : ''}
                        </div>
                    </div>

                    <!-- Description -->
                    ${t.description ? `
                    <div style="background: #f8fafc; border-radius: 10px; padding: 12px 16px; margin-bottom: 14px; border: 1px solid #f1f5f9;">
                        <div style="font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: #94a3b8; margin-bottom: 6px;"><i class="bi bi-text-paragraph me-1"></i>Description</div>
                        <p style="margin: 0; color: #475569; font-size: 0.9rem; line-height: 1.5;">${escapeHtml(t.description)}</p>
                    </div>` : ''}

                    <!-- Custom Fields -->
                    ${t.customFields && t.customFields.length > 0 ? `
                    <div style="background: #f8fafc; border-radius: 10px; padding: 12px 16px; margin-bottom: 14px; border: 1px solid #f1f5f9;">
                        <div style="font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: #94a3b8; margin-bottom: 8px;"><i class="bi bi-grid-3x3-gap me-1"></i>Details</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 8px;">
                            ${t.customFields.map(f => {
                                const isImage = f.value && (f.value.startsWith('data:image/') || f.value.includes('/Tasks/GetFieldImage/') || f.value.includes('/Tasks/GetFieldImageById/') || f.value.toLowerCase().match(/\.(jpg|jpeg|png|gif|webp)$/));
                                return `<div style="background: #fff; padding: 8px 12px; border-radius: 8px; border: 1px solid #e2e8f0; position: relative; overflow: hidden;">
                                    <div style="font-size: 0.65rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">${escapeHtml(f.fieldName || '')}</div>
                                    <div class="d-flex flex-wrap gap-2 mt-1">
                                        ${isImage ? `
                                            <div style="position: relative; cursor: pointer;" onclick="openLightbox('${f.value}')" title="Click to view full image">
                                                <img src="${f.value}" style="max-width: 100px; max-height: 80px; object-fit: contain; border-radius: 6px; border: 1px solid #f1f5f9;" />
                                                <div style="position: absolute; bottom: 2px; right: 2px; background: rgba(0,0,0,0.5); color: #fff; border-radius: 4px; padding: 2px; font-size: 0.6rem;">
                                                    <i class="bi bi-arrows-fullscreen"></i>
                                                </div>
                                            </div>` 
                                        : `<div style="font-weight: 600; color: #334155; font-size: 0.85rem; margin-top: 2px;">${escapeHtml(f.value || '—')}</div>`}
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>` : ''}

                    <!-- Review Note -->
                    ${t.reviewNote ? `
                    <div style="background: #fffbeb; border-left: 4px solid #f59e0b; border-radius: 0 10px 10px 0; padding: 10px 14px; margin-bottom: 14px;">
                        <div style="font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: #d97706; margin-bottom: 4px;"><i class="bi bi-chat-left-dots-fill me-1"></i>Review Note</div>
                        <div style="color: #92400e; font-size: 0.85rem;">${escapeHtml(t.reviewNote)}</div>
                    </div>` : ''}

                    <!-- Timeline + People side by side -->
                    <div class="row g-2">
                        <div class="col-md-6">
                            <div style="background: #f8fafc; border-radius: 10px; padding: 12px 16px; border: 1px solid #f1f5f9; height: 100%;">
                                <div style="font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: #94a3b8; margin-bottom: 10px;"><i class="bi bi-clock-history me-1"></i>Timeline</div>
                                <div style="position: relative; padding-left: 20px;">
                                    <div style="position: absolute; left: 5px; top: 6px; bottom: 6px; width: 2px; background: #e2e8f0;"></div>
                                    ${t.createdAtFormatted ? `<div style="position: relative; padding-bottom: 10px; font-size: 0.8rem; color: #475569;"><div style="position: absolute; left: -18px; top: 5px; width: 8px; height: 8px; border-radius: 50%; background: #6366f1;"></div><strong>Created</strong> <span style="color: #94a3b8; float: right; font-size: 0.75rem;">${t.createdAtFormatted}</span></div>` : ''}
                                    ${t.assignedAtFormatted ? `<div style="position: relative; padding-bottom: 10px; font-size: 0.8rem; color: #475569;"><div style="position: absolute; left: -18px; top: 5px; width: 8px; height: 8px; border-radius: 50%; background: #06b6d4;"></div><strong>Assigned</strong> <span style="color: #94a3b8; float: right; font-size: 0.75rem;">${t.assignedAtFormatted}</span></div>` : ''}
                                    ${t.reviewedAtFormatted ? `<div style="position: relative; padding-bottom: 10px; font-size: 0.8rem; color: #475569;"><div style="position: absolute; left: -18px; top: 5px; width: 8px; height: 8px; border-radius: 50%; background: #f59e0b;"></div><strong>Reviewed</strong> <span style="color: #94a3b8; float: right; font-size: 0.75rem;">${t.reviewedAtFormatted}</span></div>` : ''}
                                    ${t.completedAtFormatted ? `<div style="position: relative; font-size: 0.8rem; color: #475569;"><div style="position: absolute; left: -18px; top: 5px; width: 8px; height: 8px; border-radius: 50%; background: #10b981;"></div><strong>Completed</strong> <span style="color: #94a3b8; float: right; font-size: 0.75rem;">${t.completedAtFormatted}</span></div>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div style="background: #f8fafc; border-radius: 10px; padding: 12px 16px; border: 1px solid #f1f5f9; height: 100%;">
                                <div style="font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: #94a3b8; margin-bottom: 10px;"><i class="bi bi-people me-1"></i>People</div>
                                <div class="d-flex flex-column gap-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.7rem; flex-shrink: 0;">${getInitials(t.createdBy)}</div>
                                        <div><div style="font-size: 0.65rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px;">Created By</div><div style="font-weight: 600; color: #1e293b; font-size: 0.8rem;">${escapeHtml(t.createdBy || 'N/A')}</div></div>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #06b6d4, #0891b2); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.7rem; flex-shrink: 0;">${getInitials(t.assignedTo)}</div>
                                        <div><div style="font-size: 0.65rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px;">Assigned To</div><div style="font-weight: 600; color: #1e293b; font-size: 0.8rem;">${escapeHtml(t.assignedTo || 'Unassigned')}</div></div>
                                    </div>
                                    ${t.assignedBy ? `<div class="d-flex align-items-center gap-2">
                                        <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #64748b, #475569); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.7rem; flex-shrink: 0;">${getInitials(t.assignedBy)}</div>
                                        <div><div style="font-size: 0.65rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px;">Assigned By</div><div style="font-weight: 600; color: #1e293b; font-size: 0.8rem;">${escapeHtml(t.assignedBy)}</div></div>
                                    </div>` : ''}
                                    ${t.reviewedBy ? `<div class="d-flex align-items-center gap-2">
                                        <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #f59e0b, #d97706); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.7rem; flex-shrink: 0;">${getInitials(t.reviewedBy)}</div>
                                        <div><div style="font-size: 0.65rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px;">Reviewed By</div><div style="font-weight: 600; color: #1e293b; font-size: 0.8rem;">${escapeHtml(t.reviewedBy)}</div></div>
                                    </div>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            })
            .catch(() => {
                body.innerHTML = '<div class="text-danger text-center">Failed to load task details</div>';
            });
    }

    function openEditTaskFromModal(taskId) {
        const modal = bootstrap.Modal.getInstance(document.getElementById('taskOverviewModal'));
        if (modal) modal.hide();
        setTimeout(() => openEditTaskModal(taskId), 350);
    }

    function openTaskHistoryFromModal(taskId) {
        const modal = bootstrap.Modal.getInstance(document.getElementById('taskOverviewModal'));
        if (modal) modal.hide();
        setTimeout(() => {
            if (typeof openTaskHistoryModal === 'function') openTaskHistoryModal(taskId);
        }, 350);
    }

    function showAssignUIFromModal(taskId) {
        const modal = bootstrap.Modal.getInstance(document.getElementById('taskOverviewModal'));
        if (modal) modal.hide();
        setTimeout(() => {
            const card = document.querySelector(`.task-card[data-task-id="${taskId}"]`);
            if (card) {
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                if (typeof showAssignUI === 'function') showAssignUI(taskId);
            }
        }, 400);
    }

    function exitTaskFocus() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('taskOverviewModal'));
        if (modal) modal.hide();
    }

    function openLightbox(src) {
        const img = document.getElementById('lightboxImage');
        const download = document.getElementById('lightboxDownload');
        if (img && download) {
            img.src = src;
            download.href = src;
            const modalEl = document.getElementById('lightboxModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();

            // Fix for nested modals: ensure body has modal-open class when this modal closes
            // if another modal is still open.
            modalEl.addEventListener('hidden.bs.modal', function () {
                if (document.querySelectorAll('.modal.show').length > 0) {
                    document.body.classList.add('modal-open');
                }
            }, { once: true });
        }
    }



    function resetBoardView() {
        const board = document.getElementById('kanbanBoard');
        const backBtn = document.getElementById('backToBoardBtn');
        if (!board) return;

        // reset column focus
        board.classList.remove('single-column-view');
        board.querySelectorAll('.kanban-column').forEach(col => {
            col.classList.remove('focused-column');
            col.classList.remove('hidden-column');
            col.style.display = 'flex';
        });

        // reset task focus
        board.classList.remove('task-focused-view');
        board.querySelectorAll('.task-card').forEach(task => {
            task.classList.remove('focused-task');
            task.style.display = 'block';
        });

        if (backBtn) backBtn.style.display = 'none';
    }

</script>

<script>
    // Load initially if Admin
    document.addEventListener('DOMContentLoaded', function () {
    @if (isAdmin) {
         // Already handled by loadAdminTeamList(true) above
         <text>
             const teamDropdown = document.getElementById('teamTasksDropdown');
             const teamArrow = document.getElementById('teamArrow');
             if (teamDropdown) teamDropdown.style.display = 'block';
             if (teamArrow) teamArrow.innerText = '▲';
         </text>
    }
    else if (userTeams.Any())
    {
        var firstTeam = userTeams.First();
        <text>
                    // User: Auto-expand My Team and load first assigned team
                    const myDropdown = document.getElementById('myTasksDropdown');
                    const myArrow = document.getElementById('myTasksArrow');
                    if (myDropdown) myDropdown.style.display = 'block';
                    if (myArrow) myArrow.innerText = '▲';

                    // load first team
                    loadTeamBoard('@firstTeam');
        </text>
    }
    });
</script>

<script>
    async function openCreateTaskModal(columnId) {
        document.getElementById("taskColumnId").value = columnId;
        document.getElementById("taskTitle").value = "";
        document.getElementById("taskDescription").value = "";
        document.getElementById("taskPriority").value = "1"; // Default to Medium
        document.getElementById("taskDueDate").value = "";

        const board = document.getElementById('kanbanBoard');
        const team = board?.dataset.teamName;
        const showOther = document.getElementById('showOtherCheckbox')?.checked !== false;
        
        // 🔥 Dynamic Visibility for System Fields
        const priorityVisible = showOther && board?.dataset.priorityVisible !== 'false';
        const dueDateVisible = showOther && board?.dataset.dueDateVisible !== 'false';
        const titleVisible = showOther && board?.dataset.titleVisible !== 'false';
        const descriptionVisible = showOther && board?.dataset.descriptionVisible !== 'false';
        
        const priorityGroup = document.getElementById('groupCreateTaskPriority');
        const dueDateGroup = document.getElementById('groupCreateTaskDueDate');
        const titleGroup = document.getElementById('groupCreateTaskTitle');
        const descriptionGroup = document.getElementById('groupCreateTaskDescription');
        
        if (priorityGroup) priorityGroup.style.display = priorityVisible ? 'block' : 'none';
        if (dueDateGroup) dueDateGroup.style.display = dueDateVisible ? 'block' : 'none';
        if (titleGroup) titleGroup.style.display = titleVisible ? 'block' : 'none';
        if (descriptionGroup) descriptionGroup.style.display = descriptionVisible ? 'block' : 'none';

        // Render custom fields if available and wait for them to load
        if (typeof renderCustomFieldInputs === 'function') {
            try {
                await renderCustomFieldInputs('customFieldsContainer', {}, team);
            } catch (e) {
                console.error('Failed to render custom fields before showing modal', e);
            }
        }

        const modal = new bootstrap.Modal(document.getElementById('createTaskModal'));
        modal.show();
    }


    // ================= EDIT TASK MODAL =================

    function openEditTaskModal(taskId) {
        const team = window.currentTeamName;
        // Fetch task details
        fetch(`/Tasks/GetTask?id=${taskId}`)
            .then(res => {
                if (!res.ok) throw new Error("Failed to load task details");
                return res.json();
            })
            .then(task => {
                // Populate Modal
                document.getElementById('editTaskId').value = task.id;
                document.getElementById('editTaskTitle').value = task.title;
                document.getElementById('editTaskDescription').value = task.description || "";
                document.getElementById('editTaskPriority').value = task.priority;
                document.getElementById('editTaskAssignedTo').value = task.assignedToUserId || "";
                document.getElementById('editTaskDueDate').value = task.dueDate || "";

                // Show Modal
                const board = document.getElementById('kanbanBoard');
                const showOther = document.getElementById('showOtherCheckbox')?.checked !== false;

                const priorityVisible = showOther && board?.dataset.priorityVisible !== 'false';
                const dueDateVisible = showOther && board?.dataset.dueDateVisible !== 'false';
                const titleVisible = showOther && board?.dataset.titleVisible !== 'false';
                const descriptionVisible = showOther && board?.dataset.descriptionVisible !== 'false';
                
                const priorityGroup = document.getElementById('groupEditTaskPriority');
                const dueDateGroup = document.getElementById('groupEditTaskDueDate');
                const titleGroup = document.getElementById('groupEditTaskTitle');
                const descriptionGroup = document.getElementById('groupEditTaskDescription');
                
                if (priorityGroup) priorityGroup.style.display = priorityVisible ? 'block' : 'none';
                if (dueDateGroup) dueDateGroup.style.display = dueDateVisible ? 'block' : 'none';
                if (titleGroup) titleGroup.style.display = titleVisible ? 'block' : 'none';
                if (descriptionGroup) descriptionGroup.style.display = descriptionVisible ? 'block' : 'none';


                // Render custom fields if available
                if (typeof renderCustomFieldInputs === 'function') {
                    renderCustomFieldInputs('editCustomFieldsContainer', task.customFieldValues || {}, team);
                }

                if (typeof populateMoveToDropdown === 'function') {
                    populateMoveToDropdown();
                }

                new bootstrap.Modal(document.getElementById('editTaskModal')).show();
            })
            .catch(err => {
                console.error(err);
                alert("Error loading task details");
            });
    }

    // Consolidated task logic moved to tasks.js
    // openCreateTaskModal and openEditTaskModal are kept here as they are view-specific for modal initialization.

    // Functions like submitCreateTask, submitEditTask, etc. are moved to tasks.js or consolidated.
    // We only keep view-specific logic here.
</script>

<script>
    function saveFocusedTask() {
        const taskId = window.__focusedTaskId;
        if (!taskId) return;

        const title = document.getElementById('focusedTaskTitle').value;
        const desc = document.getElementById('focusedTaskDescription').value;
        const assignedTo = document.getElementById('focusedTaskAssignUser').value;

        fetch('/Tasks/UpdateTask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                taskId: taskId,
                title: title,
                description: desc,
                assignedToUserId: assignedTo
            })
        })
            .then(res => {
                if (!res.ok) throw new Error();
                loadTeamBoard(currentTeamName);
            })
            .catch(() => alert('Failed to update task'));
    }
</script>


<script>
    // deleteTask is moved to tasks.js
</script>


<script>
    // Custom field creation/management logic moved to customFields.js
</script>



<script>
    function showAssignToast(userId, assignedBy, assignedAt) {
        fetch(`/Users/GetUserInfo?userId=${userId}`)
            .then(res => res.json())
            .then(u => {
                const toast = document.createElement('div');
                toast.className = 'assign-toast';
                toast.innerHTML = `
                    Task assigned to <b>${u.userName}</b> (${u.role})<br/>
                    By ${assignedBy} at ${assignedAt}
                `;

                document.body.appendChild(toast);

                setTimeout(() => toast.remove(), 5000);
            });
    }









    // Unified assignment logic moved to tasks.js


    function enableTaskDragDrop() {

        const role = (typeof currentUserRole !== 'undefined') ? currentUserRole : 'User';

        document.querySelectorAll('.kanban-tasks').forEach(container => {
            // Skip History column task list (read-only)
            if (container.id === 'historyTasksList') return;

            if (container._taskSortable) {
                container._taskSortable.destroy();
            }

            container._taskSortable = new Sortable(container, {
                group: {
                    name: 'tasks',
                    pull: container.closest('.kanban-column')?.classList.contains('col-completed') ? false : true,
                    put: true
                },
                animation: 200,
                draggable: '.task-card',
                ghostClass: 'task-ghost',
                chosenClass: 'task-chosen',

                onMove: function (evt) {
                    const targetColumn = evt.to?.closest('.kanban-column');
                    if (!targetColumn) return true;

                    const colName = targetColumn.dataset.columnName?.toLowerCase().trim();

                    // Block: History column
                    if (colName === 'history' || targetColumn.classList.contains('col-history')) {
                        return false;
                    }

                    // Block: Non-admin to completed (unless has review permission)
                    if (colName === 'completed' && role !== 'Admin') {
                        if (!window.boardPermissions || !window.boardPermissions.canReviewTask) {
                            return false;
                        }
                    }

                    return true;
                },

                onStart: function (evt) {
                    // Mark that a drag is in progress to prevent click from firing
                    evt.item._isDragging = true;
                },

                onEnd: function (evt) {
                    // Allow click events again after a short delay
                    setTimeout(() => { evt.item._isDragging = false; }, 100);

                    // Skip if dropped in the same column
                    if (evt.from === evt.to) return;

                    const taskId = parseInt(evt.item.dataset.taskId);
                    // The task container's parent is the kanban-column
                    const targetColumnEl = evt.to.closest('.kanban-column');
                    const newColumnId = parseInt(targetColumnEl?.dataset.columnId);
                    const colName = targetColumnEl?.dataset.columnName?.toLowerCase().trim();

                    // Revalidate restrictions
                    if (colName === 'history' || (colName === 'completed' && role !== 'Admin' && (!window.boardPermissions || !window.boardPermissions.canReviewTask))) {
                        showToast(colName === 'history' ? '📋 History is read-only.' : '🔒 Only authorized reviewers or admins can move tasks to Completed.', 'warning');
                        loadTeamBoard(currentTeamName);
                        return;
                    }

                    if (!taskId || !newColumnId) return;

                    // ✅ Update count badges immediately after drag
                    updateColumnCounts();

                    // ✅ Hide/Show buttons immediately without reload
                    const assignBtn = evt.item.querySelector('.action-btn-assign');
                    const editBtn = evt.item.querySelector('.action-btn-edit');
                    const reviewBtn = evt.item.querySelector('.action-btn-review');
                    const archiveBtn = evt.item.querySelector('.action-btn-archive');

                    const isReview = colName === 'review';
                    const isCompleted = colName === 'completed';
                    const isRestricted = isReview || isCompleted;

                    // Assign/Edit: Hide in Review/Completed
                    if (assignBtn) assignBtn.style.display = isRestricted ? 'none' : 'inline-flex';
                    if (editBtn) editBtn.style.display = isRestricted ? 'none' : 'inline-flex';

                    // Review: Only show in Review column
                    if (reviewBtn) reviewBtn.style.display = isReview ? 'inline-flex' : 'none';

                    // Archive: Only show in Completed column
                    if (archiveBtn) archiveBtn.style.display = isCompleted ? 'inline-flex' : 'none';

                    // ✅ Update Review Badges (Pending/Pass/Fail)
                    const pendingBadge = evt.item.querySelector('.review-badge-pending');
                    const failBadge = evt.item.querySelector('.review-badge-fail');
                    const passBadge = evt.item.querySelector('.review-badge-pass');

                    if (isReview) {
                        // Moving TO Review column: Always resets to Pending on server
                        if (pendingBadge) pendingBadge.style.display = 'inline-flex';
                        if (failBadge) failBadge.style.display = 'none';
                        if (passBadge) passBadge.style.display = 'none';
                    } else if (colName !== 'completed') {
                        // Moving OUT of Review (and not to completed): Hide pending
                        if (pendingBadge) pendingBadge.style.display = 'none';
                    }

                    updateTaskColumn(taskId, newColumnId, evt.from);
                }
            });
        });
    }



    function updateTaskColumn(taskId, columnId, fromContainer) {
        fetch('/Tasks/MoveTask', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                taskId: taskId,
                columnId: columnId
            })
        })
            .then(res => {
                if (!res.ok) {
                    return res.text().then(t => { 
                        throw new Error(t || 'Failed to move task'); 
                    });
                }
                return res.json();
            })
            .then(data => {
                if (typeof showToast === 'function') {
                    showToast('✅ Task moved successfully!', 'success');
                }
            })
            .catch(err => {
                if (typeof showToast === 'function') {
                    // Use server message "you have not acess to move" if provided
                    const msg = err.message.includes("acess") ? "❌ " + err.message : "⚠ " + err.message;
                    showToast(msg, 'danger');
                }

                // REVERT UI WITHOUT RELOAD
                if (fromContainer) {
                    const card = document.querySelector(`.task-card[data-task-id="${taskId}"]`);
                    if (card) {
                        fromContainer.appendChild(card);
                        updateColumnCounts();
                    }
                } else {
                    // Fallback to reload if container reference is lost
                    if (typeof loadTeamBoard === 'function' && window.currentTeamName) {
                        loadTeamBoard(window.currentTeamName);
                    }
                }
            });
    }

    // ✅ Helper to update column counts dynamically
    function updateColumnCounts() {
        document.querySelectorAll('.kanban-column').forEach(col => {
            const count = col.querySelectorAll('.kanban-tasks .task-card:not(.d-none)').length;
            const badge = col.querySelector('.task-count-badge');
            if (badge) badge.textContent = count;
        });
    }

    function deleteProject(id, name) {
        if (!confirm(`Delete project '${name}' and all its contents? This cannot be undone.`)) return;

        fetch('/Project/DeleteProject', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(id)
        })
            .then(res => {
                if (!res.ok) throw new Error('Failed to delete project');
                loadProjectList();
                // clear board if deleted project was active
                const boardContainer = document.getElementById('taskBoardContainer');
                boardContainer.innerHTML = '';
            })
            .catch(err => alert(err.message));
    }

    function filterBoardTasks() {
        const searchText = document.getElementById('taskSearchInput')?.value.toLowerCase() || "";
        const priorityFilter = document.getElementById('priorityFilter')?.value || "";
        const assigneeFilter = document.getElementById('assigneeFilter')?.value || "";
        const adminFilter = document.getElementById('adminAssignedFilter')?.value || "";

        const cards = document.querySelectorAll('.task-card');

        cards.forEach(card => {
            // 1. Search Text (Title, Description, Custom Fields)
            const title = card.querySelector('.task-title-text')?.innerText.toLowerCase() || "";
            const desc = card.querySelector('.task-desc-text')?.innerText.toLowerCase() || "";
            const customFields = card.querySelector('.custom-fields-summary')?.innerText.toLowerCase() || "";

            const matchesSearch = !searchText ||
                title.includes(searchText) ||
                desc.includes(searchText) ||
                customFields.includes(searchText);

            // 2. Priority
            const cardPriority = card.dataset.priority || "";
            const matchesPriority = !priorityFilter || cardPriority === priorityFilter;

            // 3. Assignee
            const cardAssigneeId = card.dataset.assignedToId || "";
            const matchesAssignee = !assigneeFilter || cardAssigneeId === assigneeFilter;

            // 4. Filter by Assignor
            const cardAssignorId = card.dataset.assignedByUserId || "";
            const currentAssigneeId = card.dataset.assignedToId || "";
            const rolesMap = window.userRolesMap || {};
            const myId = window.currentUserId || "";
            const myRole = rolesMap[myId] || "";

            let matchesAssignor = true;
            if (adminFilter && adminFilter !== "All" && adminFilter !== "") {
                const selectedAssignorId = adminFilter;
                const selectedAssignorRole = rolesMap[selectedAssignorId] || "";

                if (myRole === "Admin") {
                    // Admin sees tasks assigned BY the selected user
                    matchesAssignor = (cardAssignorId === selectedAssignorId);
                }
                else if (myRole === "Manager") {
                    if (selectedAssignorRole === "Admin") {
                        // Manager sees tasks assigned BY Admin TO them
                        matchesAssignor = (cardAssignorId === selectedAssignorId && currentAssigneeId === myId);
                    } else {
                        // Manager sees tasks assigned BY the selected user (themselves or other managers)
                        matchesAssignor = (cardAssignorId === selectedAssignorId);
                    }
                }
                else if (myRole === "Sub-Manager") {
                    if (selectedAssignorRole === "Admin" || selectedAssignorRole === "Manager") {
                        // Sub-Manager sees tasks assigned BY higher roles TO them
                        matchesAssignor = (cardAssignorId === selectedAssignorId && currentAssigneeId === myId);
                    } else {
                        // Sub-Manager sees tasks assigned BY the selected user (could be another Sub-Manager)
                        matchesAssignor = (cardAssignorId === selectedAssignorId);
                    }
                }
                else { // Regular User
                    // User sees tasks assigned TO them by the selected assignor
                    matchesAssignor = (cardAssignorId === selectedAssignorId && currentAssigneeId === myId);
                }
            }

            // Combine all
            if (matchesSearch && matchesPriority && matchesAssignee && matchesAssignor) {
                card.style.display = "block";
                card.classList.remove('d-none');
            } else {
                card.style.display = "none";
                card.classList.add('d-none');
            }
        });

        // ✅ Update the count badges to reflect the current filtered view
        updateColumnCounts();
    }

    // ===== PERSISTENT FIELD SETTINGS (Title, Description, etc.) =====
    const EMS_FIELD_SETTINGS = 'EMS_Field_Settings';

    function getFieldSettings() {
        const settings = localStorage.getItem(EMS_FIELD_SETTINGS);
        return settings ? JSON.parse(settings) : { hidden: [], names: {} };
    }

    function saveFieldSettings(settings) {
        localStorage.setItem(EMS_FIELD_SETTINGS, JSON.stringify(settings));
    }

    function applyFieldSettings() {
        const settings = getFieldSettings();
        console.log("Applying field settings:", settings);
        
        // Apply hidden states
        (settings.hidden || []).forEach(groupId => {
            const el = document.getElementById(groupId);
            if (el) el.style.display = 'none';
        });

        // Apply custom names
        for (const [labelId, name] of Object.entries(settings.names || {})) {
            const el = document.getElementById(labelId);
            if (el) {
                const isRequired = el.textContent.includes('*');
                el.textContent = name + (isRequired ? ' *' : '');
            }
        }
    }

    function renameField(labelId) {
        const labelEl = document.getElementById(labelId);
        if (!labelEl) return;
        const currentName = labelEl.textContent.replace(' *', '').trim();
        const newName = prompt("Rename field:", currentName);
        
        if (newName !== null && newName.trim() !== "" && newName !== currentName) {
            const name = newName.trim();
            const isRequired = labelEl.textContent.includes('*');
            labelEl.textContent = name + (isRequired ? ' *' : '');

            // Persist
            const settings = getFieldSettings();
            settings.names[labelId] = name;
            saveFieldSettings(settings);
        }
    }

    function hideField(groupId) {
        if (!confirm("Are you sure you want to delete this field from view? This will be saved in your browser.")) return;
        const groupEl = document.getElementById(groupId);
        if (groupEl) {
            groupEl.style.display = 'none';

            // Persist
            const settings = getFieldSettings();
            if (!settings.hidden.includes(groupId)) {
                settings.hidden.push(groupId);
            }
            saveFieldSettings(settings);
        }
    }

    // Call on load
    document.addEventListener('DOMContentLoaded', function() {
        applyFieldSettings();
    });

    function getCsrfToken() {
        const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
        return tokenInput ? tokenInput.value : '';
    }

    // ═══════════════════════════════════════════════════════
    //  EXCEL IMPORT — JAVASCRIPT
    // ═══════════════════════════════════════════════════════

    let _excelFile = null;
    let _previewData = null;

    function openExcelImportModal(teamName) {
        document.getElementById('importTeamName').value = teamName;
        resetExcelImport();

        // Populate target column dropdown from board columns
        const colSelect = document.getElementById('importTargetColumn');
        colSelect.innerHTML = '';
        const columns = document.querySelectorAll('#kanbanBoard .kanban-column[data-column-id]');
        columns.forEach(col => {
            const colId = col.getAttribute('data-column-id');
            const colName = col.getAttribute('data-column-name');
            if (colId && colId !== 'history' && colName) {
                const opt = document.createElement('option');
                opt.value = colId;
                opt.textContent = colName;
                colSelect.appendChild(opt);
            }
        });

        const modal = new bootstrap.Modal(document.getElementById('excelImportModal'));
        modal.show();
    }

    function switchImportTab(tab) {
        document.querySelectorAll('#importTabs .nav-link').forEach(btn => {
            btn.classList.toggle('active', btn.getAttribute('data-tab') === tab);
        });
        document.querySelectorAll('.import-tab-content').forEach(el => el.classList.add('d-none'));
        document.getElementById('importTab-' + tab).classList.remove('d-none');

        if (tab === 'history') {
            loadImportHistory();
        }
    }

    function resetExcelImport() {
        _excelFile = null;
        _previewData = null;

        // Reset file input
        const fileInput = document.getElementById('excelFileInput');
        if (fileInput) fileInput.value = '';

        // Show upload, hide others
        showStep('excelUploadStep');
        hideStep('excelPreviewStep');
        hideStep('excelProgressStep');
        hideStep('excelResultStep');

        // Reset file info
        document.getElementById('excelFileInfo').classList.add('d-none');
        document.getElementById('excelDropZone').style.display = '';

        // Reset buttons
        document.getElementById('btnPreviewExcel').classList.add('d-none');
        document.getElementById('btnStartImport').classList.add('d-none');
        document.getElementById('btnImportMore').classList.add('d-none');

        // Reset tab
        switchImportTab('upload');
    }

    function showStep(stepId) {
        document.getElementById(stepId).classList.remove('d-none');
    }
    function hideStep(stepId) {
        document.getElementById(stepId).classList.add('d-none');
    }

    // ─── Drag & Drop ───
    function handleExcelDragOver(e) {
        e.preventDefault();
        e.stopPropagation();
        document.getElementById('excelDropZone').classList.add('drag-over');
    }
    function handleExcelDragLeave(e) {
        e.preventDefault();
        e.stopPropagation();
        document.getElementById('excelDropZone').classList.remove('drag-over');
    }
    function handleExcelDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        document.getElementById('excelDropZone').classList.remove('drag-over');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            processExcelFile(files[0]);
        }
    }
    function handleExcelFileSelect(input) {
        if (input.files.length > 0) {
            processExcelFile(input.files[0]);
        }
    }

    function processExcelFile(file) {
        const ext = file.name.split('.').pop().toLowerCase();
        if (ext !== 'xlsx' && ext !== 'xls') {
            showToast('Only .xlsx and .xls files are supported', 'danger');
            return;
        }
        _excelFile = file;

        // Show file info
        document.getElementById('excelDropZone').style.display = 'none';
        document.getElementById('excelFileInfo').classList.remove('d-none');
        document.getElementById('excelFileName').textContent = file.name;
        document.getElementById('excelFileSize').textContent = formatFileSize(file.size);

        // Show preview button
        document.getElementById('btnPreviewExcel').classList.remove('d-none');
    }

    function clearExcelFile() {
        _excelFile = null;
        document.getElementById('excelDropZone').style.display = '';
        document.getElementById('excelFileInfo').classList.add('d-none');
        document.getElementById('btnPreviewExcel').classList.add('d-none');
        const fileInput = document.getElementById('excelFileInput');
        if (fileInput) fileInput.value = '';
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // ─── Preview ───
    async function previewExcelFile() {
        if (!_excelFile) return;

        const btn = document.getElementById('btnPreviewExcel');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Analyzing...';

        const formData = new FormData();
        formData.append('file', _excelFile);
        formData.append('teamName', document.getElementById('importTeamName').value);

        try {
            const response = await fetch('/ExcelImport/Preview', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (!data.success) {
                showToast(data.message || 'Preview failed', 'danger');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-eye me-1"></i> Preview Data';
                return;
            }

            _previewData = data;

            // Update stats
            document.getElementById('previewTotalRows').textContent = data.totalRows;
            document.getElementById('previewTotalCols').textContent = data.totalColumns;

            // Populate column mapping dropdowns
            populateMappingDropdowns(data.headers);

            // Build preview table
            buildPreviewTable(data.headers, data.sampleRows);

            // Switch to preview step
            hideStep('excelUploadStep');
            showStep('excelPreviewStep');

            // Show import button
            btn.classList.add('d-none');
            const importBtn = document.getElementById('btnStartImport');
            importBtn.classList.remove('d-none');
            document.getElementById('btnImportCount').textContent = data.totalRows;

        } catch (err) {
            showToast('Error previewing file: ' + err.message, 'danger');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-eye me-1"></i> Preview Data';
        }
    }

    function populateMappingDropdowns(headers) {
        const titleSel = document.getElementById('mappingTitleCol');
        const descSel = document.getElementById('mappingDescCol');

        titleSel.innerHTML = '<option value="-1">Auto (first column)</option>';
        descSel.innerHTML = '<option value="-1">None</option>';

        headers.forEach((h, i) => {
            titleSel.innerHTML += `<option value="${i}">${h}</option>`;
            descSel.innerHTML += `<option value="${i}">${h}</option>`;
        });
    }

    function buildPreviewTable(headers, rows) {
        const thead = document.getElementById('previewTableHead');
        const tbody = document.getElementById('previewTableBody');

        // Header
        let headerHtml = '<tr>';
        headerHtml += '<th class="text-center" style="width: 30px;">#</th>';
        headers.forEach(h => {
            headerHtml += `<th>${escapeHtml(h)}</th>`;
        });
        headerHtml += '</tr>';
        thead.innerHTML = headerHtml;

        // Body
        let bodyHtml = '';
        rows.forEach((row, ri) => {
            bodyHtml += '<tr>';
            bodyHtml += `<td class="text-center text-muted">${ri + 1}</td>`;
            row.forEach(cell => {
                bodyHtml += `<td title="${escapeHtml(cell)}">${escapeHtml(cell)}</td>`;
            });
            bodyHtml += '</tr>';
        });
        tbody.innerHTML = bodyHtml;
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ─── Import ───
    async function startExcelImport() {
        if (!_excelFile || !_previewData) return;

        const teamName = document.getElementById('importTeamName').value;
        const columnId = document.getElementById('importTargetColumn').value;
        const titleCol = document.getElementById('mappingTitleCol').value;
        const descCol = document.getElementById('mappingDescCol').value;

        if (!columnId) {
            showToast('Please select a target column', 'warning');
            return;
        }

        // Switch to progress step
        hideStep('excelPreviewStep');
        showStep('excelProgressStep');
        document.getElementById('btnStartImport').classList.add('d-none');

        // Animate progress
        const progressBar = document.getElementById('importProgressBar');
        const progressText = document.getElementById('importProgressText');

        let fakeProgress = 0;
        const progressInterval = setInterval(() => {
            if (fakeProgress < 90) {
                fakeProgress += Math.random() * 3;
                progressBar.style.width = Math.min(fakeProgress, 90) + '%';
                progressText.textContent = `Processing... ${Math.floor(fakeProgress)}%`;
            }
        }, 500);

        const formData = new FormData();
        formData.append('file', _excelFile);
        formData.append('teamName', teamName);
        formData.append('columnId', columnId);
        if (titleCol !== '-1') formData.append('titleColumnIndex', titleCol);
        if (descCol !== '-1') formData.append('descriptionColumnIndex', descCol);

        try {
            const response = await fetch('/ExcelImport/Import', {
                method: 'POST',
                body: formData
            });

            clearInterval(progressInterval);
            progressBar.style.width = '100%';
            progressText.textContent = 'Complete!';

            const data = await response.json();

            // Wait a moment then show results
            setTimeout(() => {
                showImportResults(data, response.ok);
            }, 500);

        } catch (err) {
            clearInterval(progressInterval);
            showImportResults({
                success: false,
                message: 'Network error: ' + err.message,
                successCount: 0,
                errorCount: 0,
                durationMs: 0
            }, false);
        }
    }

    function showImportResults(data, isOk) {
        hideStep('excelProgressStep');
        showStep('excelResultStep');

        // Show appropriate icon
        document.getElementById('resultIconSuccess').classList.add('d-none');
        document.getElementById('resultIconPartial').classList.add('d-none');
        document.getElementById('resultIconFail').classList.add('d-none');

        if (data.success && data.errorCount === 0) {
            document.getElementById('resultIconSuccess').classList.remove('d-none');
        } else if (data.success && data.errorCount > 0) {
            document.getElementById('resultIconPartial').classList.remove('d-none');
        } else {
            document.getElementById('resultIconFail').classList.remove('d-none');
        }

        // Stats
        document.getElementById('resultSuccessCount').textContent = data.successCount || 0;
        document.getElementById('resultErrorCount').textContent = data.errorCount || 0;
        document.getElementById('resultDuration').textContent =
            data.durationMs ? (data.durationMs / 1000).toFixed(1) + 's' : '—';
        document.getElementById('resultMessage').textContent = data.message || '';

        // Errors
        if (data.errors && data.errors.length > 0) {
            document.getElementById('resultErrors').classList.remove('d-none');
            document.getElementById('resultErrorList').innerHTML =
                data.errors.map(e => `<div class="mb-1">${escapeHtml(e)}</div>`).join('');
        } else {
            document.getElementById('resultErrors').classList.add('d-none');
        }

        // Show import more button
        document.getElementById('btnImportMore').classList.remove('d-none');

        // Reload the board to show new tasks
        if (data.success) {
            const teamName = document.getElementById('importTeamName').value;
            if (teamName && typeof loadTeamBoard === 'function') {
                setTimeout(() => loadTeamBoard(teamName), 1000);
            }
        }
    }

    // ─── Import History ───
    async function loadImportHistory() {
        const teamName = document.getElementById('importTeamName').value;
        const container = document.getElementById('importHistoryContent');

        container.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="text-muted mt-2">Loading import history...</p>
            </div>
        `;

        try {
            const response = await fetch(`/ExcelImport/History?teamName=${encodeURIComponent(teamName)}`);
            const data = await response.json();

            if (!data.success || !data.logs || data.logs.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-inbox text-muted" style="font-size: 2.5rem;"></i>
                        <p class="text-muted mt-2">No imports yet for this board.</p>
                    </div>
                `;
                return;
            }

            let html = '';
            data.logs.forEach(log => {
                const statusClass = log.status === 'Completed' ? 'text-success' :
                    log.status === 'Failed' ? 'text-danger' : 'text-warning';
                const statusIcon = log.status === 'Completed' ? 'bi-check-circle-fill' :
                    log.status === 'Failed' ? 'bi-x-circle-fill' : 'bi-exclamation-triangle-fill';

                html += `
                    <div class="import-history-card">
                        <div class="d-flex align-items-center gap-3">
                            <i class="bi bi-file-earmark-excel-fill text-success fs-4"></i>
                            <div>
                                <div class="fw-bold">${escapeHtml(log.fileName)}</div>
                                <small class="text-muted">
                                    ${log.importedAt} · by ${escapeHtml(log.importedBy)} · 
                                    into <strong>${escapeHtml(log.columnName)}</strong>
                                </small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <div class="text-center">
                                <div class="fw-bold text-success">${log.successCount}</div>
                                <small class="text-muted">OK</small>
                            </div>
                            <div class="text-center">
                                <div class="fw-bold text-danger">${log.errorCount}</div>
                                <small class="text-muted">Err</small>
                            </div>
                            <div class="text-center">
                                <div class="fw-bold text-info">${log.durationMs ? (log.durationMs / 1000).toFixed(1) + 's' : '—'}</div>
                                <small class="text-muted">Time</small>
                            </div>
                            <span class="${statusClass}"><i class="bi ${statusIcon}"></i></span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

        } catch (err) {
            container.innerHTML = `
                <div class="text-center py-4 text-danger">
                    <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                    <p class="mt-2">Error loading history: ${escapeHtml(err.message)}</p>
                </div>
            `;
        }
    }

    function toggleTeamItem(id) {
        const el = document.getElementById(id);
        if (!el) return;
        
        if (el.style.display === 'none') {
            el.style.display = 'block';
        } else {
            el.style.display = 'none';
        }
    }
</script>

<script>
// Function to clear all tasks in a specific column
async function clearColumnTasks(columnId) {
    if (!confirm('Are you sure you want to permanently delete ALL tasks in this column? This action cannot be undone.')) {
        return;
    }

    try {
        const resp = await fetch('/Tasks/DeleteAllTasksInColumn', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
            },
            body: JSON.stringify(columnId)
        });

        if (!resp.ok) {
            const txt = await resp.text();
            throw new Error(txt || 'Failed to clear tasks');
        }

        const res = await resp.json();
        if (typeof showToast === 'function') {
            showToast(`✅ Successfully deleted ${res.count} tasks`, 'success');
        }

        // Refresh board
        if (typeof loadTeamBoard === 'function' && window.currentTeamName) {
            loadTeamBoard(window.currentTeamName);
        }
    } catch (err) {
        console.error(err);
        if (typeof showToast === 'function') {
            showToast(err.message, 'danger');
        } else {
            alert(err.message);
        }
    }
}
</script>

<!-- MOVE REQUEST MODAL (Requester) -->
<div class="modal fade" id="submitMoveRequestModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold"><i class="bi bi-send-fill me-2 text-primary"></i>Request Task Move</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="moveReqTaskId" />
                <div class="mb-3">
                    <label class="form-label fw-bold">Task</label>
                    <div id="moveReqTaskTitle" class="form-control-plaintext ps-2 border-start border-primary border-4 bg-light rounded"></div>
                </div>
                <div class="mb-4">
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label fw-bold small text-muted text-uppercase">From Column</label>
                            <div id="moveReqFromColName" class="p-2 border rounded bg-light fw-bold text-secondary"></div>
                        </div>
                        <div class="col-6">
                            <label class="form-label fw-bold small text-muted text-uppercase">Target Column</label>
                            <select id="moveReqToColId" class="form-select shadow-sm border-primary">
                                <!-- Populated dynamically -->
                            </select>
                        </div>
                    </div>
                </div>
                <div class="alert alert-info py-2 shadow-sm" style="font-size: 0.85rem; border-left: 4px solid #0dcaf0;">
                    <i class="bi bi-info-circle-fill me-2"></i> Your request will be sent to the board admins and managers for approval.
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary px-4 shadow-sm" onclick="confirmSubmitMoveRequest()">
                    <i class="bi bi-send-check me-1"></i> Send Request
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MOVE REQUESTS MANAGEMENT MODAL (Admin/Manager) -->
<div class="modal fade" id="moveRequestsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content shadow-lg">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title"><i class="bi bi-mailbox me-2"></i>Column Move Requests</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="moveRequestsTable">
                        <thead class="table-light text-uppercase small fw-bold text-muted">
                            <tr>
                                <th class="ps-3">Task / Requested By</th>
                                <th>Movement</th>
                                <th>Status</th>
                                <th class="text-end pe-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="moveRequestsTableBody" class="small">
                            <!-- Populated dynamically -->
                        </tbody>
                    </table>
                </div>
                <div id="moveRequestsEmptyState" class="text-center py-5 d-none">
                    <i class="bi bi-inbox text-muted display-1 opacity-25"></i>
                    <p class="text-muted mt-3 fw-bold">No move requests found.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MOVE REQUEST REPLY MODAL (Approval/Rejection) -->
<div class="modal fade" id="handleMoveRequestModal" tabindex="-1" style="z-index: 1060;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header" id="handleRequestHeader">
                <h5 class="modal-title fw-bold" id="handleRequestTitle">Handle Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="handleRequestId" />
                <input type="hidden" id="handleRequestApproved" />
                <div class="mb-3">
                    <label class="form-label fw-bold">Admin Note / Reason <span class="text-muted fw-normal">(Optional)</span></label>
                    <textarea id="handleRequestReply" class="form-control shadow-sm" rows="3" placeholder="Enter a message for the requester..."></textarea>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="handleRequestSubmitBtn" class="btn btn-primary px-4 shadow-sm" onclick="confirmHandleMoveRequest()">Confirm</button>
            </div>
        </div>
    </div>
</div>

<script src="~/js/move-requests.js"></script>

@using UserRoles.ViewModels

@model UserRoles.ViewModels.TeamBoardViewModel



@{
    ViewData["Title"] = "Tasks";
    var userTeams = ViewBag.UserTeams as List<string> ?? new List<string>();
    var isAdmin = User.IsInRole("Admin");
}

<div class="row" style="min-height:85vh;">   

    <!-- LEFT PANEL -->
    <div class="col-md-2 bg-dark text-white p-3">

        <h5 class="mb-4">Boards</h5>

        <div class="list-group list-group-flush">

            

            
            @if (isAdmin)
            {
                <!-- ================= PROJECT SECTION (NEW) ================= -->
                <button type="button"
                        class="list-group-item list-group-item-action bg-dark text-white d-flex justify-content-between align-items-center"
                        onclick="toggleProjectPanel()">
                    <span>
                        <i class="bi bi-diagram-3 me-2"></i> Project
                    </span>
                    <span id="projectArrow">▼</span>
                </button>

                <!-- Project Dropdown -->
                <div id="projectDropdown" style="display:none;">
                    <div id="projectList">
                        <!-- Dynamically loaded projects -->
                    </div>
                    <button type="button"
                            class="list-group-item list-group-item-action bg-dark text-white ps-4 text-primary"
                            onclick="openCreateProjectModal()">
                        <i class="bi bi-plus-lg me-2"></i> New Project
                    </button>
                </div>

                <!-- ================= ADMIN: TEAM TASKS ================= -->


                <button type="button"
                        class="list-group-item list-group-item-action bg-dark text-white d-flex justify-content-between align-items-center"
                        onclick="toggleTeamTasks()">
                    <span>
                        <i class="bi bi-people-fill me-2"></i> Team Tasks
                    </span>
                    <span id="teamArrow">▼</span>
                </button>

                        

                <!-- Team Tasks Dropdown -->
                <div id="teamTasksDropdown" style="display:none;">
                    <div id="adminTeamList">
                        <!-- Dynamically loaded teams -->
                    </div>
                   
                    <div class="mt-2 border-top pt-2 ps-3 pe-3">
                         <div id="addTeamInputContainer" style="display:none;" class="mb-2">
                            <input type="text" id="newTeamNameInput" 
                                   class="form-control form-control-sm" 
                                   placeholder="Enter team name..." />
                            <div class="d-flex justify-content-end mt-1">
                                <button class="btn btn-xs btn-secondary me-1" onclick="toggleAddTeamInput()">Cancel</button>
                                <button class="btn btn-xs btn-primary" onclick="submitCreateTeam()">Add</button>
                            </div>
                         </div>

                        <button type="button" 
                                class="btn btn-sm btn-outline-secondary w-100 text-start"
                                onclick="toggleAddTeamInput()">
                            <i class="bi bi-plus-circle me-2"></i> Add Team
                        </button>
                    </div>
                </div>
            }
            else
            {
                <!-- ================= USER/MANAGER: MY TEAM ================= -->
                <button type="button"
                        class="list-group-item list-group-item-action bg-dark text-white d-flex justify-content-between align-items-center"
                        onclick="toggleMyTasks()">
                    <span>
                        <i class="bi bi-kanban-fill me-2"></i> My Team
                    </span>
                    <span id="myTasksArrow">▼</span>
                </button>

                <!-- My Team Dropdown - Only shows teams assigned by Admin -->
                <div id="myTasksDropdown" style="display:none;">
                    @if (userTeams.Any())
                    {
                        @foreach (var team in userTeams)
                        {
                            var icon = team switch {
                                "Development" => "bi-code-slash",
                                "Testing" => "bi-bug-fill",
                                "Sales" => "bi-briefcase-fill",
                                _ => "bi-arrow-right-circle"
                            };
                            <button type="button"
                                    class="list-group-item list-group-item-action bg-dark text-white ps-4 team-btn"
                                    data-team="@team"
                                    onclick="loadTeamBoard('@team')">
                                <i class="bi @icon me-2"></i> @team Team
                            </button>
                        }
                    }
                    else
                    {
                        <div class="text-muted ps-4 py-2">
                            No teams assigned
                        </div>
                    }
                </div>
            }

        </div>
    </div>


    <!-- RIGHT PANEL -->
    <div class="col-md-9 p-4">
        <div id="taskBoardContainer"></div>
    </div>


    <!-- ADD COLUMN MODAL -->
    <div class="modal fade" id="addColumnModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Add Column</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" id="addColumnTeam" />

                    <div class="mb-3">
                        <label class="form-label">Column Name</label>
                        <input type="text"
                               id="newColumnName"
                               class="form-control"
                               placeholder="e.g. QA Review"
                               required />
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" id="addColumnSubmit">Add</button>
                </div>

            </div>
        </div>
    </div>


    <div class="modal fade" id="createTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Create Task</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" id="taskColumnId" />

                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" id="taskTitle" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea id="taskDescription" class="form-control"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Link to Project (optional - for auto ID)</label>
                        <select id="taskProjectId" class="form-select">
                            <option value="">-- No Project --</option>
                            <!-- Dynamically loaded -->
                        </select>
                        <small class="text-muted">Selecting a project generates an ID like P1T1, P1T2...</small>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" onclick="submitCreateTask()">Create</button>
                </div>

            </div>
        </div>
    </div>

    
    <div class="modal fade" id="assignTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Assign Task</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" id="assignTaskId" />

                    <label class="form-label">Assign to</label>
                    <select id="assignUserSelect" class="form-select">
                        <option value="">-- Select User --</option>

                        @if (Model != null && Model.AssignableUsers != null && Model.AssignableUsers.Any())
                        {
                            foreach (var u in Model.AssignableUsers)
                            {
                                <option value="@u.Id">@u.UserName</option>
                            }
                        }
                        else
                        {
                            <option disabled>No users available</option>
                        }



                    </select>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button class="btn btn-primary" onclick="assignTask()">
                        Assign
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- CREATE PROJECT MODAL -->
    <div class="modal fade" id="createProjectModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-folder-plus me-2"></i>Create Project</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Project Name</label>
                        <input type="text" id="newProjectName" class="form-control" placeholder="Enter project name" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description (optional)</label>
                        <textarea id="newProjectDescription" class="form-control" rows="3" placeholder="Project description"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" onclick="submitCreateProject()">Create Project</button>
                </div>
            </div>
        </div>
    </div>


</div>



<style>


    .list-group-item {
        border: none;
    }

    .team-btn.active {
        background-color: #0d6efd;
        color: #fff;
    }


        .assign-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #198754;
            color: white;
            padding: 14px 18px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,.25);
            z-index: 9999;
            font-size: 14px;
        }

</style>


<script>
    function toggleTeamTasks() {
        const dropdown = document.getElementById("teamTasksDropdown");
        const arrow = document.getElementById("teamArrow");

        if (dropdown.style.display === "none") {
            dropdown.style.display = "block";
            arrow.innerText = "▲";
        } else {
            dropdown.style.display = "none";
            arrow.innerText = "▼";
        }
    }


    function toggleMyTasks() {
        const dropdown = document.getElementById("myTasksDropdown");
        const arrow = document.getElementById("myTasksArrow");

        if (!dropdown) return;

        const isOpen = dropdown.style.display === "block";
        dropdown.style.display = isOpen ? "none" : "block";
        arrow.innerText = isOpen ? "▼" : "▲";
    }

    // ===== PROJECT PANEL =====
    function toggleProjectPanel() {
        const dropdown = document.getElementById("projectDropdown");
        const arrow = document.getElementById("projectArrow");

        if (!dropdown) return;

        const isOpen = dropdown.style.display === "block";
        dropdown.style.display = isOpen ? "none" : "block";
        arrow.innerText = isOpen ? "▼" : "▲";

        if (!isOpen) {
            loadProjectList();
        }
    }

    function loadProjectList() {
        fetch('/Project/GetProjects')
            .then(res => res.json())
            .then(projects => {
                const container = document.getElementById('projectList');
                if (projects.length === 0) {
                    container.innerHTML = '<div class="text-muted ps-4 py-2">No projects yet</div>';
                    return;
                }

                container.innerHTML = projects.map(p => `
                    <div class="d-flex align-items-center justify-content-between group-hover-container px-0">
                        <button type="button"
                                class="list-group-item list-group-item-action bg-dark text-white project-btn flex-grow-1 text-start border-0 py-2 ps-4"
                                data-project-id="${p.id}"
                                onclick="loadProjectBoard(${p.id})">
                            <i class="bi bi-folder2 me-2"></i> ${p.name}
                        </button>
                        <button class="btn btn-sm btn-link text-danger p-0 me-2" 
                                style="opacity:0.5;"
                                onmouseover="this.style.opacity=1"
                                onmouseout="this.style.opacity=0.5"
                                onclick="event.stopPropagation(); deleteProject(${p.id}, '${p.name}')" 
                                title="Delete Project">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `).join('');
            })
            .catch(() => {
                document.getElementById('projectList').innerHTML = 
                    '<div class="text-danger ps-4 py-2">Failed to load</div>';
            });
    }

    function loadProjectBoard(projectId) {
        const container = document.getElementById('taskBoardContainer');
        container.innerHTML = "<div class='text-muted p-3'>Loading project...</div>";

        // Clear team button highlights
        document.querySelectorAll('.team-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.project-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`[data-project-id="${projectId}"]`)?.classList.add('active');

        fetch(`/Project/Board/${projectId}`)
            .then(res => {
                if (!res.ok) throw new Error("Failed to load project board");
                return res.text();
            })
            .then(html => {
                container.innerHTML = html;
                
                // Execute scripts from the dynamically loaded content
                const scripts = container.querySelectorAll('script');
                scripts.forEach(script => {
                    const newScript = document.createElement('script');
                    if (script.src) {
                        newScript.src = script.src;
                    } else {
                        newScript.textContent = script.textContent;
                    }
                    document.body.appendChild(newScript);
                    // Remove after execution to avoid duplicates
                    setTimeout(() => newScript.remove(), 100);
                });
            })
            .catch(err => {
                container.innerHTML = "<div class='text-danger'>Error loading project</div>";
                console.error(err);
            });
    }

    function openCreateProjectModal() {
        document.getElementById('newProjectName').value = '';
        document.getElementById('newProjectDescription').value = '';
        new bootstrap.Modal(document.getElementById('createProjectModal')).show();
    }

    function submitCreateProject() {
        const data = {
            name: document.getElementById('newProjectName').value.trim(),
            description: document.getElementById('newProjectDescription').value.trim()
        };

        if (!data.name) {
            alert('Project name is required');
            return;
        }

        fetch('/Project/CreateProject', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(res => {
            if (!res.ok) throw new Error('Failed to create project');
            return res.json();
        })
        .then(result => {
            bootstrap.Modal.getInstance(document.getElementById('createProjectModal'))?.hide();
            loadProjectList();
            loadProjectBoard(result.id);
        })
        .catch(err => alert(err.message));
    }
</script>

<script>
    // expose admin flag to JS as boolean
    const __isTasksAdmin = @((isAdmin).ToString().ToLower());

    // ===== ADMIN TEAM MANAGEMENT =====

    function toggleAddTeamInput() {
        const container = document.getElementById('addTeamInputContainer');
        const input = document.getElementById('newTeamNameInput');
        
        if (container.style.display === 'none') {
            container.style.display = 'block';
            input.value = '';
            input.focus();
            
            // Enter key to submit
            input.onkeydown = function(e) {
                if(e.key === 'Enter') submitCreateTeam();
            };
        } else {
            container.style.display = 'none';
        }
    }

    function submitCreateTeam() {
        const input = document.getElementById('newTeamNameInput');
        const name = input.value.trim();
        
        if (!name) {
             toggleAddTeamInput();
             return;
        }

        fetch('/Teams/Create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ Name: name })
        })
        .then(res => {
            if(!res.ok) return res.text().then(t => { throw new Error(t); });
            return res.json();
        })
        .then(() => {
            toggleAddTeamInput();
            loadAdminTeamList(); // Refresh list
        })
        .catch(err => {
            console.error(err);
            alert('Failed to add team: ' + err.message);
        });
    }

    function loadAdminTeamList() {
        const container = document.getElementById('adminTeamList');
        if(!container) return;

        fetch('/Teams/GetAll')
        .then(res => res.json())
        .then(teams => {
            if(teams.length === 0) {
                 container.innerHTML = '<div class="text-muted ps-4 py-2 small">No teams found</div>';
                 return;
            }

            container.innerHTML = teams.map(t => `
               <div class="d-flex align-items-center justify-content-between group-hover-container px-0">
                    <button type="button"
                            class="list-group-item list-group-item-action bg-dark text-white team-btn flex-grow-1 text-start border-0 py-2 ps-4"
                            data-team="${t.name}"
                            onclick="loadTeamBoard('${t.name}')">
                        <i class="bi bi-people me-2"></i> ${t.name}
                    </button>
                    
                    <button class="btn btn-sm btn-link text-danger p-0 me-2" 
                            style="opacity:0.5;"
                            onmouseover="this.style.opacity=1"
                            onmouseout="this.style.opacity=0.5"
                            onclick="deleteTeam(${t.id}, '${t.name}')" 
                            title="Delete Team">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `).join('');
            
            // Re-highlight if needed
            if(typeof currentTeamName !== 'undefined') {
                 document.querySelectorAll(`.team-btn[data-team="${currentTeamName}"]`)
                         .forEach(b => b.classList.add('active'));
            }
        });
    }

    function deleteTeam(id, name) {
        if(!confirm(`Delete team '${name}'? This cannot be undone.`)) return;

        fetch('/Teams/Delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(id)
        })
        .then(res => {
             if(!res.ok) throw new Error('Failed to delete');
             loadAdminTeamList();
             // clear board if deleted team was active
             const boardContainer = document.getElementById('taskBoardContainer');
             boardContainer.innerHTML = '';
        })
        .catch(err => alert(err.message));
    }

    // Load initially if Admin
    document.addEventListener('DOMContentLoaded', function() {
        if(__isTasksAdmin) {
            loadAdminTeamList();
        }
    });

    // open add column modal (admin only)
    function openAddColumnModal(teamName) {
        if (!__isTasksAdmin) return;
        document.getElementById("addColumnTeam").value = teamName;
        document.getElementById("newColumnName").value = "";

        const modal = new bootstrap.Modal(document.getElementById("addColumnModal"));
        modal.show();
    }

    // save new column (admin only)
    document.getElementById('addColumnSubmit')?.addEventListener('click', function () {
        if (!__isTasksAdmin) return;
        const team = document.getElementById('addColumnTeam').value;
        const columnName = document.getElementById('newColumnName').value.trim();
        if (!columnName) { alert('Column name is required'); return; }

        fetch('/Tasks/AddColumn', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ team: team, columnName: columnName })
        })
            .then(res => { if (!res.ok) throw new Error('Failed'); return res.text(); })
            .then(() => {
                bootstrap.Modal.getInstance(document.getElementById('addColumnModal'))?.hide();
                // reload the board for the team
                loadTeamBoard(team);
            })
            .catch(() => alert('Failed to add column'));
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script>
           function enableColumnDrag() {
        if (!__isTasksAdmin) return;

        const board = document.querySelector('#kanbanBoard');
        if (!board) {
            console.warn('Kanban board not found');
            return;
        }

        // 🔥 SAFETY: remove old sortable safely
        if (board._sortableInstance) {
            board._sortableInstance.destroy();
            board._sortableInstance = null;
        }

           board._sortableInstance = new Sortable(board, {
        animation: 150,
        direction: 'horizontal',
        draggable: '.kanban-column',

        // 🔥 THIS IS THE FIX
        handle: '.column-drag-handle',

        onEnd: function () {
            const columnIds = Array.from(
                board.querySelectorAll('.kanban-column')
            ).map(c => parseInt(c.dataset.columnId));

            fetch('/Tasks/ReorderColumns', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(columnIds)
            });
        }
    });

    }


        function startRename(columnId) {
            if (!__isTasksAdmin) return;
            document.getElementById(`column-title-${columnId}`).style.display = 'none';
            document.getElementById(`column-rename-${columnId}`).style.display = 'flex';
        }

        function cancelRename(columnId) {
            document.getElementById(`column-rename-${columnId}`).style.display = 'none';
            document.getElementById(`column-title-${columnId}`).style.display = 'block';
        }

        function saveColumnName(columnId) {
            if (!__isTasksAdmin) return;
            const input = document.getElementById(`column-input-${columnId}`);
            const newName = input?.value?.trim();
            if (!newName) { alert('Column name required'); return; }

            fetch('/Tasks/RenameColumn', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ columnId: columnId, name: newName })
            })
                .then(res => { if (!res.ok) throw new Error(); return res.text(); })
                .then(() => {
                    document.getElementById(`column-title-${columnId}`).innerText = newName;
                    cancelRename(columnId);
                })
                .catch(() => alert('Rename failed'));
        }

        function confirmDeleteColumn(columnId) {
            if (!__isTasksAdmin) return;
            if (!confirm('Delete this column?')) return;
            fetch('/Tasks/DeleteColumn', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ columnId }) })
                .then(res => { if (!res.ok) return res.text().then(t => { throw new Error(t); }); return res.text(); })
                .then(() => document.querySelector(`[data-column-id='${columnId}']`)?.remove())
                .catch(err => alert(err.message));
        }
    </script>

        <script>
                  function loadTeamBoard(team) {
        // ✅ SAVE CURRENT TEAM
        currentTeamName = team;

        const container = document.getElementById('taskBoardContainer');
        container.innerHTML = "<div class='text-muted p-3'>Loading...</div>";

        fetch(`/Tasks/TeamBoard?team=${encodeURIComponent(team)}`)
            .then(res => {
                if (!res.ok) throw new Error("Failed to load board");
                return res.text();
            })
            .then(html => {
                container.innerHTML = html;

                // highlight active team button
                document.querySelectorAll('.team-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll(`.team-btn[data-team]`).forEach(b => {
                    if (b.dataset.team === team) b.classList.add('active');
                });

                if (typeof enableColumnDrag === "function") {
                    enableColumnDrag();
                    enableTaskDragDrop();
                }
            })
            .catch(err => {
                container.innerHTML = "<div class='text-danger'>Error loading board</div>";
                console.error(err);
            });
    }
 

        </script>

<script>
    function focusColumn(columnId) {
        const board = document.getElementById('kanbanBoard');
        const backBtn = document.getElementById('backToBoardBtn');
        if (!board) return;

        board.classList.add('single-column-view');
        board.querySelectorAll('.kanban-column').forEach(col => {
            const id = parseInt(col.dataset.columnId);
            if (id === columnId) { col.classList.add('focused-column'); col.classList.remove('hidden-column'); }
            else { col.classList.remove('focused-column'); col.classList.add('hidden-column'); }
        });
        if (backBtn) backBtn.style.display = 'inline-block';
    }


            function focusTask(taskId) {
        taskId = parseInt(taskId);

        const board = document.getElementById('kanbanBoard');
        const backBtn = document.getElementById('backToBoardBtn');

        if (!board || isNaN(taskId)) return;

        // ✅ Enter focus mode
        board.classList.add('task-focused-view');



            window.__focusedTaskId = taskId;

    // show inputs
    // document.querySelector(`.task-title-input[data-task-id='${taskId}']`)?.classList.remove('d-none');
    // document.querySelector(`.task-desc-input[data-task-id='${taskId}']`)?.classList.remove('d-none');

    // hide static text
    // document.querySelector(`.task-title-text`)?.classList.add('d-none');
    // document.querySelector(`.task-desc-text`)?.classList.add('d-none');



        // ✅ Loop through all task cards
        board.querySelectorAll('.task-card').forEach(task => {
            const id = parseInt(task.dataset.taskId);

            if (id === taskId) {
                task.classList.add('focused-task');
                task.style.display = 'block';
            } else {
                task.style.display = 'none';
                task.classList.remove('focused-task');
            }
        });

        // ✅ Keep columns visible (layout preserved)
        board.querySelectorAll('.kanban-column').forEach(col => {
            col.style.display = 'block';
            col.classList.add('column-muted');
        });

        // ✅ Show back button
        if (backBtn) backBtn.style.display = 'inline-block';
    }


        function exitTaskFocus() {
        const board = document.getElementById('kanbanBoard');
        const backBtn = document.getElementById('backToBoardBtn');

        if (!board) return;

        // Remove focus mode
        board.classList.remove('task-focused-view');

        // Restore all tasks
        board.querySelectorAll('.task-card').forEach(task => {
            task.style.display = 'block';
            task.classList.remove('focused-task');
        });

        // Restore columns
        board.querySelectorAll('.kanban-column').forEach(col => {
            col.classList.remove('column-muted');
        });

        if (backBtn) backBtn.style.display = 'none';
    }



        function resetBoardView() {
        const board = document.getElementById('kanbanBoard');
        const backBtn = document.getElementById('backToBoardBtn');
        if (!board) return;

        // reset column focus
        board.classList.remove('single-column-view');
        board.querySelectorAll('.kanban-column').forEach(col => {
            col.classList.remove('focused-column');
            col.classList.remove('hidden-column');
            col.style.display = 'flex';
        });

        // reset task focus
        board.classList.remove('task-focused-view');
        board.querySelectorAll('.task-card').forEach(task => {
            task.classList.remove('focused-task');
            task.style.display = 'block';
        });

        if (backBtn) backBtn.style.display = 'none';
    }

</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        @if (isAdmin)
        {
            <text>
                // Admin: Auto-expand Team Tasks and load Development board
                const teamDropdown = document.getElementById('teamTasksDropdown');
                const teamArrow = document.getElementById('teamArrow');
                if (teamDropdown) teamDropdown.style.display = 'block';
                if (teamArrow) teamArrow.innerText = '▲';

                // load first team (Development)
                loadTeamBoard('Development');
            </text>
        }
        else if (userTeams.Any())
        {
            var firstTeam = userTeams.First();
            <text>
                // User: Auto-expand My Team and load first assigned team
                const myDropdown = document.getElementById('myTasksDropdown');
                const myArrow = document.getElementById('myTasksArrow');
                if (myDropdown) myDropdown.style.display = 'block';
                if (myArrow) myArrow.innerText = '▲';

                // load first team
                loadTeamBoard('@firstTeam');
            </text>
        }
    });
</script>

<script>
    function openCreateTaskModal(columnId) {
        document.getElementById('taskColumnId').value = columnId;
        document.getElementById('taskTitle').value = '';
        document.getElementById('taskDescription').value = '';

        // Load projects into dropdown
        loadProjectsForTaskModal();

        new bootstrap.Modal(document.getElementById('createTaskModal')).show();
    }

    function loadProjectsForTaskModal() {
        const select = document.getElementById('taskProjectId');
        if (!select) return;

        fetch('/Project/GetProjects')
            .then(res => res.json())
            .then(projects => {
                select.innerHTML = '<option value="">-- No Project --</option>';
                projects.forEach(p => {
                    select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                });
            })
            .catch(() => {
                select.innerHTML = '<option value="">-- No Project --</option>';
            });
    }

    function submitCreateTask() {
        const projectSelect = document.getElementById('taskProjectId');
        const projectId = projectSelect?.value ? parseInt(projectSelect.value) : null;

        const data = {
            columnId: parseInt(document.getElementById('taskColumnId').value),
            title: document.getElementById('taskTitle').value.trim(),
            description: document.getElementById('taskDescription').value.trim(),
            projectId: projectId
        };

        fetch('/Tasks/CreateTask', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(res => {
            if (!res.ok) {
                return res.text().then(t => {
                    throw new Error(t || 'Failed to create task');
                });
            }

            // ✅ SUCCESS (no JSON expected)
            const modalEl = document.getElementById('createTaskModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();

            // reload board
            loadTeamBoard(currentTeamName);
        })
        .catch(err => {
            alert(err.message || 'Failed to create task');
        });
    }
</script>

<script>
    function saveFocusedTask() {
        const taskId = window.__focusedTaskId;
        if (!taskId) return;

        const title = document.querySelector(`.task-title-input[data-task-id='${taskId}']`).value;
        const desc = document.querySelector(`.task-desc-input[data-task-id='${taskId}']`).value;
        const assignedTo = document.querySelector(`.task-assign-select[data-task-id='${taskId}']`).value;

        fetch('/Tasks/UpdateTask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                taskId: taskId,
                title: title,
                description: desc,
                assignedToUserId: assignedTo
            })
        })
        .then(res => {
            if (!res.ok) throw new Error();
            loadTeamBoard(currentTeamName);
        })
        .catch(() => alert('Failed to update task'));
    }
</script>


<script>
    function deleteTask(taskId) {
        if (!confirm('Delete this task?')) return;

            fetch('/Tasks/DeleteTask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(taskId)
    })
    .then(res => {
        if (!res.ok) throw new Error('Failed to delete');
        loadTeamBoard(currentTeamName);
    })
    .catch(err => alert(err.message));


    }
</script>


<script>
    function assignTask(taskId, userId) {
        if (!userId) return;

        fetch('/Tasks/AssignTask', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `taskId=${taskId}&userId=${userId}`
        })
        .then(res => res.json())
        .then(result => {
            showAssignToast(
                userId,
                result.assignedBy,
                result.assignedAt
            );

            loadTeamBoard(currentTeamName);
        })
        .catch(() => alert('Failed to assign task'));
    }
</script>



<script>
    function showAssignToast(userId, assignedBy, assignedAt) {
        fetch(`/Users/GetUserInfo?userId=${userId}`)
            .then(res => res.json())
            .then(u => {
                const toast = document.createElement('div');
                toast.className = 'assign-toast';
                toast.innerHTML = `
                    Task assigned to <b>${u.userName}</b> (${u.role})<br/>
                    By ${assignedBy} at ${assignedAt}
                `;

                document.body.appendChild(toast);

                setTimeout(() => toast.remove(), 5000);
            });
    }



        function enableTaskEdit(taskId) {

        // Close any other open edits (very important)
        document.querySelectorAll('.task-card.editing').forEach(card => {
            cancelTaskEdit(card.dataset.taskId);
        });

        const card = document.querySelector(`[data-task-id='${taskId}']`).closest('.task-card');
        card.classList.add('editing');

        // Toggle title
        card.querySelector('.task-title-text').classList.add('d-none');
        card.querySelector('.task-title-input').classList.remove('d-none');

        // Toggle description
        card.querySelector('.task-desc-text').classList.add('d-none');
        card.querySelector('.task-desc-input').classList.remove('d-none');

        // Toggle buttons
        card.querySelector('.edit-task-btn').classList.add('d-none');
        card.querySelector('.save-task-btn').classList.remove('d-none');
        card.querySelector('.cancel-task-btn').classList.remove('d-none');
    }


        function cancelTaskEdit(taskId) {
        const card = document.querySelector(`[data-task-id='${taskId}']`).closest('.task-card');
        card.classList.remove('editing');

        // Restore values from text
        const titleText = card.querySelector('.task-title-text').innerText;
        const descText = card.querySelector('.task-desc-text').innerText;

        card.querySelector('.task-title-input').value = titleText;
        card.querySelector('.task-desc-input').value = descText;

        // Toggle back
        card.querySelector('.task-title-text').classList.remove('d-none');
        card.querySelector('.task-title-input').classList.add('d-none');

        card.querySelector('.task-desc-text').classList.remove('d-none');
        card.querySelector('.task-desc-input').classList.add('d-none');

        card.querySelector('.edit-task-btn').classList.remove('d-none');
        card.querySelector('.save-task-btn').classList.add('d-none');
        card.querySelector('.cancel-task-btn').classList.add('d-none');
    }

        function saveTaskEdit(taskId) {

        const card = document
            .querySelector(`[data-task-id='${taskId}']`)
            ?.closest('.task-card');

        if (!card) return;

        const titleInput = card.querySelector('.task-title-input');
        const descInput = card.querySelector('.task-desc-input');

        const title = titleInput.value.trim();
        const description = descInput.value.trim();

        if (!title) {
            alert("Title cannot be empty");
            titleInput.focus();
            return;
        }

        fetch('/Tasks/UpdateTask', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                taskId: taskId,
                title: title,
                description: description
            })
        })
        .then(res => {
            if (!res.ok) throw new Error('Save failed');
            return res.json();   // ✅ now valid
        })
        .then(() => {

            // ✅ Update UI immediately
            card.querySelector('.task-title-text').innerText = title;
            card.querySelector('.task-desc-text').innerText = description;

            cancelTaskEdit(taskId);
        })
        .catch(err => {
            console.error(err);
            alert("Failed to save task");
        });
    }


        function showAssignDropdown(taskId) {

        // Hide all other assign containers
        document.querySelectorAll('.task-assign-container').forEach(c => {
            c.classList.add('d-none');
        });

        // Show current task assign UI
        const container = document.querySelector(
            `.task-assign-container[data-task-id='${taskId}']`
        );

        if (container) {
            container.classList.remove('d-none');
        }
    }

        function cancelAssignTask(taskId) {
        const container = document.querySelector(
            `.task-assign-container[data-task-id='${taskId}']`
        );

        if (container) {
            container.classList.add('d-none');
        }
    }


        function confirmAssignTask(taskId) {

        const select = document.querySelector(
            `.task-assign-select[data-task-id='${taskId}']`
        );

        if (!select || !select.value) {
            alert("Please select a user");
            return;
        }

        const userId = select.value;

        fetch('/Tasks/AssignTask', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `taskId=${taskId}&userId=${userId}`
        })
        .then(res => {
            if (!res.ok) throw new Error();
            return res.json();
        })
        .then(result => {

            // Optional toast (you already have this)
            showAssignToast(userId, result.assignedBy, result.assignedAt);

            // Hide assign UI
            cancelAssignTask(taskId);

            // Reload board to reflect assignment
            loadTeamBoard(currentTeamName);
        })
        .catch(() => alert("Failed to assign task"));
    }


                function enableTaskDragDrop() {

        document.querySelectorAll('.kanban-tasks').forEach(container => {

            if (container._taskSortable) {
                container._taskSortable.destroy();
            }

            container._taskSortable = new Sortable(container, {
                group: 'tasks',
                animation: 150,
                draggable: '.task-card',
                ghostClass: 'task-ghost',
                chosenClass: 'task-chosen',

                onEnd: function (evt) {
                    const taskId = parseInt(evt.item.dataset.taskId);
                    const newColumnId = parseInt(evt.to.dataset.columnId);

                    if (!taskId || !newColumnId) return;

                    updateTaskColumn(taskId, newColumnId);
                }
            });
        });
    }



        function updateTaskColumn(taskId, columnId) {

        fetch('/Tasks/MoveTask', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                taskId: taskId,
                columnId: columnId
            })
        })
        .then(res => {
            if (!res.ok) throw new Error('Failed to move task');
        })
        .catch(err => {
            alert(err.message);
            // reload board to recover UI
            loadTeamBoard(currentTeamName);
        });
    }

    function deleteProject(id, name) {
        if(!confirm(`Delete project '${name}' and all its contents? This cannot be undone.`)) return;

        fetch('/Project/DeleteProject', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(id)
        })
        .then(res => {
             if(!res.ok) throw new Error('Failed to delete project');
             loadProjectList();
             // clear board if deleted project was active
             const boardContainer = document.getElementById('taskBoardContainer');
             boardContainer.innerHTML = '';
        })
        .catch(err => alert(err.message));
    }

</script>



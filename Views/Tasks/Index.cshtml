@using UserRoles.ViewModels

@model UserRoles.ViewModels.TeamBoardViewModel



@{
    ViewData["Title"] = "Tasks";
    var userTeams = ViewBag.UserTeams as List<string> ?? new List<string>();
    var isAdmin = User.IsInRole("Admin");
}

<!-- MOBILE SIDEBAR OVERLAY -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<div class="app-wrapper">

    <!-- LEFT SIDEBAR -->
    <aside class="left-sidebar" id="leftSidebar">

        <h5>Boards</h5>

        <div class="list-group list-group-flush">

            @if (isAdmin)
            {
                <!-- ================= PROJECT SECTION ================= -->
                <button type="button"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                        onclick="toggleProjectPanel()">
                    <span>
                        <i class="bi bi-folder2 me-2"></i> Project
                    </span>
                    <span id="projectArrow">▼</span>
                </button>

                <div id="projectDropdown" style="display:none;">
                    <div id="projectList"></div>
                    <button type="button"
                            class="list-group-item list-group-item-action ps-4"
                         
                            onclick="openCreateProjectModal()">
                        <i class="bi bi-plus-lg me-2"></i> New Project
                    </button>
                </div>

                <!-- ================= EMPLOYEES SECTION ================= -->
                <button type="button"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                        onclick="loadEmployeesAdminPanel()">
                    <span>
                        <i class="bi bi-person-badge-fill me-2"></i> Employees
                    </span>
                </button>

                <!-- ================= TEAM TASKS ================= -->
                <button type="button"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                        onclick="toggleTeamTasks()">
                    <span>
                        <i class="bi bi-people-fill me-2"></i> Team Tasks
                    </span>
                    <span id="teamArrow">▲</span>
                </button>

                <div id="teamTasksDropdown" style="display:block;">
                    <div id="adminTeamList"></div>

                    <div class="mt-2 pt-2 px-3" style="border-top: 1px solid rgba(255,255,255,0.08);">
                        <div id="addTeamInputContainer" style="display:none;" class="mb-2">
                            <input type="text" id="newTeamNameInput"
                                   class="form-control form-control-sm bg-dark text-white border-secondary"
                                   placeholder="Enter team name..." />
                            <div class="d-flex justify-content-end mt-1 gap-1">
                                <button class="btn btn-xs btn-secondary" onclick="toggleAddTeamInput()">Cancel</button>
                                <button class="btn btn-xs btn-primary" onclick="submitCreateTeam()">Add</button>
                            </div>
                        </div>

                        <button type="button"
                                class="btn btn-sm w-100 text-start"
                                style="color: rgba(255,255,255,0.5); border: 1px dashed rgba(255,255,255,0.15);"
                                onclick="toggleAddTeamInput()">
                            <i class="bi bi-plus-circle me-2"></i> Add Team
                        </button>
                    </div>
                </div>
            }
            else
            {
                <!-- ================= USER/MANAGER: MY TEAM ================= -->
                <button type="button"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                        onclick="toggleMyTasks()">
                    <span>
                        <i class="bi bi-kanban-fill me-2"></i> My Team
                    </span>
                    <span id="myTasksArrow">▼</span>
                </button>

                <div id="myTasksDropdown" style="display:none;">
                    @if (userTeams.Any())
                    {
                        @foreach (var team in userTeams)
                        {
                            var icon = team switch {
                                "Development" => "bi-code-slash",
                                "Testing" => "bi-bug-fill",
                                "Sales" => "bi-briefcase-fill",
                                _ => "bi-arrow-right-circle"
                            };
                            <button type="button"
                                    class="list-group-item list-group-item-action ps-4 team-btn"
                                    data-team="@team"
                                    onclick="loadTeamBoard('@team')">
                                <i class="bi @icon me-2"></i> @team Team
                            </button>
                        }
                    }
                    else
                    {
                        <div class="text-muted ps-4 py-2" style="font-size: 0.825rem;">
                            No teams assigned
                        </div>
                    }
                </div>
            }

        </div>
    </aside>

    <!-- RIGHT CONTENT AREA -->
    <div class="right-content">
        <div id="taskBoardContainer"></div>
    </div>


    <!-- ═══════ JS: EXPOSE USER ROLE ═══════ -->
    <script>
        var currentUserRole = '@(User.IsInRole("Admin") ? "Admin" : User.IsInRole("Manager") ? "Manager" : User.IsInRole("Sub-Manager") ? "Sub-Manager" : "User")';
    </script>

    <!-- ═══════ REVIEW TASK MODAL (ADMIN ONLY) ═══════ -->
    <div class="modal fade" id="reviewTaskModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 16px 16px 0 0;">
                    <h5 class="modal-title text-white">
                        <i class="bi bi-clipboard-check me-2"></i>Review Task
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <input type="hidden" id="reviewTaskId" />
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Task</label>
                        <div id="reviewTaskTitle" class="form-control-plaintext fs-5 fw-semibold"></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Decision</label>
                        <div class="d-flex gap-3">
                            <div class="form-check form-check-inline flex-fill">
                                <input class="form-check-input" type="radio" name="reviewDecision" id="reviewPass" value="pass" checked>
                                <label class="form-check-label w-100 text-center py-2 rounded border review-radio-pass" for="reviewPass">
                                    <i class="bi bi-check-circle-fill text-success me-1"></i> Pass
                                </label>
                            </div>
                            <div class="form-check form-check-inline flex-fill">
                                <input class="form-check-input" type="radio" name="reviewDecision" id="reviewFail" value="fail">
                                <label class="form-check-label w-100 text-center py-2 rounded border review-radio-fail" for="reviewFail">
                                    <i class="bi bi-x-circle-fill text-danger me-1"></i> Fail
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Review Note <span class="text-muted fw-normal">(required for fail)</span></label>
                        <textarea id="reviewNote" class="form-control" rows="3" placeholder="Add your review comments..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0 px-4 pb-4">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary px-4" id="submitReviewBtn" onclick="submitReview()">
                        <i class="bi bi-send me-1"></i> Submit Review
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════ ARCHIVED TASK DETAIL MODAL ═══════ -->
    <div class="modal fade" id="archivedTaskModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
                <div class="modal-header" style="background: linear-gradient(135deg, #1a1a2e, #16213e); border-radius: 16px 16px 0 0;">
                    <h5 class="modal-title text-white">
                        <i class="bi bi-archive me-2"></i>Archived Task Overview
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4" id="archivedTaskBody">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ADD COLUMN MODAL -->
    <div class="modal fade" id="addColumnModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Add Column</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" id="addColumnTeam" />

                    <div class="mb-3">
                        <label class="form-label">Column Name</label>
                        <input type="text"
                               id="newColumnName"
                               class="form-control"
                               placeholder="e.g. QA Review"
                               required />
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" id="addColumnSubmit">Add</button>
                </div>

            </div>
        </div>
    </div>


    <div class="modal fade" id="createTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Create Task</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" id="taskColumnId" />

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <label class="form-label mb-0">Title</label>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-link text-secondary p-0 me-2" title="Focus title" onclick="document.getElementById('taskTitle').focus();">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button type="button" class="btn btn-link text-danger p-0" title="Clear title" onclick="document.getElementById('taskTitle').value='';">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        <input type="text" id="taskTitle" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea id="taskDescription" class="form-control"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Priority</label>
                        <select id="taskPriority" class="form-select">
                            <option value="0">Low</option>
                            <option value="1" selected>Medium</option>
                            <option value="2">High</option>
                            <option value="3">Critical</option>
                        </select>
                    </div>
                    
                  @*  <div class="mb-3">
                        <label class="form-label">Link to Project (optional - for auto ID)</label>
                        <select id="taskProjectId" class="form-select">
                            <option value="">-- No Project --</option>
                            <!-- Dynamically loaded -->
                        </select>
                        <small class="text-muted">Selecting a project generates an ID like P1T1, P1T2...</small>
                    </div>*@
                    
                    <!-- Custom Fields Container -->
                    <div id="customFieldsContainer"></div>
                </div>

                <div class="modal-footer">
                    @if (User.IsInRole("Admin") || User.IsInRole("Manager") || User.IsInRole("SubManager"))
                    {
                        <button class="btn btn-sm btn-outline-secondary me-auto" onclick="openManageFieldsModal(); event.preventDefault();">
                            <i class="bi bi-gear"></i> Manage Fields
                        </button>
                    }
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" onclick="submitCreateTask()">Create</button>
                </div>

            </div>
        </div>
    </div>

    <!-- EDIT TASK MODAL -->
    <div class="modal fade" id="editTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Edit Task</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" id="editTaskId" />

                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" id="editTaskTitle" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea id="editTaskDescription" class="form-control" rows="4"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Priority</label>
                            <select id="editTaskPriority" class="form-select">
                                <option value="0">Low</option>
                                <option value="1">Medium</option>
                                <option value="2">High</option>
                                <option value="3">Critical</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Assign To</label>
                            <select id="editTaskAssignedTo" class="form-select">
                                <option value="">-- Unassigned --</option>
                                @if (Model != null && Model.AssignableUsers != null)
                                {
                                    foreach (var u in Model.AssignableUsers)
                                    {
                                        <option value="@u.Id">@u.UserName</option>
                                    }
                                }
                            </select>
                        </div>
                    </div>

                    <!-- Custom Fields Container -->
                    <div id="editCustomFieldsContainer"></div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" onclick="submitEditTask()">Save Changes</button>
                </div>

            </div>
        </div>
    </div>

    
    <div class="modal fade" id="assignTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Assign Task</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" id="assignTaskId" />

                    <label class="form-label">Assign to</label>
                    <select id="assignUserSelect" class="form-select">
                        <option value="">-- Select User --</option>

                        @if (Model != null && Model.AssignableUsers != null && Model.AssignableUsers.Any())
                        {
                            foreach (var u in Model.AssignableUsers)
                            {
                                <option value="@u.Id">@u.UserName</option>
                            }
                        }
                        else
                        {
                            <option disabled>No users available</option>
                        }



                    </select>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button class="btn btn-primary" onclick="assignTask()">
                        Assign
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- CREATE PROJECT MODAL -->
    <div class="modal fade" id="createProjectModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-folder-plus me-2"></i>Create Project</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Project Name</label>
                        <input type="text" id="newProjectName" class="form-control" placeholder="Enter project name" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description (optional)</label>
                        <textarea id="newProjectDescription" class="form-control" rows="3" placeholder="Project description"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" onclick="submitCreateProject()">Create Project</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MANAGE CUSTOM FIELDS MODAL (Admin Only) -->
    <div class="modal fade" id="manageFieldsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-sliders me-2"></i>Manage Custom Fields</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Existing Fields List -->
                    <h6 class="mb-3">Existing Fields</h6>
                    <div id="fieldsList" class="mb-4">
                        <!-- Dynamically loaded fields -->
                    </div>
                    
                    <!-- Add New Field Form -->
                    <h6 class="mb-3 border-top pt-3">Add New Field</h6>
                    <div class="row g-3">
                        <div class="col-md-5">
                            <label class="form-label">Field Name</label>
                            <input type="text" id="newFieldName" class="form-control" placeholder="e.g., Estimated Hours" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Field Type</label>
                            <select id="newFieldType" class="form-select">
                                <option value="Text">Text</option>
                                <option value="Number">Number</option>
                                <option value="Date">Date</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="newFieldRequired" />
                                <label class="form-check-label" for="newFieldRequired">
                                    Required
                                </label>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-success mt-2" onclick="createNewField()">
                        <i class="bi bi-plus-lg"></i> Add Field
                    </button>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

</div> <!-- /.app-wrapper -->

<!-- Task History Modal -->
<div class="modal fade" id="taskHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-clock-history"></i> Task History - <span id="historyModalTaskId"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div id="historyTimeline" class="p-3">
                    <!-- Timeline content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    // Define admin status for JS
    const isAdmin = @(User.IsInRole("Admin") ? "true" : "false");
    const isManager = @((User.IsInRole("Manager") || User.IsInRole("SubManager")) ? "true" : "false");
    window.isAdmin = isAdmin;
    console.log("Admin status loaded:", window.isAdmin);
</script>

<!-- MOBILE SIDEBAR TOGGLE BUTTON -->
<button class="sidebar-toggle d-md-none" id="sidebarToggle" onclick="toggleSidebar()" aria-label="Toggle sidebar">
    <i class="bi bi-list"></i>
</button>

<script>
    // ===== SIDEBAR TOGGLE (MOBILE) =====
    function toggleSidebar() {
        const sidebar = document.getElementById('leftSidebar');
        const overlay = document.getElementById('sidebarOverlay');
        sidebar.classList.toggle('open');
        overlay.classList.toggle('active');
    }

    function closeSidebar() {
        const sidebar = document.getElementById('leftSidebar');
        const overlay = document.getElementById('sidebarOverlay');
        sidebar.classList.remove('open');
        overlay.classList.remove('active');
    }

    // Close sidebar when a team/project is selected on mobile
    document.addEventListener('click', function(e) {
        if (window.innerWidth < 768 && e.target.closest('.team-btn, .project-btn')) {
            closeSidebar();
        }
    });
</script>


<script>
    // expose admin flag to JS as boolean
    const __isTasksAdmin = @((isAdmin).ToString().ToLower());

    // ===== ADMIN TEAM MANAGEMENT =====

    function toggleAddTeamInput() {
        const container = document.getElementById('addTeamInputContainer');
        const input = document.getElementById('newTeamNameInput');
        
        if (container.style.display === 'none') {
            container.style.display = 'block';
            input.value = '';
            input.focus();
            
            // Enter key to submit
            input.onkeydown = function(e) {
                if(e.key === 'Enter') submitCreateTeam();
            };
        } else {
            container.style.display = 'none';
        }
    }

    function submitCreateTeam() {
        const input = document.getElementById('newTeamNameInput');
        const name = input.value.trim();
        
        if (!name) {
             toggleAddTeamInput();
             return;
        }

        fetch('/Teams/Create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ Name: name })
        })
        .then(res => {
            if(!res.ok) return res.text().then(t => { throw new Error(t); });
            return res.json();
        })
        .then(() => {
            toggleAddTeamInput();
            loadAdminTeamList(); // Refresh list
        })
        .catch(err => {
            console.error(err);
            alert('Failed to add team: ' + err.message);
        });
    }

    function loadAdminTeamList() {
        const container = document.getElementById('adminTeamList');
        if(!container) return;

        fetch('/Teams/GetAll')
        .then(res => res.json())
        .then(teams => {
            if(teams.length === 0) {
                 container.innerHTML = '<div class="text-muted ps-4 py-2 small">No teams found</div>';
                 return;
            }

            container.innerHTML = teams.map(t => `
               <div class="d-flex align-items-center justify-content-between group-hover-container px-0">
                    <button type="button"
                            class="list-group-item list-group-item-action bg-dark text-white team-btn flex-grow-1 text-start border-0 py-2 ps-4"
                            data-team="${t.name}"
                            onclick="loadTeamBoard('${t.name}')">
                        <i class="bi bi-people me-2"></i> ${t.name}
                    </button>
                    
                    <button class="btn btn-sm btn-link text-danger p-0 me-2" 
                            style="opacity:0.5;"
                            onmouseover="this.style.opacity=1"
                            onmouseout="this.style.opacity=0.5"
                            onclick="deleteTeam(${t.id}, '${t.name}')" 
                            title="Delete Team">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `).join('');
            
            // Re-highlight if needed
            if(typeof currentTeamName !== 'undefined') {
                 document.querySelectorAll(`.team-btn[data-team="${currentTeamName}"]`)
                         .forEach(b => b.classList.add('active'));
            }
        });
    }

    function deleteTeam(id, name) {
        if(!confirm(`Delete team '${name}'? This cannot be undone.`)) return;

        fetch('/Teams/Delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(id)
        })
        .then(res => {
             if(!res.ok) throw new Error('Failed to delete');
             loadAdminTeamList();
             // clear board if deleted team was active
             const boardContainer = document.getElementById('taskBoardContainer');
             boardContainer.innerHTML = '';
        })
        .catch(err => alert(err.message));
    }

    // Load initially if Admin
    document.addEventListener('DOMContentLoaded', function() {
        if(__isTasksAdmin) {
            loadAdminTeamList();
        }
    });

    // open add column modal (admin only)
    function openAddColumnModal(teamName) {
        if (!__isTasksAdmin) return;
        document.getElementById("addColumnTeam").value = teamName;
        document.getElementById("newColumnName").value = "";

        const modal = new bootstrap.Modal(document.getElementById("addColumnModal"));
        modal.show();
    }

    // save new column (admin only)
    document.getElementById('addColumnSubmit')?.addEventListener('click', function () {
        if (!__isTasksAdmin) return;
        const team = document.getElementById('addColumnTeam').value;
        const columnName = document.getElementById('newColumnName').value.trim();
        if (!columnName) { alert('Column name is required'); return; }

        fetch('/Tasks/AddColumn', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ team: team, columnName: columnName })
        })
            .then(res => { if (!res.ok) throw new Error('Failed'); return res.text(); })
            .then(() => {
                bootstrap.Modal.getInstance(document.getElementById('addColumnModal'))?.hide();
                // reload the board for the team
                loadTeamBoard(team);
            })
            .catch(() => alert('Failed to add column'));
    });
</script>

@{
    ViewData["Title"] = "Task Board";
}


<link rel="stylesheet" href="~/css/taskHistory.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" />

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="~/js/customFields.js"></script>
<script src="~/js/taskHistory.js"></script>
<script src="~/js/customFields.js"></script>
<script src="~/js/taskHistory.js"></script>
<script src="~/js/column_filter.js"></script>
<script src="~/js/index_ui.js"></script>

    <script>
           function enableColumnDrag() {
        if (!__isTasksAdmin) return;

        const board = document.querySelector('#kanbanBoard');
        if (!board) {
            console.warn('Kanban board not found');
            return;
        }

        // 🔥 SAFETY: remove old sortable safely
        if (board._sortableInstance) {
            board._sortableInstance.destroy();
            board._sortableInstance = null;
        }

           board._sortableInstance = new Sortable(board, {
        animation: 150,
        direction: 'horizontal',
        draggable: '.kanban-column:not(.col-history)',
        handle: '.column-drag-handle',
        filter: '.col-history',

        onEnd: function () {
            const columnIds = Array.from(
                board.querySelectorAll('.kanban-column:not(.col-history)')
            ).map(c => parseInt(c.dataset.columnId)).filter(id => !isNaN(id));

            if (columnIds.length === 0) return;

            fetch('/Tasks/ReorderColumns', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(columnIds)
            })
            .then(res => {
                if (res.ok) {
                    showToast('✅ Column order updated!', 'success');
                } else {
                    showToast('Failed to save column order', 'danger');
                }
            })
            .catch(() => showToast('Failed to save column order', 'danger'));
        }
    });

    }


// NOTE: openCreateTaskModal and submitCreateTask are defined later in this file.
// Removed duplicate definitions to avoid function override/conflict

        function startRename(columnId) {
            if (!__isTasksAdmin) return;
            document.getElementById(`column-title-${columnId}`).style.display = 'none';
            document.getElementById(`column-rename-${columnId}`).style.display = 'flex';
        }

        function cancelRename(columnId) {
            document.getElementById(`column-rename-${columnId}`).style.display = 'none';
            document.getElementById(`column-title-${columnId}`).style.display = 'block';
        }

        function saveColumnName(columnId) {
            if (!__isTasksAdmin) return;
            const input = document.getElementById(`column-input-${columnId}`);
            const newName = input?.value?.trim();
            if (!newName) { alert('Column name required'); return; }

            fetch('/Tasks/RenameColumn', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ columnId: columnId, name: newName })
            })
                .then(res => { if (!res.ok) throw new Error(); return res.text(); })
                .then(() => {
                    document.getElementById(`column-title-${columnId}`).innerText = newName;
                    cancelRename(columnId);
                })
                .catch(() => alert('Rename failed'));
        }

        function confirmDeleteColumn(columnId) {
            if (!__isTasksAdmin) return;
            if (!confirm('Delete this column?')) return;
            fetch('/Tasks/DeleteColumn', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ columnId }) })
                .then(res => { if (!res.ok) return res.text().then(t => { throw new Error(t); }); return res.text(); })
                .then(() => document.querySelector(`[data-column-id='${columnId}']`)?.remove())
                .catch(err => alert(err.message));
        }
    </script>

        <script>
                  function loadTeamBoard(team) {
        // ✅ SAVE CURRENT TEAM
        currentTeamName = team;

        const container = document.getElementById('taskBoardContainer');
        container.innerHTML = "<div class='text-muted p-3'>Loading...</div>";

        fetch(`/Tasks/TeamBoard?team=${encodeURIComponent(team)}`)
            .then(res => {
                if (!res.ok) throw new Error("Failed to load board");
                return res.text();
            })
            .then(html => {
                container.innerHTML = html;

                // highlight active team button
                document.querySelectorAll('.team-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll(`.team-btn[data-team]`).forEach(b => {
                    if (b.dataset.team === team) b.classList.add('active');
                });

                if (typeof enableColumnDrag === "function") {
                    enableColumnDrag();
                    enableTaskDragDrop();
                }
            })
            .catch(err => {
                container.innerHTML = "<div class='text-danger'>Error loading board</div>";
                console.error(err);
            });
    }
 

        </script>

<script>
    function focusColumn(columnId) {
        const board = document.getElementById('kanbanBoard');
        const backBtn = document.getElementById('backToBoardBtn');
        if (!board) return;

        board.classList.add('single-column-view');
        board.querySelectorAll('.kanban-column').forEach(col => {
            const id = parseInt(col.dataset.columnId);
            if (id === columnId) { col.classList.add('focused-column'); col.classList.remove('hidden-column'); }
            else { col.classList.remove('focused-column'); col.classList.add('hidden-column'); }
        });
        if (backBtn) backBtn.style.display = 'inline-block';
    }


            function focusTask(taskId) {
        taskId = parseInt(taskId);

        const board = document.getElementById('kanbanBoard');
        const backBtn = document.getElementById('backToBoardBtn');

        if (!board || isNaN(taskId)) return;

        // ✅ Enter focus mode
        board.classList.add('task-focused-view');



            window.__focusedTaskId = taskId;

    // show inputs
    // document.querySelector(`.task-title-input[data-task-id='${taskId}']`)?.classList.remove('d-none');
    // document.querySelector(`.task-desc-input[data-task-id='${taskId}']`)?.classList.remove('d-none');

    // hide static text
    // document.querySelector(`.task-title-text`)?.classList.add('d-none');
    // document.querySelector(`.task-desc-text`)?.classList.add('d-none');



        // ✅ Loop through all task cards
        board.querySelectorAll('.task-card').forEach(task => {
            const id = parseInt(task.dataset.taskId);

            if (id === taskId) {
                task.classList.add('focused-task');
                task.style.display = 'block';
            } else {
                task.style.display = 'none';
                task.classList.remove('focused-task');
            }
        });

        // ✅ Keep columns visible (layout preserved)
        board.querySelectorAll('.kanban-column').forEach(col => {
            col.style.display = 'block';
            col.classList.add('column-muted');
        });

        // ✅ Show back button
        if (backBtn) backBtn.style.display = 'inline-block';
    }


        function exitTaskFocus() {
        const board = document.getElementById('kanbanBoard');
        const backBtn = document.getElementById('backToBoardBtn');

        if (!board) return;

        // Remove focus mode
        board.classList.remove('task-focused-view');

        // Restore all tasks
        board.querySelectorAll('.task-card').forEach(task => {
            task.style.display = 'block';
            task.classList.remove('focused-task');
        });

        // Restore columns
        board.querySelectorAll('.kanban-column').forEach(col => {
            col.classList.remove('column-muted');
        });

        if (backBtn) backBtn.style.display = 'none';
    }



        function resetBoardView() {
        const board = document.getElementById('kanbanBoard');
        const backBtn = document.getElementById('backToBoardBtn');
        if (!board) return;

        // reset column focus
        board.classList.remove('single-column-view');
        board.querySelectorAll('.kanban-column').forEach(col => {
            col.classList.remove('focused-column');
            col.classList.remove('hidden-column');
            col.style.display = 'flex';
        });

        // reset task focus
        board.classList.remove('task-focused-view');
        board.querySelectorAll('.task-card').forEach(task => {
            task.classList.remove('focused-task');
            task.style.display = 'block';
        });

        if (backBtn) backBtn.style.display = 'none';
    }

</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        @if (isAdmin)
        {
            <text>
                // Admin: Auto-expand Team Tasks and load Development board
                const teamDropdown = document.getElementById('teamTasksDropdown');
                const teamArrow = document.getElementById('teamArrow');
                if (teamDropdown) teamDropdown.style.display = 'block';
                if (teamArrow) teamArrow.innerText = '▲';

                // load first team (Development)
                loadTeamBoard('Development');
            </text>
        }
        else if (userTeams.Any())
        {
            var firstTeam = userTeams.First();
            <text>
                // User: Auto-expand My Team and load first assigned team
                const myDropdown = document.getElementById('myTasksDropdown');
                const myArrow = document.getElementById('myTasksArrow');
                if (myDropdown) myDropdown.style.display = 'block';
                if (myArrow) myArrow.innerText = '▲';

                // load first team
                loadTeamBoard('@firstTeam');
            </text>
        }
    });
</script>

<script>
    function openCreateTaskModal(columnId) {
        document.getElementById('taskColumnId').value = columnId;
        document.getElementById('taskTitle').value = '';
        document.getElementById('taskDescription').value = '';

        // Load projects into dropdown
        loadProjectsForTaskModal();

        // Render custom fields into the modal (preserve any existing values)
        if (typeof renderCustomFieldInputs === 'function') {
            try {
                renderCustomFieldInputs('customFieldsContainer', {});
            } catch (e) { console.error(e); }
        }

        new bootstrap.Modal(document.getElementById('createTaskModal')).show();
    }

    // ================= EDIT TASK MODAL =================

    function openEditTaskModal(taskId) {
        // Fetch task details
        fetch(`/Tasks/GetTask?id=${taskId}`)
            .then(res => {
                if (!res.ok) throw new Error("Failed to load task details");
                return res.json();
            })
            .then(task => {
                // Populate Modal
                document.getElementById('editTaskId').value = task.id;
                document.getElementById('editTaskTitle').value = task.title;
                document.getElementById('editTaskDescription').value = task.description || "";
                document.getElementById('editTaskPriority').value = task.priority;
                document.getElementById('editTaskAssignedTo').value = task.assignedToUserId || "";

                // Render Custom Fields with values
                if (typeof renderCustomFieldInputs === 'function') {
                    renderCustomFieldInputs('editCustomFieldsContainer', task.customFieldValues || {});
                }

                // Show Modal
                new bootstrap.Modal(document.getElementById('editTaskModal')).show();
            })
            .catch(err => {
                console.error(err);
                alert("Error loading task details");
            });
    }

    function submitEditTask() {
        const taskId = parseInt(document.getElementById('editTaskId').value);
        const title = document.getElementById('editTaskTitle').value.trim();
        const description = document.getElementById('editTaskDescription').value.trim();
        const priority = parseInt(document.getElementById('editTaskPriority').value);
        const assignedToUserId = document.getElementById('editTaskAssignedTo').value;

        if (!title) {
            alert("Title is required");
            return;
        }

        // Validate custom fields
        if (typeof validateCustomFields === 'function' && !validateCustomFields()) {
            return;
        }

        const data = {
            taskId: taskId,
            title: title,
            description: description,
            priority: priority,
            assignedToUserId: assignedToUserId, // Send assigned user
            customFieldValues: (typeof collectCustomFieldValues === 'function') ? 
                               // Need to target the specific container or ensure helper works globally
                               // The helper targets 'customFieldsContainer' by default in customFields.js? 
                               // Wait, let me check customFields.js
                               collectCustomFieldValues('editCustomFieldsContainer') : {}
        };

        fetch('/Tasks/UpdateTask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(res => {
            if (!res.ok) throw new Error("Failed to update task");
            return res.json();
        })
        .then(() => {
            // Close modal
            const modalEl = document.getElementById('editTaskModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();

            // Reload board
            loadTeamBoard(currentTeamName);
        })
        .catch(err => {
            console.error(err);
            alert("Failed to update task");
        });
    }

    function loadProjectsForTaskModal() {
        const select = document.getElementById('taskProjectId');
        if (!select) return;

        fetch('/Project/GetProjects')
            .then(res => res.json())
            .then(projects => {
                select.innerHTML = '<option value="">-- No Project --</option>';
                projects.forEach(p => {
                    select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                });
            })
            .catch(() => {
                select.innerHTML = '<option value="">-- No Project --</option>';
            });
    }

    function submitCreateTask() {
        const projectSelect = document.getElementById('taskProjectId');
        const projectId = projectSelect?.value ? parseInt(projectSelect.value) : null;

        const priorityEl = document.getElementById('taskPriority');
        const priority = priorityEl ? parseInt(priorityEl.value) : 1;

        const data = {
            columnId: parseInt(document.getElementById('taskColumnId').value),
            title: document.getElementById('taskTitle').value.trim(),
            description: document.getElementById('taskDescription').value.trim(),
            projectId: projectId,
            priority: priority,
            customFieldValues: (typeof collectCustomFieldValues === 'function') ? collectCustomFieldValues() : {}
        };

        fetch('/Tasks/CreateTask', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(res => {
            if (!res.ok) {
                return res.text().then(t => {
                    throw new Error(t || 'Failed to create task');
                });
            }

            // ✅ SUCCESS (no JSON expected)
            const modalEl = document.getElementById('createTaskModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();

            // reload board
            loadTeamBoard(currentTeamName);
        })
        .catch(err => {
            alert(err.message || 'Failed to create task');
        });
    }
</script>

<script>
    function saveFocusedTask() {
        const taskId = window.__focusedTaskId;
        if (!taskId) return;

        const title = document.getElementById('focusedTaskTitle').value;
        const desc = document.getElementById('focusedTaskDescription').value;
        const assignedTo = document.getElementById('focusedTaskAssignUser').value;

        fetch('/Tasks/UpdateTask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                taskId: taskId,
                title: title,
                description: desc,
                assignedToUserId: assignedTo
            })
        })
        .then(res => {
            if (!res.ok) throw new Error();
            loadTeamBoard(currentTeamName);
        })
        .catch(() => alert('Failed to update task'));
    }
</script>


<script>
    function deleteTask(taskId) {
        if (!confirm('Delete this task?')) return;

            fetch('/Tasks/DeleteTask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(taskId)
    })
    .then(res => {
        if (!res.ok) throw new Error('Failed to delete');
        loadTeamBoard(currentTeamName);
    })
    .catch(err => alert(err.message));


    }
</script>


<script>
    function assignTask(taskId, userId) {
        if (!userId) return;

        fetch('/Tasks/AssignTask', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `taskId=${taskId}&userId=${userId}`
        })
        .then(res => res.json())
        .then(result => {
            showAssignToast(
                userId,
                result.assignedBy,
                result.assignedAt
            );

            loadTeamBoard(currentTeamName);
        })
        .catch(() => alert('Failed to assign task'));
    }
</script>



<script>
    function showAssignToast(userId, assignedBy, assignedAt) {
        fetch(`/Users/GetUserInfo?userId=${userId}`)
            .then(res => res.json())
            .then(u => {
                const toast = document.createElement('div');
                toast.className = 'assign-toast';
                toast.innerHTML = `
                    Task assigned to <b>${u.userName}</b> (${u.role})<br/>
                    By ${assignedBy} at ${assignedAt}
                `;

                document.body.appendChild(toast);

                setTimeout(() => toast.remove(), 5000);
            });
    }









        function showAssignDropdown(taskId) {

        // Hide all other assign containers
        document.querySelectorAll('.task-assign-container').forEach(c => {
            c.classList.add('d-none');
        });

        // Show current task assign UI
        const container = document.querySelector(
            `.task-assign-container[data-task-id='${taskId}']`
        );

        if (container) {
            container.classList.remove('d-none');
        }
    }

        function cancelAssignTask(taskId) {
        const container = document.querySelector(
            `.task-assign-container[data-task-id='${taskId}']`
        );

        if (container) {
            container.classList.add('d-none');
        }
    }


        function confirmAssignTask(taskId) {

        const select = document.querySelector(
            `.task-assign-select[data-task-id='${taskId}']`
        );

        if (!select || !select.value) {
            alert("Please select a user");
            return;
        }

        const userId = select.value;

        fetch('/Tasks/AssignTask', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `taskId=${taskId}&userId=${userId}`
        })
        .then(res => {
            if (!res.ok) throw new Error();
            return res.json();
        })
        .then(result => {

            // Optional toast (you already have this)
            showAssignToast(userId, result.assignedBy, result.assignedAt);

            // Hide assign UI
            cancelAssignTask(taskId);

            // Reload board to reflect assignment
            loadTeamBoard(currentTeamName);
        })
        .catch(() => showToast('Failed to assign task — please try again.', 'danger'));
    }


                function enableTaskDragDrop() {

        const role = (typeof currentUserRole !== 'undefined') ? currentUserRole : 'User';

        document.querySelectorAll('.kanban-tasks').forEach(container => {
            // Skip History column task list (read-only)
            if (container.id === 'historyTasksList') return;

            if (container._taskSortable) {
                container._taskSortable.destroy();
            }

            container._taskSortable = new Sortable(container, {
                group: 'tasks',
                animation: 200,
                draggable: '.task-card',
                ghostClass: 'task-ghost',
                chosenClass: 'task-chosen',

                onMove: function (evt) {
                    const targetColumn = evt.to?.closest('.kanban-column');
                    if (!targetColumn) return true;

                    const colName = targetColumn.dataset.columnName?.toLowerCase().trim();

                    // Block: History column
                    if (colName === 'history' || targetColumn.classList.contains('col-history')) {
                        return false;
                    }

                    // Block: Non-admin to completed
                    if (colName === 'completed' && role !== 'Admin') {
                        return false;
                    }

                    return true;
                },

                onEnd: function (evt) {
                    const taskId = parseInt(evt.item.dataset.taskId);
                    const newColumnId = parseInt(evt.to.dataset.columnId);
                    const targetColumn = evt.to?.closest('.kanban-column');
                    const colName = targetColumn?.dataset.columnName?.toLowerCase().trim();

                    // Revalidate restrictions
                    if (colName === 'history' || (colName === 'completed' && role !== 'Admin')) {
                        showToast(colName === 'history' ? '📋 History is read-only.' : '🔒 Only admins can move tasks to Completed.', 'warning');
                        loadTeamBoard(currentTeamName);
                        return;
                    }

                    if (!taskId || !newColumnId) return;

                    updateTaskColumn(taskId, newColumnId);
                }
            });
        });
    }



        function updateTaskColumn(taskId, columnId) {

        fetch('/Tasks/MoveTask', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                taskId: taskId,
                columnId: columnId
            })
        })
        .then(res => {
            if (!res.ok) throw new Error('Failed to move task');
        })
        .then(() => {
            showToast('✅ Task moved successfully!', 'success');
        })
        .catch(err => {
            showToast(err.message || 'Failed to move task', 'danger');
            // reload board to recover UI
            loadTeamBoard(currentTeamName);
        });
    }

    function deleteProject(id, name) {
        if(!confirm(`Delete project '${name}' and all its contents? This cannot be undone.`)) return;

        fetch('/Project/DeleteProject', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(id)
        })
        .then(res => {
             if(!res.ok) throw new Error('Failed to delete project');
             loadProjectList();
             // clear board if deleted project was active
             const boardContainer = document.getElementById('taskBoardContainer');
             boardContainer.innerHTML = '';
        })
        .catch(err => alert(err.message));
    }

    function filterBoardTasks() {
        const searchText = document.getElementById('taskSearchInput')?.value.toLowerCase() || "";
        const priorityFilter = document.getElementById('priorityFilter')?.value || "";
        const assigneeFilter = document.getElementById('assigneeFilter')?.value || "";
        const adminFilter = document.getElementById('adminAssignedFilter')?.value || "";

        const cards = document.querySelectorAll('.task-card');
        
        cards.forEach(card => {
            // 1. Search Text (Title, Description, Custom Fields)
            const title = card.querySelector('.task-title-text')?.innerText.toLowerCase() || "";
            const desc = card.querySelector('.task-desc-text')?.innerText.toLowerCase() || "";
            const customFields = card.querySelector('.custom-fields-summary')?.innerText.toLowerCase() || "";
            
            const matchesSearch = !searchText || 
                                 title.includes(searchText) || 
                                 desc.includes(searchText) || 
                                 customFields.includes(searchText);

            // 2. Priority
            const cardPriority = card.dataset.priority || "";
            const matchesPriority = !priorityFilter || cardPriority === priorityFilter;

            // 3. Assignee
            const cardAssigneeId = card.dataset.assignedToId || "";
            const matchesAssignee = !assigneeFilter || cardAssigneeId === assigneeFilter;

            // 4. Assigned by Admin
            const isAdminAssigned = card.dataset.assignedByAdmin === "true";
            let matchesAdmin = true;
            if (adminFilter === "Admin") {
                matchesAdmin = isAdminAssigned;
            }

            // Combine all
            if (matchesSearch && matchesPriority && matchesAssignee && matchesAdmin) {
                card.style.display = "block";
                card.classList.remove('d-none'); // Ensure no d-none override
            } else {
                card.style.display = "none";
            }
        });
    }

    function getCsrfToken() {
        const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
        return tokenInput ? tokenInput.value : '';
    }
</script>



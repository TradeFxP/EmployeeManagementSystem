@using UserRoles.ViewModels

@model UserRoles.ViewModels.TeamBoardViewModel



@{
    ViewData["Title"] = "Tasks";
    var userTeams = ViewBag.UserTeams as List<string> ?? new List<string>();
    var isAdmin = User.IsInRole("Admin");
}

<div class="row" style="min-height:85vh;">   

    <!-- LEFT PANEL -->
    <div class="col-md-2 bg-dark text-white p-3">

        <h5 class="mb-4">Boards</h5>

        <div class="list-group list-group-flush">

            @if (isAdmin)
            {
                <!-- ================= ADMIN: TEAM TASKS ================= -->
                <button type="button"
                        class="list-group-item list-group-item-action bg-dark text-white d-flex justify-content-between align-items-center"
                        onclick="toggleTeamTasks()">
                    <span>
                        <i class="bi bi-people-fill me-2"></i> Team Tasks
                    </span>
                    <span id="teamArrow">▼</span>
                </button>

                <!-- Team Tasks Dropdown -->
                <div id="teamTasksDropdown" style="display:none;">
                    <button type="button"
                            class="list-group-item list-group-item-action bg-dark text-white ps-4 team-btn"
                            data-team="Development"
                            onclick="loadTeamBoard('Development')">
                        <i class="bi bi-code-slash me-2"></i> Development Team
                    </button>

                    <button type="button"
                            class="list-group-item list-group-item-action bg-dark text-white ps-4 team-btn"
                            data-team="Testing"
                            onclick="loadTeamBoard('Testing')">
                        <i class="bi bi-bug-fill me-2"></i> Testing Team
                    </button>

                    <button type="button"
                            class="list-group-item list-group-item-action bg-dark text-white ps-4 team-btn"
                            data-team="Sales"
                            onclick="loadTeamBoard('Sales')">
                        <i class="bi bi-briefcase-fill me-2"></i> Sales Team
                    </button>
                </div>
            }
            else
            {
                <!-- ================= USER/MANAGER: MY TEAM ================= -->
                <button type="button"
                        class="list-group-item list-group-item-action bg-dark text-white d-flex justify-content-between align-items-center"
                        onclick="toggleMyTasks()">
                    <span>
                        <i class="bi bi-kanban-fill me-2"></i> My Team
                    </span>
                    <span id="myTasksArrow">▼</span>
                </button>

                <!-- My Team Dropdown - Only shows teams assigned by Admin -->
                <div id="myTasksDropdown" style="display:none;">
                    @if (userTeams.Any())
                    {
                        @foreach (var team in userTeams)
                        {
                            var icon = team switch {
                                "Development" => "bi-code-slash",
                                "Testing" => "bi-bug-fill",
                                "Sales" => "bi-briefcase-fill",
                                _ => "bi-arrow-right-circle"
                            };
                            <button type="button"
                                    class="list-group-item list-group-item-action bg-dark text-white ps-4 team-btn"
                                    data-team="@team"
                                    onclick="loadTeamBoard('@team')">
                                <i class="bi @icon me-2"></i> @team Team
                            </button>
                        }
                    }
                    else
                    {
                        <div class="text-muted ps-4 py-2">
                            No teams assigned
                        </div>
                    }
                </div>
            }

        </div>
    </div>


    <!-- RIGHT PANEL -->
    <div class="col-md-9 p-4">
        <div id="taskBoardContainer"></div>
    </div>


    <!-- ADD COLUMN MODAL -->
    <div class="modal fade" id="addColumnModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Add Column</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" id="addColumnTeam" />

                    <div class="mb-3">
                        <label class="form-label">Column Name</label>
                        <input type="text"
                               id="newColumnName"
                               class="form-control"
                               placeholder="e.g. QA Review"
                               required />
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" id="addColumnSubmit">Add</button>
                </div>

            </div>
        </div>
    </div>


    <div class="modal fade" id="createTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Create Task</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" id="taskColumnId" />

                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" id="taskTitle" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea id="taskDescription" class="form-control"></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" onclick="submitCreateTask()">Create</button>
                </div>

            </div>
        </div>
    </div>

    // assign button
    <div class="modal fade" id="assignTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Assign Task</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" id="assignTaskId" />

                    <label class="form-label">Assign to</label>
                    <select id="assignUserSelect" class="form-select">
                        <option value="">-- Select User --</option>

                        @if (Model != null && Model.AssignableUsers != null && Model.AssignableUsers.Any())
                        {
                            foreach (var u in Model.AssignableUsers)
                            {
                                <option value="@u.Id">@u.UserName</option>
                            }
                        }
                        else
                        {
                            <option disabled>No users available</option>
                        }



                    </select>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button class="btn btn-primary" onclick="assignTask()">
                        Assign
                    </button>
                </div>

            </div>
        </div>
    </div>


</div>



<style>
    .list-group-item {
        border: none;
    }

    .team-btn.active {
        background-color: #0d6efd;
        color: #fff;
    }


        .assign-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #198754;
            color: white;
            padding: 14px 18px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,.25);
            z-index: 9999;
            font-size: 14px;
        }

</style>


<script>
    function toggleTeamTasks() {
        const dropdown = document.getElementById("teamTasksDropdown");
        const arrow = document.getElementById("teamArrow");

        if (dropdown.style.display === "none") {
            dropdown.style.display = "block";
            arrow.innerText = "▲";
        } else {
            dropdown.style.display = "none";
            arrow.innerText = "▼";
        }
    }


    function toggleMyTasks() {
        const dropdown = document.getElementById("myTasksDropdown");
        const arrow = document.getElementById("myTasksArrow");

        if (!dropdown) return;

        const isOpen = dropdown.style.display === "block";
        dropdown.style.display = isOpen ? "none" : "block";
        arrow.innerText = isOpen ? "▼" : "▲";
    }
</script>

<script>
    // expose admin flag to JS as boolean
    const __isTasksAdmin = @((isAdmin).ToString().ToLower());

    // open add column modal (admin only)
    function openAddColumnModal(teamName) {
        if (!__isTasksAdmin) return;
        document.getElementById("addColumnTeam").value = teamName;
        document.getElementById("newColumnName").value = "";

        const modal = new bootstrap.Modal(document.getElementById("addColumnModal"));
        modal.show();
    }

    // save new column (admin only)
    document.getElementById('addColumnSubmit')?.addEventListener('click', function () {
        if (!__isTasksAdmin) return;
        const team = document.getElementById('addColumnTeam').value;
        const columnName = document.getElementById('newColumnName').value.trim();
        if (!columnName) { alert('Column name is required'); return; }

        fetch('/Tasks/AddColumn', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ team: team, columnName: columnName })
        })
            .then(res => { if (!res.ok) throw new Error('Failed'); return res.text(); })
            .then(() => {
                bootstrap.Modal.getInstance(document.getElementById('addColumnModal'))?.hide();
                // reload the board for the team
                loadTeamBoard(team);
            })
            .catch(() => alert('Failed to add column'));
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script>
           function enableColumnDrag() {
        if (!__isTasksAdmin) return;

        const board = document.querySelector('#kanbanBoard');
        if (!board) {
            console.warn('Kanban board not found');
            return;
        }

        // 🔥 SAFETY: remove old sortable safely
        if (board._sortableInstance) {
            board._sortableInstance.destroy();
            board._sortableInstance = null;
        }

        board._sortableInstance = new Sortable(board, {
            animation: 150,
            direction: 'horizontal',
            draggable: '.kanban-column',

            onEnd: function () {
                const columnIds = Array.from(
                    board.querySelectorAll('.kanban-column')
                ).map(c => parseInt(c.dataset.columnId));

                fetch('/Tasks/ReorderColumns', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(columnIds)
                }).catch(err => console.error('Failed to save column order', err));
            }
        });
    }


        function startRename(columnId) {
            if (!__isTasksAdmin) return;
            document.getElementById(`column-title-${columnId}`).style.display = 'none';
            document.getElementById(`column-rename-${columnId}`).style.display = 'flex';
        }

        function cancelRename(columnId) {
            document.getElementById(`column-rename-${columnId}`).style.display = 'none';
            document.getElementById(`column-title-${columnId}`).style.display = 'block';
        }

        function saveColumnName(columnId) {
            if (!__isTasksAdmin) return;
            const input = document.getElementById(`column-input-${columnId}`);
            const newName = input?.value?.trim();
            if (!newName) { alert('Column name required'); return; }

            fetch('/Tasks/RenameColumn', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ columnId: columnId, name: newName })
            })
                .then(res => { if (!res.ok) throw new Error(); return res.text(); })
                .then(() => {
                    document.getElementById(`column-title-${columnId}`).innerText = newName;
                    cancelRename(columnId);
                })
                .catch(() => alert('Rename failed'));
        }

        function confirmDeleteColumn(columnId) {
            if (!__isTasksAdmin) return;
            if (!confirm('Delete this column?')) return;
            fetch('/Tasks/DeleteColumn', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ columnId }) })
                .then(res => { if (!res.ok) return res.text().then(t => { throw new Error(t); }); return res.text(); })
                .then(() => document.querySelector(`[data-column-id='${columnId}']`)?.remove())
                .catch(err => alert(err.message));
        }
    </script>

        <script>
                  function loadTeamBoard(team) {
        // ✅ SAVE CURRENT TEAM
        currentTeamName = team;

        const container = document.getElementById('taskBoardContainer');
        container.innerHTML = "<div class='text-muted p-3'>Loading...</div>";

        fetch(`/Tasks/TeamBoard?team=${encodeURIComponent(team)}`)
            .then(res => {
                if (!res.ok) throw new Error("Failed to load board");
                return res.text();
            })
            .then(html => {
                container.innerHTML = html;

                // highlight active team button
                document.querySelectorAll('.team-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll(`.team-btn[data-team]`).forEach(b => {
                    if (b.dataset.team === team) b.classList.add('active');
                });

                if (typeof enableColumnDrag === "function") {
                    enableColumnDrag();
                }
            })
            .catch(err => {
                container.innerHTML = "<div class='text-danger'>Error loading board</div>";
                console.error(err);
            });
    }
 

        </script>

<script>
    function focusColumn(columnId) {
        const board = document.getElementById('kanbanBoard');
        const backBtn = document.getElementById('backToBoardBtn');
        if (!board) return;

        board.classList.add('single-column-view');
        board.querySelectorAll('.kanban-column').forEach(col => {
            const id = parseInt(col.dataset.columnId);
            if (id === columnId) { col.classList.add('focused-column'); col.classList.remove('hidden-column'); }
            else { col.classList.remove('focused-column'); col.classList.add('hidden-column'); }
        });
        if (backBtn) backBtn.style.display = 'inline-block';
    }


            function focusTask(taskId) {
        taskId = parseInt(taskId);

        const board = document.getElementById('kanbanBoard');
        const backBtn = document.getElementById('backToBoardBtn');

        if (!board || isNaN(taskId)) return;

        // ✅ Enter focus mode
        board.classList.add('task-focused-view');



            window.__focusedTaskId = taskId;

    // show inputs
    document.querySelector(`.task-title-input[data-task-id='${taskId}']`)?.classList.remove('d-none');
    document.querySelector(`.task-desc-input[data-task-id='${taskId}']`)?.classList.remove('d-none');

    // hide static text
    document.querySelector(`.task-title-text`)?.classList.add('d-none');
    document.querySelector(`.task-desc-text`)?.classList.add('d-none');



        // ✅ Loop through all task cards
        board.querySelectorAll('.task-card').forEach(task => {
            const id = parseInt(task.dataset.taskId);

            if (id === taskId) {
                task.classList.add('focused-task');
                task.style.display = 'block';
            } else {
                task.style.display = 'none';
                task.classList.remove('focused-task');
            }
        });

        // ✅ Keep columns visible (layout preserved)
        board.querySelectorAll('.kanban-column').forEach(col => {
            col.style.display = 'block';
            col.classList.add('column-muted');
        });

        // ✅ Show back button
        if (backBtn) backBtn.style.display = 'inline-block';
    }


        function exitTaskFocus() {
        const board = document.getElementById('kanbanBoard');
        const backBtn = document.getElementById('backToBoardBtn');

        if (!board) return;

        // Remove focus mode
        board.classList.remove('task-focused-view');

        // Restore all tasks
        board.querySelectorAll('.task-card').forEach(task => {
            task.style.display = 'block';
            task.classList.remove('focused-task');
        });

        // Restore columns
        board.querySelectorAll('.kanban-column').forEach(col => {
            col.classList.remove('column-muted');
        });

        if (backBtn) backBtn.style.display = 'none';
    }



        function resetBoardView() {
        const board = document.getElementById('kanbanBoard');
        const backBtn = document.getElementById('backToBoardBtn');
        if (!board) return;

        // reset column focus
        board.classList.remove('single-column-view');
        board.querySelectorAll('.kanban-column').forEach(col => {
            col.classList.remove('focused-column');
            col.classList.remove('hidden-column');
            col.style.display = 'flex';
        });

        // reset task focus
        board.classList.remove('task-focused-view');
        board.querySelectorAll('.task-card').forEach(task => {
            task.classList.remove('focused-task');
            task.style.display = 'block';
        });

        if (backBtn) backBtn.style.display = 'none';
    }

</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        @if (isAdmin)
        {
            <text>
                // Admin: Auto-expand Team Tasks and load Development board
                const teamDropdown = document.getElementById('teamTasksDropdown');
                const teamArrow = document.getElementById('teamArrow');
                if (teamDropdown) teamDropdown.style.display = 'block';
                if (teamArrow) teamArrow.innerText = '▲';

                // load first team (Development)
                loadTeamBoard('Development');
            </text>
        }
        else if (userTeams.Any())
        {
            var firstTeam = userTeams.First();
            <text>
                // User: Auto-expand My Team and load first assigned team
                const myDropdown = document.getElementById('myTasksDropdown');
                const myArrow = document.getElementById('myTasksArrow');
                if (myDropdown) myDropdown.style.display = 'block';
                if (myArrow) myArrow.innerText = '▲';

                // load first team
                loadTeamBoard('@firstTeam');
            </text>
        }
    });
</script>

<script>
    function openCreateTaskModal(columnId) {
        document.getElementById('taskColumnId').value = columnId;
        document.getElementById('taskTitle').value = '';
        document.getElementById('taskDescription').value = '';

        new bootstrap.Modal(document.getElementById('createTaskModal')).show();
    }

    function submitCreateTask() {
        const data = {
            columnId: parseInt(document.getElementById('taskColumnId').value),
            title: document.getElementById('taskTitle').value.trim(),
            description: document.getElementById('taskDescription').value.trim()
        };

        fetch('/Tasks/CreateTask', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(res => {
            if (!res.ok) {
                return res.text().then(t => {
                    throw new Error(t || 'Failed to create task');
                });
            }

            // ✅ SUCCESS (no JSON expected)
            const modalEl = document.getElementById('createTaskModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();

            // reload board
            loadTeamBoard(currentTeamName);
        })
        .catch(err => {
            alert(err.message || 'Failed to create task');
        });
    }
</script>

<script>
    function saveFocusedTask() {
        const taskId = window.__focusedTaskId;
        if (!taskId) return;

        const title = document.querySelector(`.task-title-input[data-task-id='${taskId}']`).value;
        const desc = document.querySelector(`.task-desc-input[data-task-id='${taskId}']`).value;
        const assignedTo = document.querySelector(`.task-assign-select[data-task-id='${taskId}']`).value;

        fetch('/Tasks/UpdateTask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                taskId: taskId,
                title: title,
                description: desc,
                assignedToUserId: assignedTo
            })
        })
        .then(res => {
            if (!res.ok) throw new Error();
            loadTeamBoard(currentTeamName);
        })
        .catch(() => alert('Failed to update task'));
    }
</script>


<script>
    function deleteTask(taskId) {
        if (!confirm('Delete this task?')) return;

            fetch('/Tasks/DeleteTask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(taskId)
    })
    .then(res => {
        if (!res.ok) throw new Error('Failed to delete');
        loadTeamBoard(currentTeamName);
    })
    .catch(err => alert(err.message));


    }
</script>


<script>
    function assignTask(taskId, userId) {
        if (!userId) return;

        fetch('/Tasks/AssignTask', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `taskId=${taskId}&userId=${userId}`
        })
        .then(res => res.json())
        .then(result => {
            showAssignToast(
                userId,
                result.assignedBy,
                result.assignedAt
            );

            loadTeamBoard(currentTeamName);
        })
        .catch(() => alert('Failed to assign task'));
    }
</script>



<script>
    function showAssignToast(userId, assignedBy, assignedAt) {
        fetch(`/Users/GetUserInfo?userId=${userId}`)
            .then(res => res.json())
            .then(u => {
                const toast = document.createElement('div');
                toast.className = 'assign-toast';
                toast.innerHTML = `
                    Task assigned to <b>${u.userName}</b> (${u.role})<br/>
                    By ${assignedBy} at ${assignedAt}
                `;

                document.body.appendChild(toast);

                setTimeout(() => toast.remove(), 5000);
            });
    }
</script>

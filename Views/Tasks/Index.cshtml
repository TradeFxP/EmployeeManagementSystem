@using UserRoles.ViewModels
@using UserRoles.Models
@inject Microsoft.AspNetCore.Identity.UserManager<Users> UserManager

@model UserRoles.ViewModels.TeamBoardViewModel

@{
    ViewData["Title"] = "Tasks";
    var userTeams = ViewBag.UserTeams as List<string> ?? new List<string>();
    var isAdmin = User.IsInRole("Admin");
}

<style>
    .modal-action-buttons {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid #f0f0f0;
    }

    .modal-action-btn {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 1.4rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .modal-action-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    }

    .modal-action-btn:active {
        transform: translateY(-1px);
    }

    .btn-modal-history {
        background-color: #eef2ff;
        color: #4f46e5;
    }

    .btn-modal-assign {
        background-color: #f3f4f6;
        color: #4b5563;
    }

    .btn-modal-edit {
        background-color: #fff7ed;
        color: #ea580c;
    }

    .modal-action-btn-sm {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 1.1rem;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .modal-action-btn-sm:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
</style>

<!-- MOBILE SIDEBAR OVERLAY -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<div class="app-wrapper">

    <!-- LEFT SIDEBAR -->
    <aside class="left-sidebar" id="leftSidebar">

        <h5>Boards</h5>

        <div class="list-group list-group-flush">

            @if (isAdmin)
            {
                <!-- ================= PROJECT SECTION ================= -->
                <button type="button"
                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                    onclick="toggleProjectPanel()">
                    <span>
                        <i class="bi bi-folder2 me-2"></i> Project
                    </span>
                    <span id="projectArrow">▼</span>
                </button>

                <div id="projectDropdown" style="display:none;">
                    <div id="projectList"></div>
                    <button type="button" class="list-group-item list-group-item-action ps-4"
                        onclick="openCreateProjectModal()">
                        <i class="bi bi-plus-lg me-2"></i> New Project
                    </button>
                </div>

                <!-- ================= EMPLOYEES SECTION ================= -->
                <button type="button"
                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                    onclick="loadEmployeesAdminPanel()">
                    <span>
                        <i class="bi bi-person-badge-fill me-2"></i> Employees
                    </span>
                </button>

                <!-- ================= TEAM TASKS ================= -->
                <button type="button"
                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                    onclick="toggleTeamTasks()">
                    <span>
                        <i class="bi bi-people-fill me-2"></i> Team Tasks
                    </span>
                    <span id="teamArrow">▲</span>
                </button>

                <div id="teamTasksDropdown" style="display:block;">
                    <div id="adminTeamList"></div>

                    <div class="mt-2 pt-2 px-3" style="border-top: 1px solid rgba(255,255,255,0.08);">
                        <div id="addTeamInputContainer" style="display:none;" class="mb-2">
                            <input type="text" id="newTeamNameInput"
                                class="form-control form-control-sm bg-dark text-white border-secondary"
                                placeholder="Enter team name..." />
                            <div class="d-flex justify-content-end mt-1 gap-1">
                                <button class="btn btn-xs btn-secondary" onclick="toggleAddTeamInput()">Cancel</button>
                                <button class="btn btn-xs btn-primary" onclick="submitCreateTeam()">Add</button>
                            </div>
                        </div>

                        <button type="button" class="btn btn-sm w-100 text-start"
                            style="color: rgba(255,255,255,0.5); border: 1px dashed rgba(255,255,255,0.15);"
                            onclick="toggleAddTeamInput()">
                            <i class="bi bi-plus-circle me-2"></i> Add Team
                        </button>
                    </div>
                </div>
            }
            else
            {
                <!-- ================= USER/MANAGER: MY TEAM ================= -->
                <button type="button"
                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                    onclick="toggleMyTasks()">
                    <span>
                        <i class="bi bi-kanban-fill me-2"></i> My Team
                    </span>
                    <span id="myTasksArrow">▼</span>
                </button>

                <div id="myTasksDropdown" style="display:none;">
                    @if (userTeams.Any())
                    {
                        @foreach (var team in userTeams)
                        {
                            var icon = team switch
                            {
                                "Development" => "bi-code-slash",
                                "Testing" => "bi-bug-fill",
                                "Sales" => "bi-briefcase-fill",
                                _ => "bi-arrow-right-circle"
                            };
                            <button type="button" class="list-group-item list-group-item-action ps-4 team-btn" data-team="@team"
                                onclick="loadTeamBoard('@team')">
                                <i class="bi @icon me-2"></i> @team Team
                            </button>
                        }
                    }
                    else
                    {
                        <div class="text-muted ps-4 py-2" style="font-size: 0.825rem;">
                            No teams assigned
                        </div>
                    }
                </div>
            }

        </div>
    </aside>

    <!-- RIGHT CONTENT AREA -->
    <div class="right-content">
        <div id="taskBoardContainer"></div>
    </div>


    <!-- ═══════ JS: EXPOSE USER ROLE ═══════ -->
    <script>
        var currentUserRole = '@(User.IsInRole("Admin") ? "Admin" : User.IsInRole("Manager") ? "Manager" : User.IsInRole("Sub-Manager") ? "Sub-Manager" : "User")';
        var isAdmin = @(User.IsInRole("Admin") ? "true" : "false");
    </script>

    <!-- ═══════ REVIEW TASK MODAL (ADMIN ONLY) ═══════ -->
    <div class="modal fade" id="reviewTaskModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 16px 16px 0 0;">
                    <h5 class="modal-title text-white">
                        <i class="bi bi-clipboard-check me-2"></i>Review Task
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <input type="hidden" id="reviewTaskId" />

                    <div class="mb-3">
                        <label class="form-label fw-bold">Task</label>
                        <div id="reviewTaskTitle" class="form-control-plaintext fs-5 fw-semibold"></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Decision</label>
                        <div class="d-flex gap-3">
                            <div class="form-check form-check-inline flex-fill">
                                <input class="form-check-input" type="radio" name="reviewDecision" id="reviewPass"
                                    value="pass" checked>
                                <label class="form-check-label w-100 text-center py-2 rounded border review-radio-pass"
                                    for="reviewPass">
                                    <i class="bi bi-check-circle-fill text-success me-1"></i> Pass
                                </label>
                            </div>
                            <div class="form-check form-check-inline flex-fill">
                                <input class="form-check-input" type="radio" name="reviewDecision" id="reviewFail"
                                    value="fail">
                                <label class="form-check-label w-100 text-center py-2 rounded border review-radio-fail"
                                    for="reviewFail">
                                    <i class="bi bi-x-circle-fill text-danger me-1"></i> Fail
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Review Note <span class="text-muted fw-normal">(required for
                                fail)</span></label>
                        <textarea id="reviewNote" class="form-control" rows="3"
                            placeholder="Add your review comments..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0 px-4 pb-4">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary px-4" id="submitReviewBtn" onclick="submitReview()">
                        <i class="bi bi-send me-1"></i> Submit Review
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════ ARCHIVED TASK DETAIL MODAL ═══════ -->
    <div class="modal fade" id="archivedTaskModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, #1a1a2e, #16213e); border-radius: 16px 16px 0 0;">
                    <h5 class="modal-title text-white">
                        <i class="bi bi-archive me-2"></i>Archived Task Overview
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4" id="archivedTaskBody">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════ TASK OVERVIEW MODAL ═══════ -->
    <div class="modal fade" id="taskOverviewModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
                <div class="modal-header d-flex align-items-center"
                    style="background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 16px 16px 0 0;">
                    <h5 class="modal-title text-white mb-0">
                        <i class="bi bi-card-text me-2"></i>Task Overview
                    </h5>
                    <div id="taskOverviewActions" class="ms-auto d-flex gap-2 me-3"></div>
                    <button type="button" class="btn-close btn-close-white ms-0" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4" id="taskOverviewBody">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addColumnModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Add Column</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" id="addColumnTeam" />

                    <div class="mb-3">
                        <label class="form-label">Column Name</label>
                        <input type="text" id="newColumnName" class="form-control" placeholder="e.g. QA Review"
                            required />
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" id="addColumnSubmit">Add</button>
                </div>

            </div>
        </div>
    </div>


    <div class="modal fade" id="createTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Create Task</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" id="taskColumnId" />

                    <div class="mb-3" id="groupCreateTaskTitle">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <label class="form-label mb-0" id="labelCreateTaskTitle">Title</label>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-link text-secondary p-0 me-2" title="Rename Title" onclick="renameField('labelCreateTaskTitle')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button type="button" class="btn btn-link text-danger p-0" title="Delete Title" onclick="hideField('groupCreateTaskTitle')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        <input type="text" id="taskTitle" class="form-control" required />
                    </div>

                    <div class="mb-3" id="groupCreateTaskDescription">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <label class="form-label mb-0" id="labelCreateTaskDescription">Description</label>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-link text-secondary p-0 me-2" title="Rename Description" onclick="renameField('labelCreateTaskDescription')">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button type="button" class="btn btn-link text-danger p-0" title="Delete Description" onclick="hideField('groupCreateTaskDescription')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                        </div>
                        <textarea id="taskDescription" class="form-control" rows="3"></textarea>
                    </div>

                    <div class="mb-3" id="groupCreateTaskPriority">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <label class="form-label mb-0" id="labelCreateTaskPriority">Priority</label>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-link text-secondary p-0 me-2" title="Rename Priority" onclick="renameField('labelCreateTaskPriority')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button type="button" class="btn btn-link text-danger p-0" title="Delete Priority" onclick="hideField('groupCreateTaskPriority')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        <select id="taskPriority" class="form-select">
                            <option value="0">Low</option>
                            <option value="1" selected>Medium</option>
                            <option value="2">High</option>
                            <option value="3">Critical</option>
                        </select>
                    </div>

                    <div class="mb-3" id="groupCreateTaskDueDate" style="display: @(Model?.TeamSettings?.IsDueDateVisible ?? true ? "block" : "none")">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <label class="form-label mb-0" id="labelCreateTaskDueDate">Due Date & Time</label>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-link text-secondary p-0 me-2" title="Rename Due Date" onclick="renameField('labelCreateTaskDueDate')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button type="button" class="btn btn-link text-danger p-0" title="Delete Due Date" onclick="hideField('groupCreateTaskDueDate')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        <input type="datetime-local" id="taskDueDate" class="form-control" />
                    </div>

                    @* <div class="mb-3">
                    <label class="form-label">Link to Project (optional - for auto ID)</label>
                    <select id="taskProjectId" class="form-select">
                    <option value="">-- No Project --</option>
                    <!-- Dynamically loaded -->
                    </select>
                    <small class="text-muted">Selecting a project generates an ID like P1T1, P1T2...</small>
                    </div>*@

                    <!-- Custom Fields Container -->
                    <div id="customFieldsContainer"></div>
                </div>

                <div class="modal-footer">
                    @if (User.IsInRole("Admin") || User.IsInRole("Manager") || User.IsInRole("SubManager") || User.IsInRole("User"))
                    {
                        <button class="btn btn-sm btn-outline-secondary me-auto"
                            onclick="openManageFieldsModal(); event.preventDefault();">
                            <i class="bi bi-gear"></i> Manage Fields
                        </button>
                    }
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" onclick="submitCreateTask()">Create</button>
                </div>

            </div>
        </div>
    </div>

    <!-- EDIT TASK MODAL -->
    <div class="modal fade" id="editTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Edit Task</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" id="editTaskId" />

                    <div class="mb-3" id="groupEditTaskTitle">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <label class="form-label mb-0" id="labelEditTaskTitle">Title</label>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-link text-secondary p-0 me-2" title="Rename Title" onclick="renameField('labelEditTaskTitle')">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button type="button" class="btn btn-link text-danger p-0" title="Delete Title" onclick="hideField('groupEditTaskTitle')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                        </div>
                        <input type="text" id="editTaskTitle" class="form-control" required />
                    </div>

                    <div class="mb-3" id="groupEditTaskDescription">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <label class="form-label mb-0" id="labelEditTaskDescription">Description</label>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-link text-secondary p-0 me-2" title="Rename Description" onclick="renameField('labelEditTaskDescription')">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button type="button" class="btn btn-link text-danger p-0" title="Delete Description" onclick="hideField('groupEditTaskDescription')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                        </div>
                        <textarea id="editTaskDescription" class="form-control" rows="4"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3" id="groupEditTaskPriority">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <label class="form-label mb-0" id="labelEditTaskPriority">Priority</label>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-link text-secondary p-0 me-2" title="Rename Priority" onclick="renameField('labelEditTaskPriority')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button type="button" class="btn btn-link text-danger p-0" title="Delete Priority" onclick="hideField('groupEditTaskPriority')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                            </div>
                            <select id="editTaskPriority" class="form-select">
                                <option value="0">Low</option>
                                <option value="1">Medium</option>
                                <option value="2">High</option>
                                <option value="3">Critical</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3" id="groupEditTaskDueDate" style="display: @(Model?.TeamSettings?.IsDueDateVisible ?? true ? "block" : "none")">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <label class="form-label mb-0" id="labelEditTaskDueDate">Due Date & Time</label>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-link text-secondary p-0 me-2" title="Rename Due Date" onclick="renameField('labelEditTaskDueDate')">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button type="button" class="btn btn-link text-danger p-0" title="Delete Due Date" onclick="hideField('groupEditTaskDueDate')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <input type="datetime-local" id="editTaskDueDate" class="form-control" />
                        </div>
                        <div class="col-md-6 mb-3" id="groupEditTaskAssignTo">
                             <div class="d-flex justify-content-between align-items-center mb-1">
                                <label class="form-label mb-0" id="labelEditTaskAssignTo">Assign To</label>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-link text-secondary p-0 me-2" title="Rename Assign To" onclick="renameField('labelEditTaskAssignTo')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button type="button" class="btn btn-link text-danger p-0" title="Delete Assign To" onclick="hideField('groupEditTaskAssignTo')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                            </div>
                            <select id="editTaskAssignedTo" class="form-select">
                                <option value="">-- Unassigned --</option>
                                @if (Model != null && Model.AssignableUsers != null)
                                {
                                    foreach (var u in Model.AssignableUsers)
                                    {
                                        <option value="@u.Id">@u.UserName</option>
                                    }
                                }
                            </select>
                        </div>
                    </div>

                    <!-- Custom Fields Container -->
                    <div id="editCustomFieldsContainer"></div>
                </div>

                <div class="modal-footer">
                    @if (User.IsInRole("Admin") || User.IsInRole("Manager") || User.IsInRole("SubManager") || User.IsInRole("User"))
                    {
                        <button class="btn btn-sm btn-outline-secondary me-auto"
                            onclick="openManageFieldsModal(); event.preventDefault();">
                            <i class="bi bi-gear"></i> Manage Fields
                        </button>
                    }
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" onclick="submitEditTask()">Save Changes</button>
                </div>

            </div>
        </div>
    </div>


    <div class="modal fade" id="assignTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Assign Task</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" id="assignTaskId" />

                    <label class="form-label">Assign to</label>
                    <select id="assignUserSelect" class="form-select">
                        <option value="">-- Select User --</option>

                        @if (Model != null && Model.AssignableUsers != null && Model.AssignableUsers.Any())
                        {
                            foreach (var u in Model.AssignableUsers)
                            {
                                <option value="@u.Id">@u.UserName</option>
                            }
                        }
                        else
                        {
                            <option disabled>No users available</option>
                        }



                    </select>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button class="btn btn-primary" onclick="assignTask()">
                        Assign
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- CREATE PROJECT MODAL -->
    <div class="modal fade" id="createProjectModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-folder-plus me-2"></i>Create Project</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Project Name</label>
                        <input type="text" id="newProjectName" class="form-control" placeholder="Enter project name" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description (optional)</label>
                        <textarea id="newProjectDescription" class="form-control" rows="3"
                            placeholder="Project description"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" onclick="submitCreateProject()">Create Project</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MANAGE CUSTOM FIELDS MODAL (Admin Only) -->
    <div class="modal fade" id="manageFieldsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-sliders me-2"></i>Manage Custom Fields</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- SYSTEM FIELDS VISIBILITY -->
                    <div class="card mb-3 border-info shadow-sm">
                        <div class="card-header bg-info text-white py-2">
                            <i class="bi bi-toggle-on me-1"></i> System Fields Visibility
                        </div>
                        <div class="card-body py-2">
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="showPriorityCheckbox" @(Model?.TeamSettings?.IsPriorityVisible ?? true ? "checked" : "") onchange="updateTeamSettings()">
                                <label class="form-check-label" for="showPriorityCheckbox">Show Priority Dropdown & Badge</label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="showDueDateCheckbox" @(Model?.TeamSettings?.IsDueDateVisible ?? true ? "checked" : "") onchange="updateTeamSettings()">
                                <label class="form-check-label" for="showDueDateCheckbox">Show Due Date Picker & Badge</label>
                            </div>
                        </div>
                    </div>

                    <!-- Existing Fields List -->
                    <h6 class="mb-3">Existing Fields</h6>
                    <div id="fieldsList" class="mb-4">
                        <!-- Dynamically loaded fields -->
                    </div>

                    <!-- Add New Field Form -->
                    <h6 class="mb-3 border-top pt-3">Add New Field</h6>
                    <div class="row g-3">
                        <div class="col-md-5">
                            <label class="form-label">Field Name</label>
                            <input type="text" id="newFieldName" class="form-control"
                                placeholder="e.g., Estimated Hours" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Field Type</label>
                            <select id="newFieldType" class="form-select">
                                <option value="Text">Text</option>
                                <option value="Number">Number</option>
                                <option value="Date">Date</option>
                                <option value="Time">Time</option>
                                <option value="DateTime">Date & Time</option>
                                <option value="Dropdown">Dropdown</option>
                                <option value="Image">Image</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="newFieldRequired" />
                                <label class="form-check-label" for="newFieldRequired">
                                    Required
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Dropdown Options Section (Hidden by default) -->
                    <div id="newFieldOptionsSection" class="mt-3 p-3 bg-light border rounded d-none">
                        <label class="form-label d-flex justify-content-between align-items-center">
                            Dropdown Options
                            <button type="button" class="btn btn-sm btn-link p-0" onclick="addDropdownOptionRow()">
                                <i class="bi bi-plus-circle me-1"></i>Add Option
                            </button>
                        </label>
                        <div id="newFieldOptionsList">
                            <!-- Option rows will be added here -->
                        </div>
                        <small class="text-muted">Users will pick one of these from a list.</small>
                    </div>

                    <button class="btn btn-sm btn-success mt-3" onclick="createNewField()">
                        <i class="bi bi-plus-lg"></i> Add Field
                    </button>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════ EXCEL IMPORT MODAL ═══════ -->
    <div class="modal fade" id="excelImportModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
                <div class="modal-header" style="background: linear-gradient(135deg, #0d9488, #0891b2); border-radius: 16px 16px 0 0;">
                    <h5 class="modal-title text-white">
                        <i class="bi bi-file-earmark-spreadsheet me-2"></i>Import Tasks from Excel
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" onclick="resetExcelImport()"></button>
                </div>
                <div class="modal-body p-0">
                    <!-- Tab Navigation -->
                    <ul class="nav nav-tabs px-4 pt-3" id="importTabs">
                        <li class="nav-item">
                            <button class="nav-link active" data-tab="upload" onclick="switchImportTab('upload')">
                                <i class="bi bi-cloud-arrow-up me-1"></i> Upload
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-tab="history" onclick="switchImportTab('history')">
                                <i class="bi bi-clock-history me-1"></i> Import History
                            </button>
                        </li>
                    </ul>

                    <!-- UPLOAD TAB -->
                    <div id="importTab-upload" class="import-tab-content p-4">
                        <input type="hidden" id="importTeamName" />

                        <!-- Step 1: Upload Zone -->
                        <div id="excelUploadStep">
                            <div id="excelDropZone" class="excel-drop-zone"
                                 ondrop="handleExcelDrop(event)"
                                 ondragover="handleExcelDragOver(event)"
                                 ondragleave="handleExcelDragLeave(event)">
                                <div class="drop-zone-content">
                                    <i class="bi bi-cloud-arrow-up-fill drop-zone-icon"></i>
                                    <h5>Drag & Drop Excel File Here</h5>
                                    <p class="text-muted mb-3">or click to browse — supports .xlsx files</p>
                                    <label class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-folder2-open me-1"></i> Browse Files
                                        <input type="file" id="excelFileInput" accept=".xlsx,.xls"
                                               style="display:none;" onchange="handleExcelFileSelect(this)" />
                                    </label>
                                </div>
                            </div>
                            <div id="excelFileInfo" class="file-info-bar d-none">
                                <div class="d-flex align-items-center gap-2">
                                    <i class="bi bi-file-earmark-excel-fill text-success fs-4"></i>
                                    <div>
                                        <div class="fw-bold" id="excelFileName"></div>
                                        <small class="text-muted" id="excelFileSize"></small>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-outline-danger" onclick="clearExcelFile()">
                                    <i class="bi bi-x-lg"></i> Remove
                                </button>
                            </div>
                        </div>

                        <!-- Step 2: Preview -->
                        <div id="excelPreviewStep" class="d-none">
                            <div class="preview-stats d-flex gap-3 mb-3">
                                <div class="stat-card">
                                    <i class="bi bi-table text-primary"></i>
                                    <div>
                                        <div class="stat-value" id="previewTotalRows">0</div>
                                        <small class="text-muted">Total Rows</small>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <i class="bi bi-columns-gap text-info"></i>
                                    <div>
                                        <div class="stat-value" id="previewTotalCols">0</div>
                                        <small class="text-muted">Columns</small>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <i class="bi bi-check-circle text-success"></i>
                                    <div>
                                        <div class="stat-value">Ready</div>
                                        <small class="text-muted">Status</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Column Mapping -->
                            <div class="mapping-section mb-3">
                                <h6 class="fw-bold mb-2"><i class="bi bi-signpost-2 me-1"></i> Column Mapping</h6>
                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <label class="form-label small fw-bold">Title Column</label>
                                        <select id="mappingTitleCol" class="form-select form-select-sm">
                                            <option value="-1">Auto (first column)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label small fw-bold">Description Column</label>
                                        <select id="mappingDescCol" class="form-select form-select-sm">
                                            <option value="-1">None</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label small fw-bold">Target Board Column</label>
                                        <select id="importTargetColumn" class="form-select form-select-sm">
                                        </select>
                                    </div>
                                </div>
                                <small class="text-muted mt-1 d-block">
                                    <i class="bi bi-info-circle me-1"></i>
                                    All other Excel columns will be created as custom fields on the board automatically.
                                </small>
                            </div>

                            <!-- Preview Table -->
                            <div class="preview-table-wrapper">
                                <h6 class="fw-bold mb-2"><i class="bi bi-eye me-1"></i> Data Preview (first 5 rows)</h6>
                                <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                                    <table class="table table-sm table-bordered table-hover mb-0" id="previewTable">
                                        <thead id="previewTableHead" class="table-dark"></thead>
                                        <tbody id="previewTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Progress -->
                        <div id="excelProgressStep" class="d-none">
                            <div class="text-center py-4">
                                <div class="import-progress-circle mb-3">
                                    <i class="bi bi-gear-fill spinning-icon"></i>
                                </div>
                                <h5 class="fw-bold" id="importProgressTitle">Importing Tasks...</h5>
                                <p class="text-muted" id="importProgressSubtitle">Please wait while we process your Excel file</p>
                                <div class="progress mt-3" style="height: 8px; border-radius: 4px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" id="importProgressBar"
                                         role="progressbar" style="width: 0%; background: linear-gradient(135deg, #0d9488, #0891b2);"></div>
                                </div>
                                <small class="text-muted mt-2 d-block" id="importProgressText">Starting...</small>
                            </div>
                        </div>

                        <!-- Step 4: Results -->
                        <div id="excelResultStep" class="d-none">
                            <div class="text-center py-3">
                                <div id="resultIconSuccess" class="d-none">
                                    <div class="result-icon result-success"><i class="bi bi-check-circle-fill"></i></div>
                                    <h4 class="fw-bold text-success mt-2">Import Successful!</h4>
                                </div>
                                <div id="resultIconPartial" class="d-none">
                                    <div class="result-icon result-warning"><i class="bi bi-exclamation-triangle-fill"></i></div>
                                    <h4 class="fw-bold text-warning mt-2">Import Completed with Errors</h4>
                                </div>
                                <div id="resultIconFail" class="d-none">
                                    <div class="result-icon result-danger"><i class="bi bi-x-circle-fill"></i></div>
                                    <h4 class="fw-bold text-danger mt-2">Import Failed</h4>
                                </div>

                                <div class="result-stats d-flex justify-content-center gap-4 mt-3 mb-3">
                                    <div class="text-center">
                                        <div class="fs-3 fw-bold text-success" id="resultSuccessCount">0</div>
                                        <small class="text-muted">Imported</small>
                                    </div>
                                    <div class="text-center">
                                        <div class="fs-3 fw-bold text-danger" id="resultErrorCount">0</div>
                                        <small class="text-muted">Errors</small>
                                    </div>
                                    <div class="text-center">
                                        <div class="fs-3 fw-bold text-info" id="resultDuration">0s</div>
                                        <small class="text-muted">Duration</small>
                                    </div>
                                </div>

                                <p class="text-muted" id="resultMessage"></p>

                                <div id="resultErrors" class="d-none mt-3">
                                    <h6 class="fw-bold text-danger"><i class="bi bi-bug me-1"></i> Error Details</h6>
                                    <div class="bg-light border rounded p-2 text-start small" id="resultErrorList"
                                         style="max-height: 120px; overflow-y: auto;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- HISTORY TAB -->
                    <div id="importTab-history" class="import-tab-content p-4 d-none">
                        <div id="importHistoryContent">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="text-muted mt-2">Loading import history...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer border-0 px-4 pb-4">
                    <button class="btn btn-secondary" data-bs-dismiss="modal" onclick="resetExcelImport()">Close</button>
                    <button class="btn btn-primary px-4 d-none" id="btnPreviewExcel" onclick="previewExcelFile()">
                        <i class="bi bi-eye me-1"></i> Preview Data
                    </button>
                    <button class="btn px-4 d-none" id="btnStartImport" onclick="startExcelImport()"
                            style="background: linear-gradient(135deg, #0d9488, #0891b2); color: #fff; font-weight: 600;">
                        <i class="bi bi-download me-1"></i> Import <span id="btnImportCount"></span> Tasks
                    </button>
                    <button class="btn btn-outline-primary px-4 d-none" id="btnImportMore" onclick="resetExcelImport()">
                        <i class="bi bi-plus-lg me-1"></i> Import Another File
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* ═══════ EXCEL IMPORT MODAL STYLES ═══════ */
        .excel-drop-zone {
            border: 2px dashed #0d9488;
            border-radius: 16px;
            padding: 48px 24px;
            text-align: center;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f0fdfa, #ecfdf5);
            cursor: pointer;
        }
        .excel-drop-zone.drag-over {
            border-color: #0891b2;
            background: linear-gradient(135deg, #ccfbf1, #cffafe);
            transform: scale(1.01);
        }
        .drop-zone-icon {
            font-size: 3rem;
            color: #0d9488;
            display: block;
            margin-bottom: 12px;
        }
        .file-info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #f0fdfa;
            border: 1px solid #99f6e4;
            border-radius: 12px;
            margin-top: 12px;
        }
        .stat-card {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f8faff;
            border: 1px solid #e8eaff;
            border-radius: 10px;
            padding: 12px 16px;
            flex: 1;
        }
        .stat-card i { font-size: 1.5rem; }
        .stat-value { font-size: 1.2rem; font-weight: 700; color: #1a1a2e; }
        .mapping-section {
            background: #f8f9ff;
            border: 1px solid #e8eaff;
            border-radius: 12px;
            padding: 16px;
        }
        .preview-table-wrapper {
            background: #fff;
            border: 1px solid #e8eaff;
            border-radius: 12px;
            padding: 16px;
        }
        #previewTable th {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        #previewTable td {
            font-size: 0.8rem;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .import-progress-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0d9488, #0891b2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }
        .spinning-icon {
            font-size: 2rem;
            color: #fff;
            animation: spin 2s linear infinite;
        }
        @@keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .result-icon {
            font-size: 3rem;
        }
        .result-success { color: #10b981; }
        .result-warning { color: #f59e0b; }
        .result-danger { color: #ef4444; }
        .import-tab-content { min-height: 300px; }
        .import-history-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #f8faff;
            border: 1px solid #e8eaff;
            border-radius: 10px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }
        .import-history-card:hover {
            background: #eef2ff;
            border-color: #c7d2fe;
        }
        #importTabs .nav-link {
            color: #6b7280;
            font-weight: 600;
            font-size: 0.9rem;
            border: none;
            border-bottom: 2px solid transparent;
            padding: 8px 16px;
        }
        #importTabs .nav-link.active {
            color: #0d9488;
            border-bottom-color: #0d9488;
            background: none;
        }
    </style>

</div> <!-- /.app-wrapper -->

<!-- Task History Modal -->
<div class="modal fade" id="taskHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-clock-history"></i> Task History - <span id="historyModalTaskId"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div id="historyTimeline" class="p-3">
                    <!-- Timeline content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>


    <!-- ═══════ BOARD PERMISSION MODAL (Admin Only) ═══════ -->
    <div class="modal fade" id="boardPermissionModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
                <div class="modal-header bg-dark text-white" style="border-radius: 16px 16px 0 0;">
                    <h5 class="modal-title">
                        <i class="bi bi-shield-lock me-2 text-info"></i>Board Permissions
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light text-muted small text-uppercase fw-bold">
                                <tr>
                                    <th class="ps-4 py-3">Member</th>
                                    <th class="text-center small text-uppercase fw-bold text-muted" style="font-size: 0.65rem;">Add Col</th>
                                    <th class="text-center small text-uppercase fw-bold text-muted" style="font-size: 0.65rem;">Rename</th>
                                    <th class="text-center small text-uppercase fw-bold text-muted" style="font-size: 0.65rem;">Reorder</th>
                                    <th class="text-center small text-uppercase fw-bold text-muted" style="font-size: 0.65rem;">Del Col</th>
                                    <th class="text-center small text-uppercase fw-bold text-muted" style="font-size: 0.65rem;">Edit All</th>
                                    <th class="text-center small text-uppercase fw-bold text-muted" style="font-size: 0.65rem;">Delete Task</th>
                                    <th class="text-center small text-uppercase fw-bold text-muted" style="font-size: 0.65rem;">Review</th>
                                    <th class="text-center small text-uppercase fw-bold text-muted" style="font-size: 0.65rem;">Import Excel</th>
                                    <th class="text-center small text-uppercase fw-bold text-muted" style="font-size: 0.65rem;">Assign</th>
                                    <th class="text-center small text-uppercase fw-bold text-muted" style="font-size: 0.65rem;">All</th>
                                </tr>
                            </thead>
                            <tbody id="permissionTableBody">
                                <!-- Loaded via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button class="btn btn-secondary px-4" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>


<script>
    // Define admin status for JS
    const isAdmin = @(User.IsInRole("Admin") ? "true" : "false");
    const isManager = @((User.IsInRole("Manager") || User.IsInRole("Sub-Manager")) ? "true" : "false");
    window.isAdmin = isAdmin;
    console.log("Admin status loaded:", window.isAdmin);
</script>

<!-- MOBILE SIDEBAR TOGGLE BUTTON -->
<button class="sidebar-toggle d-md-none" id="sidebarToggle" onclick="toggleSidebar()" aria-label="Toggle sidebar">
    <i class="bi bi-list"></i>
</button>

<script>
    // ===== SIDEBAR TOGGLE (MOBILE) =====
    function toggleSidebar() {
        const sidebar = document.getElementById('leftSidebar');
        const overlay = document.getElementById('sidebarOverlay');
        sidebar.classList.toggle('open');
        overlay.classList.toggle('active');
    }

    function closeSidebar() {
        const sidebar = document.getElementById('leftSidebar');
        const overlay = document.getElementById('sidebarOverlay');
        sidebar.classList.remove('open');
        overlay.classList.remove('active');
    }

    // Close sidebar when a team/project is selected on mobile
    document.addEventListener('click', function (e) {
        if (window.innerWidth < 768 && e.target.closest('.team-btn, .project-btn')) {
            closeSidebar();
        }
    });
</script>


<script>
    // expose admin flag to JS as boolean
    const __isTasksAdmin = @((isAdmin).ToString().ToLower());

    // ===== ADMIN TEAM MANAGEMENT =====

    function toggleAddTeamInput() {
        const container = document.getElementById('addTeamInputContainer');
        const input = document.getElementById('newTeamNameInput');

        if (container.style.display === 'none') {
            container.style.display = 'block';
            input.value = '';
            input.focus();

            // Enter key to submit
            input.onkeydown = function (e) {
                if (e.key === 'Enter') submitCreateTeam();
            };
        } else {
            container.style.display = 'none';
        }
    }

    function submitCreateTeam() {
        const input = document.getElementById('newTeamNameInput');
        const name = input.value.trim();

        if (!name) {
            toggleAddTeamInput();
            return;
        }

        fetch('/Teams/Create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ Name: name })
        })
            .then(res => {
                if (!res.ok) return res.text().then(t => { throw new Error(t); });
                return res.json();
            })
            .then(() => {
                toggleAddTeamInput();
                loadAdminTeamList(); // Refresh list
            })
            .catch(err => {
                console.error(err);
                alert('Failed to add team: ' + err.message);
            });
    }

    function loadAdminTeamList(autoLoadFirst = false) {
        const container = document.getElementById('adminTeamList');
        if (!container) return;

        fetch('/Teams/GetAll')
            .then(res => res.json())
            .then(teams => {
                if (teams.length === 0) {
                    container.innerHTML = '<div class="text-muted ps-4 py-2 small">No teams found</div>';
                    return;
                }

                container.innerHTML = teams.map(t => `
               <div class="d-flex align-items-center justify-content-between group-hover-container px-0">
                    <button type="button"
                            class="list-group-item list-group-item-action bg-dark text-white team-btn flex-grow-1 text-start border-0 py-2 ps-4"
                            data-team="${t.name}"
                            onclick="loadTeamBoard('${t.name}')">
                        <i class="bi bi-people me-2"></i> ${t.name}
                    </button>

                    <button class="btn btn-sm btn-link text-danger p-0 me-2" 
                            style="opacity:0.5;"
                            onmouseover="this.style.opacity=1"
                            onmouseout="this.style.opacity=0.5"
                            onclick="deleteTeam(${t.id}, '${t.name}')" 
                            title="Delete Team">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `).join('');

                // Re-highlight if needed
                if (typeof currentTeamName !== 'undefined') {
                    document.querySelectorAll(`.team-btn[data-team="${currentTeamName}"]`)
                        .forEach(b => b.classList.add('active'));
                }

                // Auto-load first team if requested
                if (autoLoadFirst && teams.length > 0) {
                    loadTeamBoard(teams[0].name);
                }
            });
    }

    function deleteTeam(id, name) {
        if (!confirm(`Delete team '${name}'? This cannot be undone.`)) return;

        fetch('/Teams/Delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(id)
        })
            .then(res => {
                if (!res.ok) throw new Error('Failed to delete');
                loadAdminTeamList();
                // clear board if deleted team was active
                const boardContainer = document.getElementById('taskBoardContainer');
                boardContainer.innerHTML = '';
            })
            .catch(err => alert(err.message));
    }

    // Load initially if Admin
    document.addEventListener('DOMContentLoaded', function () {
        if (__isTasksAdmin) {
            loadAdminTeamList(true);
        }
    });

    // open add column modal (admin only)
    function openAddColumnModal(teamName) {
        if (!__isTasksAdmin && (!window.boardPermissions || !window.boardPermissions.canAddColumn)) return;
        document.getElementById("addColumnTeam").value = teamName;
        document.getElementById("newColumnName").value = "";

        const modal = new bootstrap.Modal(document.getElementById("addColumnModal"));
        modal.show();
    }

    // save new column (admin only)
    document.getElementById('addColumnSubmit')?.addEventListener('click', function () {
        if (!__isTasksAdmin && (!window.boardPermissions || !window.boardPermissions.canAddColumn)) return;
        const team = document.getElementById('addColumnTeam').value;
        const columnName = document.getElementById('newColumnName').value.trim();
        if (!columnName) { alert('Column name is required'); return; }

        fetch('/Tasks/AddColumn', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ team: team, columnName: columnName })
        })
            .then(res => { if (!res.ok) throw new Error('Failed'); return res.text(); })
            .then(() => {
                bootstrap.Modal.getInstance(document.getElementById('addColumnModal'))?.hide();
                // reload the board for the team
                loadTeamBoard(team);
            })
            .catch(() => alert('Failed to add column'));
    });
</script>

@{
    ViewData["Title"] = "Task Board";
}


<link rel="stylesheet" href="~/css/taskHistory.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="~/js/customFields.js"></script>
<script src="~/js/taskHistory.js"></script>
<script src="~/js/column_filter.js"></script>
<script src="~/js/index_ui.js"></script>
<script src="~/js/board-permissions.js"></script>

<script>
    function enableColumnDrag() {
        if (!__isTasksAdmin) return;

        const board = document.querySelector('#kanbanBoard');
        if (!board) {
            console.warn('Kanban board not found');
            return;
        }

        // 🔥 SAFETY: remove old sortable safely
        if (board._sortableInstance) {
            board._sortableInstance.destroy();
            board._sortableInstance = null;
        }

        board._sortableInstance = new Sortable(board, {
            animation: 150,
            direction: 'horizontal',
            draggable: '.kanban-column:not(.col-history)',
            handle: '.column-drag-handle',
            filter: '.col-history',

            onEnd: function () {
                const columnIds = Array.from(
                    board.querySelectorAll('.kanban-column:not(.col-history)')
                ).map(c => parseInt(c.dataset.columnId)).filter(id => !isNaN(id));

                if (columnIds.length === 0) return;

                fetch('/Tasks/ReorderColumns', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(columnIds)
                })
                    .then(res => {
                        if (res.ok) {
                            showToast('✅ Column order updated!', 'success');
                        } else {
                            showToast('Failed to save column order', 'danger');
                        }
                    })
                    .catch(() => showToast('Failed to save column order', 'danger'));
            }
        });

    }


    // NOTE: openCreateTaskModal and submitCreateTask are defined later in this file.
    // Removed duplicate definitions to avoid function override/conflict

    function startRename(columnId) {
        if (!__isTasksAdmin) return;
        document.getElementById(`column-title-${columnId}`).style.display = 'none';
        document.getElementById(`column-rename-${columnId}`).style.display = 'flex';
    }

    function cancelRename(columnId) {
        document.getElementById(`column-rename-${columnId}`).style.display = 'none';
        document.getElementById(`column-title-${columnId}`).style.display = 'block';
    }

    function saveColumnName(columnId) {
        if (!__isTasksAdmin) return;
        const input = document.getElementById(`column-input-${columnId}`);
        const newName = input?.value?.trim();
        if (!newName) { alert('Column name required'); return; }

        fetch('/Tasks/RenameColumn', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ columnId: columnId, name: newName })
        })
            .then(res => { if (!res.ok) throw new Error(); return res.text(); })
            .then(() => {
                document.getElementById(`column-title-${columnId}`).innerText = newName;
                cancelRename(columnId);
            })
            .catch(() => alert('Rename failed'));
    }

    function confirmDeleteColumn(columnId) {
        if (!__isTasksAdmin) return;
        if (!confirm('Delete this column?')) return;
        fetch('/Tasks/DeleteColumn', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ columnId }) })
            .then(res => { if (!res.ok) return res.text().then(t => { throw new Error(t); }); return res.text(); })
            .then(() => document.querySelector(`[data-column-id='${columnId}']`)?.remove())
            .catch(err => alert(err.message));
    }
</script>

<script>
    // ════════ SignalR Real-Time Logic ════════
    var taskHubConnection = new signalR.HubConnectionBuilder()
        .withUrl("/taskHub")
        .withAutomaticReconnect()
        .build();

    taskHubConnection.on("TaskMoved", function (data) {
        console.log("Task moved received:", data);
        handleTaskMovedUpdate(data);
    });

    taskHubConnection.on("TaskReviewed", function (data) {
        console.log("Task reviewed received:", data);
        handleTaskReviewedUpdate(data);
    });

    taskHubConnection.on("TaskRemoved", function (data) {
        console.log("Task removed received:", data);
        handleTaskRemovedUpdate(data);
    });

    taskHubConnection.on("TaskAdded", function (data) {
        console.log("Task added received:", data);
        handleTaskAddedUpdate(data);
    });

    taskHubConnection.on("TaskAssigned", function (data) {
        console.log("Task assigned received:", data);
        handleTaskAssignedUpdate(data);
    });

    taskHubConnection.on("PermissionsUpdated", function (userId, teamName) {
        console.log("Permissions updated received for:", userId, teamName);
        const currentUserId = '@UserManager.GetUserId(User)';
        if (userId === currentUserId && window.currentTeamName && window.currentTeamName.toLowerCase().trim() === teamName.toLowerCase().trim()) {
            if (typeof loadTeamBoard === "function") {
                loadTeamBoard(window.currentTeamName);
                if (typeof showToast === "function") {
                    showToast("🔔 Your board permissions have been updated.", "info");
                }
            }
        }
    });

    taskHubConnection.start()
        .then(() => {
            console.log("SignalR Connected");
            if (window.currentTeamName) {
                taskHubConnection.invoke("JoinTeamGroup", window.currentTeamName);
            }
        })
        .catch(err => console.error("SignalR Connection Error: ", err));

    function handleTaskMovedUpdate(data) {
        const card = document.querySelector(`.task-card[data-task-id="${data.taskId}"]`);
        if (!card) return;

        const targetColumn = document.querySelector(`.kanban-column[data-column-id="${data.newColumnId}"]`);
        if (!targetColumn) return;

        const taskList = targetColumn.querySelector('.kanban-tasks');
        if (!taskList) return;

        // Move the element
        taskList.appendChild(card);
        
        // Update attributes
        card.dataset.columnId = data.newColumnId;

        // UI Adjustments (Buttons / Badges)
        const colName = data.columnName.toLowerCase().trim();
        const isReview = colName === 'review';
        const isCompleted = colName === 'completed';
        const isRestricted = isReview || isCompleted;

        const assignBtn = card.querySelector('.action-btn-assign');
        const editBtn = card.querySelector('.action-btn-edit');
        const reviewBtn = card.querySelector('.action-btn-review');
        const archiveBtn = card.querySelector('.action-btn-archive');

        if (assignBtn) assignBtn.style.display = isRestricted ? 'none' : 'inline-flex';
        if (editBtn) editBtn.style.display = isRestricted ? 'none' : 'inline-flex';
        if (reviewBtn) reviewBtn.style.display = isReview ? 'inline-flex' : 'none';
        if (archiveBtn) archiveBtn.style.display = isCompleted ? 'inline-flex' : 'none';

        const pendingBadge = card.querySelector('.review-badge-pending');
        const failBadge = card.querySelector('.review-badge-fail');
        const passBadge = card.querySelector('.review-badge-pass');

        if (isReview) {
            if (pendingBadge) pendingBadge.style.display = 'inline-flex';
            if (failBadge) failBadge.style.display = 'none';
            if (passBadge) passBadge.style.display = 'none';
        } else {
            if (pendingBadge) pendingBadge.style.display = 'none';
        }

        updateColumnCounts();
        showToast(`Task #${data.taskId} moved to ${data.columnName}`, 'info');
    }

    function handleTaskReviewedUpdate(data) {
        const card = document.querySelector(`.task-card[data-task-id="${data.taskId}"]`);
        if (!card) return;

        const passBadge = card.querySelector('.review-badge-pass');
        const failBadge = card.querySelector('.review-badge-fail');
        const pendingBadge = card.querySelector('.review-badge-pending');

        if (data.passed) {
            if (passBadge) passBadge.style.display = 'inline-flex';
            if (failBadge) failBadge.style.display = 'none';
        } else {
            if (failBadge) failBadge.style.display = 'inline-flex';
            if (passBadge) passBadge.style.display = 'none';
        }
        if (pendingBadge) pendingBadge.style.display = 'none';

        // If moved columns due to review
        if (data.newColumnId) {
            const currentColumnId = parseInt(card.dataset.columnId);
            if (currentColumnId !== data.newColumnId) {
                handleTaskMovedUpdate({
                    taskId: data.taskId,
                    newColumnId: data.newColumnId,
                    columnName: data.columnName
                });
            }
        }
    }

    function handleTaskRemovedUpdate(data) {
        const card = document.querySelector(`.task-card[data-task-id="${data.taskId}"]`);
        if (card) {
            card.remove();
            updateColumnCounts();
            showToast(`Task #${data.taskId} moved to another team`, 'info');
        }
    }

    function handleTaskAddedUpdate(data) {
        // Prevent duplicates
        if (document.querySelector(`.task-card[data-task-id="${data.taskId}"]`)) return;

        fetch(`/Tasks/GetTaskCardPartial?taskId=${data.taskId}`)
            .then(res => {
                if (!res.ok) throw new Error("Failed to fetch card");
                return res.text();
            })
            .then(html => {
                const targetColumn = document.querySelector(`.kanban-column[data-column-id="${data.columnId}"]`);
                if (!targetColumn) return;

                const taskList = targetColumn.querySelector('.kanban-tasks');
                if (!taskList) return;

                taskList.insertAdjacentHTML('afterbegin', html);
                updateColumnCounts();
                showToast(`New task #${data.taskId} added to this board`, 'success');
            })
            .catch(err => console.error("Error adding task:", err));
    }

    function handleTaskAssignedUpdate(data) {
        const card = document.querySelector(`.task-card[data-task-id="${data.taskId}"]`);
        if (!card) return;

        fetch(`/Tasks/GetTaskCardPartial?taskId=${data.taskId}`)
            .then(res => res.text())
            .then(html => {
                // Replace entire card to ensure all UI elements are correct
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                const newCard = tempDiv.firstElementChild;
                card.parentNode.replaceChild(newCard, card);
                showToast(`Task #${data.taskId} assigned to ${data.assignedTo}`, 'success');
            })
            .catch(err => console.error("Error updating assigned task:", err));
    }

    function loadTeamBoard(team) {
        // ✅ JOIN GROUP
        if (taskHubConnection.state === signalR.HubConnectionState.Connected) {
            if (window.currentTeamName) {
                taskHubConnection.invoke("LeaveTeamGroup", window.currentTeamName);
            }
            taskHubConnection.invoke("JoinTeamGroup", team);
        }

        // ✅ SAVE CURRENT TEAM
        window.currentTeamName = team;

        const container = document.getElementById('taskBoardContainer');
        if (!container) return;

        container.innerHTML = "<div class='text-center py-5'><div class='spinner-border text-info mb-2'></div><br><span class='text-muted'>Loading board...</span></div>";

        fetch(`/Tasks/TeamBoard?team=${encodeURIComponent(team)}`)
            .then(res => {
                if (!res.ok) throw new Error("Failed to load board");
                return res.text();
            })
            .then(html => {
                container.innerHTML = html;

                // highlight active team button
                document.querySelectorAll('.team-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll(`.team-btn[data-team]`).forEach(b => {
                    if (b.dataset.team === team) b.classList.add('active');
                });

                // Execute scripts from the dynamically loaded content
                const scripts = container.querySelectorAll('script');
                scripts.forEach(script => {
                    const newScript = document.createElement('script');
                    if (script.src) {
                        newScript.src = script.src;
                    } else {
                        newScript.textContent = script.textContent;
                    }
                    document.body.appendChild(newScript);
                    // Remove after execution to avoid duplicates if re-rendered
                    setTimeout(() => newScript.remove(), 100);
                });

                if (typeof syncBoardPermissions === "function") {
                    syncBoardPermissions();
                }
                if (typeof enableColumnDrag === "function") {
                    enableColumnDrag();
                }
                if (typeof enableTaskDragDrop === "function") {
                    enableTaskDragDrop();
                }
            })
            .catch(err => {
                container.innerHTML = "<div class='text-danger p-4'>Error loading board. Please try again.</div>";
                console.error(err);
            });
    }
</script>


<script>
    function focusColumn(columnId) {
        const board = document.getElementById('kanbanBoard');
        const backBtn = document.getElementById('backToBoardBtn');
        if (!board) return;

        board.classList.add('single-column-view');
        board.querySelectorAll('.kanban-column').forEach(col => {
            const id = parseInt(col.dataset.columnId);
            if (id === columnId) { col.classList.add('focused-column'); col.classList.remove('hidden-column'); }
            else { col.classList.remove('focused-column'); col.classList.add('hidden-column'); }
        });
        if (backBtn) backBtn.style.display = 'inline-block';
    }


    function focusTask(taskId) {
        taskId = parseInt(taskId);
        if (isNaN(taskId)) return;

        const body = document.getElementById('taskOverviewBody');
        const headerActions = document.getElementById('taskOverviewActions');

        body.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';
        if (headerActions) headerActions.innerHTML = '';

        const modal = new bootstrap.Modal(document.getElementById('taskOverviewModal'));
        modal.show();

        fetch(`/Tasks/GetTaskDetail?id=${taskId}`)
            .then(res => {
                if (!res.ok) throw new Error('Task not found');
                return res.json();
            })
            .then(t => {
                const customPriorityObj = (t.customFields || []).find(f => f.fieldName && f.fieldName.trim().toLowerCase() === 'priority');
                const effectivePriority = (customPriorityObj && customPriorityObj.value) ? customPriorityObj.value : t.priority;
                
                const priorityClassMap = { 'low': 'secondary', 'medium': 'info', 'high': 'warning', 'critical': 'danger' };
                const priorityBadgeClass = priorityClassMap[effectivePriority.toLowerCase()] || 'secondary';
                const priorityBadge = `<span class="badge bg-${priorityBadgeClass}">${escapeHtml(effectivePriority.toUpperCase())}</span>`;

                const dueDateBadge = t.dueDate ? 
                    `<span class="badge bg-light text-dark border d-flex align-items-center gap-1">
                        <i class="bi bi-calendar-event text-danger"></i>
                        Due Date: ${formatDate(t.dueDate)}
                    </span>` : '';

                const reviewColors = { 'Passed': 'success', 'Failed': 'danger', 'Pending': 'warning', 'None': 'secondary' };
                const reviewBadge = t.reviewStatus && t.reviewStatus !== 'None' ?
                    `<span class="badge bg-${reviewColors[t.reviewStatus] || 'secondary'}">${escapeHtml(t.reviewStatus)}</span>` : '';

                const colName = (t.column || t.status || "").toLowerCase().trim();
                const isCompleted = colName === 'completed' || colName === 'complete' || colName === 'done';
                const isReview = colName === 'review';

                if (headerActions) {
                    headerActions.innerHTML = `
                        <button class="modal-action-btn-sm btn-modal-history" title="History" onclick="openTaskHistoryFromModal(${t.id})">
                            <i class="bi bi-clock-history"></i>
                        </button>
                        
                        ${(isAdmin || document.getElementById('kanbanBoard')?.dataset.permAssignTask === 'true') && !isCompleted ? `
                        <button class="modal-action-btn-sm btn-modal-assign" title="Assign" onclick="showAssignUIFromModal(${t.id})">
                            <i class="bi bi-person-plus"></i>
                        </button>` : ''}

                        ${!isCompleted || isAdmin ? `
                        <button class="modal-action-btn-sm btn-modal-edit" title="Edit" onclick="openEditTaskFromModal(${t.id})">
                            <i class="bi bi-pencil-square"></i>
                        </button>` : ''}
                    `;
                }

                body.innerHTML = `
                    <div class="d-flex flex-wrap align-items-center gap-3 mb-4">
                        <h4 class="mb-0">${escapeHtml(t.title)}</h4>
                        <div class="d-flex gap-2 flex-wrap align-items-center">
                            ${priorityBadge}
                            ${reviewBadge}
                            ${dueDateBadge}
                            <span class="badge bg-light text-dark border">${escapeHtml(t.column || t.status)}</span>
                        </div>
                    </div>

                    ${t.description ? `<div class="mb-3"><h6 class="text-muted">Description</h6><p class="mb-2">${escapeHtml(t.description)}</p></div>` : ''}

                    ${t.customFields && t.customFields.length > 0 ? `
                        <div class="mb-3">
                            <h6 class="text-muted mb-2">Custom Fields</h6>
                            ${t.customFields.map(f => {
                                const isImage = f.value && (f.value.startsWith('/uploads/') || f.value.toLowerCase().match(/\.(jpg|jpeg|png|gif|webp)$/));
                                return `
                                    <div class="small mb-2">
                                        <strong>${escapeHtml(f.fieldName || '')}:</strong>
                                        ${isImage ? `
                                            <div class="mt-1">
                                                <img src="${f.value}" class="rounded border shadow-sm" style="max-width: 150px; max-height: 150px; cursor: pointer; object-fit: contain;" onclick="window.open('${f.value}', '_blank')" />
                                            </div>
                                        ` : `<span>${escapeHtml(f.value || '')}</span>`}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : ''}

                    ${t.reviewNote ? `<div class="mb-3"><h6 class="text-muted">Review Note</h6><div class="alert alert-warning py-2 mb-0">${escapeHtml(t.reviewNote)}</div></div>` : ''}

                    <div class="border-top pt-3 mb-3">
                        <h6 class="text-muted mb-2">Timeline</h6>
                        <div class="small">
                            ${t.createdAt ? `<div class="mb-1"><i class="bi bi-plus-circle text-primary me-2"></i>Created: ${formatDate(t.createdAt)}</div>` : ''}
                            ${t.assignedAt ? `<div class="mb-1"><i class="bi bi-person text-info me-2"></i>Assigned: ${formatDate(t.assignedAt)}</div>` : ''}
                            ${t.reviewedAt ? `<div class="mb-1"><i class="bi bi-clipboard-check text-warning me-2"></i>Reviewed: ${formatDate(t.reviewedAt)}</div>` : ''}
                            ${t.completedAt ? `<div class="mb-1"><i class="bi bi-check-circle text-success me-2"></i>Completed: ${formatDate(t.completedAt)}</div>` : ''}
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <small class="text-muted d-block">Created By</small>
                                <strong>${escapeHtml(t.createdBy || 'N/A')}</strong>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <small class="text-muted d-block">Assigned To</small>
                                <strong>${escapeHtml(t.assignedTo || 'Unassigned')}</strong>
                            </div>
                        </div>
                        ${t.assignedBy ? `
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <small class="text-muted d-block">Assigned By</small>
                                <strong>${escapeHtml(t.assignedBy)}</strong>
                            </div>
                        </div>` : ''}
                        ${t.reviewedBy ? `
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <small class="text-muted d-block">Reviewed By</small>
                                <strong>${escapeHtml(t.reviewedBy)}</strong>
                            </div>
                        </div>` : ''}
                    </div>
                `;
            })
            .catch(() => {
                body.innerHTML = '<div class="text-danger text-center">Failed to load task details</div>';
            });
    }

    function openEditTaskFromModal(taskId) {
        const modal = bootstrap.Modal.getInstance(document.getElementById('taskOverviewModal'));
        if (modal) modal.hide();
        setTimeout(() => openEditTaskModal(taskId), 350);
    }

    function openTaskHistoryFromModal(taskId) {
        const modal = bootstrap.Modal.getInstance(document.getElementById('taskOverviewModal'));
        if (modal) modal.hide();
        setTimeout(() => {
            if (typeof openTaskHistoryModal === 'function') openTaskHistoryModal(taskId);
        }, 350);
    }

    function showAssignUIFromModal(taskId) {
        const modal = bootstrap.Modal.getInstance(document.getElementById('taskOverviewModal'));
        if (modal) modal.hide();
        setTimeout(() => {
            const card = document.querySelector(`.task-card[data-task-id="${taskId}"]`);
            if (card) {
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                if (typeof showAssignUI === 'function') showAssignUI(taskId);
            }
        }, 400);
    }

    function exitTaskFocus() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('taskOverviewModal'));
        if (modal) modal.hide();
    }



    function resetBoardView() {
        const board = document.getElementById('kanbanBoard');
        const backBtn = document.getElementById('backToBoardBtn');
        if (!board) return;

        // reset column focus
        board.classList.remove('single-column-view');
        board.querySelectorAll('.kanban-column').forEach(col => {
            col.classList.remove('focused-column');
            col.classList.remove('hidden-column');
            col.style.display = 'flex';
        });

        // reset task focus
        board.classList.remove('task-focused-view');
        board.querySelectorAll('.task-card').forEach(task => {
            task.classList.remove('focused-task');
            task.style.display = 'block';
        });

        if (backBtn) backBtn.style.display = 'none';
    }

</script>

<script>
    // Load initially if Admin
    document.addEventListener('DOMContentLoaded', function () {
    @if (isAdmin) {
         // Already handled by loadAdminTeamList(true) above
         <text>
             const teamDropdown = document.getElementById('teamTasksDropdown');
             const teamArrow = document.getElementById('teamArrow');
             if (teamDropdown) teamDropdown.style.display = 'block';
             if (teamArrow) teamArrow.innerText = '▲';
         </text>
    }
    else if (userTeams.Any())
    {
        var firstTeam = userTeams.First();
        <text>
                    // User: Auto-expand My Team and load first assigned team
                    const myDropdown = document.getElementById('myTasksDropdown');
                    const myArrow = document.getElementById('myTasksArrow');
                    if (myDropdown) myDropdown.style.display = 'block';
                    if (myArrow) myArrow.innerText = '▲';

                    // load first team
                    loadTeamBoard('@firstTeam');
        </text>
    }
    });
</script>

<script>
    function openCreateTaskModal(columnId) {
        document.getElementById('taskColumnId').value = columnId;
        document.getElementById('taskTitle').value = '';
        document.getElementById('taskDescription').value = '';
        document.getElementById('taskPriority').value = '1';
        document.getElementById('taskDueDate').value = '';

        const team = window.currentTeamName;

        // Load projects into dropdown
        loadProjectsForTaskModal();

        // Render custom fields into the modal
        if (typeof renderCustomFieldInputs === 'function') {
            try {
                renderCustomFieldInputs('customFieldsContainer', {}, team);
            } catch (e) { console.error(e); }
        }

        new bootstrap.Modal(document.getElementById('createTaskModal')).show();
    }

    // ================= EDIT TASK MODAL =================

    function openEditTaskModal(taskId) {
        const team = window.currentTeamName;
        // Fetch task details
        fetch(`/Tasks/GetTask?id=${taskId}`)
            .then(res => {
                if (!res.ok) throw new Error("Failed to load task details");
                return res.json();
            })
            .then(task => {
                // Populate Modal
                document.getElementById('editTaskId').value = task.id;
                document.getElementById('editTaskTitle').value = task.title;
                document.getElementById('editTaskDescription').value = task.description || "";
                document.getElementById('editTaskPriority').value = task.priority;
                document.getElementById('editTaskAssignedTo').value = task.assignedToUserId || "";
                document.getElementById('editTaskDueDate').value = task.dueDate || "";

                // Render Custom Fields with values
                if (typeof renderCustomFieldInputs === 'function') {
                    renderCustomFieldInputs('editCustomFieldsContainer', task.customFieldValues || {}, team);
                }

                // Show Modal
                new bootstrap.Modal(document.getElementById('editTaskModal')).show();
            })
            .catch(err => {
                console.error(err);
                alert("Error loading task details");
            });
    }

    function submitEditTask() {
        const taskId = parseInt(document.getElementById('editTaskId').value);
        const titleEl = document.getElementById('editTaskTitle');
        const title = titleEl ? titleEl.value.trim() : "";
        
        const descEl = document.getElementById('editTaskDescription');
        const description = descEl ? descEl.value.trim() : "";
        
        const priority = parseInt(document.getElementById('editTaskPriority').value);
        const assignedToUserId = document.getElementById('editTaskAssignedTo').value;

        const titleVisible = titleEl && titleEl.closest('.mb-3') && titleEl.closest('.mb-3').style.display !== 'none';

        if (titleVisible && !title) {
            showToast("Title is required", "warning");
            return;
        }

        // Validate custom fields
        if (typeof validateCustomFields === 'function' && !validateCustomFields()) {
            return;
        }

        const editDueDateVal = document.getElementById('editTaskDueDate') ? document.getElementById('editTaskDueDate').value : null;

        const data = {
            taskId: taskId,
            title: title,
            description: description,
            priority: priority,
            dueDate: editDueDateVal || null,
            assignedToUserId: assignedToUserId, // Send assigned user
            customFieldValues: (typeof collectCustomFieldValues === 'function') ?
                collectCustomFieldValues('editCustomFieldsContainer') : {}
        };

        fetch('/Tasks/UpdateTask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(res => {
                if (!res.ok) throw new Error("Failed to update task");
                return res.json();
            })
            .then(() => {
                showToast("✅ Task updated successfully!", "success");
                // Close modal
                const modalEl = document.getElementById('editTaskModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) modal.hide();

                // Reload board
                loadTeamBoard(currentTeamName);
            })
            .catch(err => {
                console.error(err);
                showToast("Failed to update task", "danger");
            });
    }

    function loadProjectsForTaskModal() {
        const select = document.getElementById('taskProjectId');
        if (!select) return;

        fetch('/Project/GetProjects')
            .then(res => res.json())
            .then(projects => {
                select.innerHTML = '<option value="">-- No Project --</option>';
                projects.forEach(p => {
                    select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                });
            })
            .catch(() => {
                select.innerHTML = '<option value="">-- No Project --</option>';
            });
    }

    function submitCreateTask() {
        const projectSelect = document.getElementById('taskProjectId');
        const projectId = projectSelect?.value ? parseInt(projectSelect.value) : null;

        const priorityEl = document.getElementById('taskPriority');
        const priority = priorityEl ? parseInt(priorityEl.value) : 1;

        const titleEl = document.getElementById('taskTitle');
        const title = titleEl ? titleEl.value.trim() : "";
        const titleVisible = titleEl && titleEl.closest('.mb-3') && titleEl.closest('.mb-3').style.display !== 'none';

        if (titleVisible && !title) {
            showToast("Title is required", "warning");
            return;
        }

        const descEl = document.getElementById('taskDescription');
        const description = descEl ? descEl.value.trim() : "";

        const dueDateVal = document.getElementById('taskDueDate') ? document.getElementById('taskDueDate').value : null;

        const data = {
            columnId: parseInt(document.getElementById('taskColumnId').value),
            title: title,
            description: description,
            projectId: projectId,
            priority: priority,
            dueDate: dueDateVal || null,
            customFieldValues: (typeof collectCustomFieldValues === 'function') ? collectCustomFieldValues('customFieldsContainer') : {}
        };

        fetch('/Tasks/CreateTask', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
            .then(res => {
                if (!res.ok) {
                    return res.text().then(t => {
                        throw new Error(t || 'Failed to create task');
                    });
                }

                // ✅ SUCCESS (no JSON expected)
                const modalEl = document.getElementById('createTaskModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if (modal) modal.hide();

                // reload board
                loadTeamBoard(currentTeamName);
                showToast("✅ Task created successfully!", "success");
            })
            .catch(err => {
                showToast(err.message || 'Failed to create task', "danger");
            });
    }
</script>

<script>
    function saveFocusedTask() {
        const taskId = window.__focusedTaskId;
        if (!taskId) return;

        const title = document.getElementById('focusedTaskTitle').value;
        const desc = document.getElementById('focusedTaskDescription').value;
        const assignedTo = document.getElementById('focusedTaskAssignUser').value;

        fetch('/Tasks/UpdateTask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                taskId: taskId,
                title: title,
                description: desc,
                assignedToUserId: assignedTo
            })
        })
            .then(res => {
                if (!res.ok) throw new Error();
                loadTeamBoard(currentTeamName);
            })
            .catch(() => alert('Failed to update task'));
    }
</script>


<script>
    function deleteTask(taskId) {
        if (!confirm('Delete this task?')) return;

        fetch('/Tasks/DeleteTask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(taskId)
        })
            .then(res => {
                if (!res.ok) throw new Error('Failed to delete');
                
                // ✅ OPTIMIZED: Remove card from DOM immediately instead of loading board
                const card = document.querySelector(`.task-card[data-task-id="${taskId}"]`);
                if (card) {
                    card.remove();
                    updateColumnCounts();
                }
                showToast("🗑️ Task deleted successfully!", "info");
            })
            .catch(err => alert(err.message));
    }
</script>


<script>
    // --- Dropdown Options Management ---
    function addDropdownOptionRow(value = "") {
        const list = document.getElementById('newFieldOptionsList');
        if (!list) return;

        const row = document.createElement('div');
        row.className = 'input-group input-group-sm mb-2 dropdown-option-row';
        row.innerHTML = `
            <input type="text" class="form-control dropdown-option-input" value="${value}" placeholder="Option name" />
            <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()">
                <i class="bi bi-trash"></i>
            </button>
        `;
        list.appendChild(row);
    }

    // Toggle options section based on field type
    document.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'newFieldType') {
            const section = document.getElementById('newFieldOptionsSection');
            if (section) {
                if (e.target.value === 'Dropdown') {
                    section.classList.remove('d-none');
                    const list = document.getElementById('newFieldOptionsList');
                    if (list && list.children.length === 0) {
                        addDropdownOptionRow();
                    }
                } else {
                    section.classList.add('d-none');
                }
            }
        }
    });

    async function createNewField() {
        const fieldName = document.getElementById('newFieldName').value.trim();
        const fieldType = document.getElementById('newFieldType').value;
        const isRequired = document.getElementById('newFieldRequired').checked;

        if (!fieldName) {
            alert('Please enter a field name');
            return;
        }

        // Collect dropdown options
        let dropdownOptions = null;
        if (fieldType === 'Dropdown') {
            const optionInputs = document.querySelectorAll('#newFieldOptionsList .dropdown-option-input');
            const options = Array.from(optionInputs).map(i => i.value.trim()).filter(v => v !== '');
            if (options.length === 0) {
                alert('Please add at least one option for the dropdown.');
                return;
            }
            dropdownOptions = options.join(',');
        }

        try {
            const res = await fetch('/Tasks/CreateCustomField', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fieldName, fieldType, isRequired, dropdownOptions })
            });

            if (!res.ok) throw new Error('Server error');

            // Clear form
            document.getElementById('newFieldName').value = '';
            document.getElementById('newFieldType').value = 'Text';
            document.getElementById('newFieldRequired').checked = false;
            document.getElementById('newFieldOptionsList').innerHTML = '';
            document.getElementById('newFieldOptionsSection').classList.add('d-none');

            // ✅ Reload Manage Fields list
            window.customFieldsCache = null;
            if (typeof loadFieldsList === 'function') await loadFieldsList();

            // ✅ Refresh Create / Edit modals immediately — no page refresh needed
            if (typeof refreshOpenModals === 'function') await refreshOpenModals();

            showToast(`✅ Field "${fieldName}" added!`, 'success');

        } catch (err) {
            alert('Failed to create field: ' + err.message);
        }
    }
</script>



<script>
    function showAssignToast(userId, assignedBy, assignedAt) {
        fetch(`/Users/GetUserInfo?userId=${userId}`)
            .then(res => res.json())
            .then(u => {
                const toast = document.createElement('div');
                toast.className = 'assign-toast';
                toast.innerHTML = `
                    Task assigned to <b>${u.userName}</b> (${u.role})<br/>
                    By ${assignedBy} at ${assignedAt}
                `;

                document.body.appendChild(toast);

                setTimeout(() => toast.remove(), 5000);
            });
    }









    // Unified assignment logic moved to tasks.js


    function enableTaskDragDrop() {

        const role = (typeof currentUserRole !== 'undefined') ? currentUserRole : 'User';

        document.querySelectorAll('.kanban-tasks').forEach(container => {
            // Skip History column task list (read-only)
            if (container.id === 'historyTasksList') return;

            if (container._taskSortable) {
                container._taskSortable.destroy();
            }

            container._taskSortable = new Sortable(container, {
                group: {
                    name: 'tasks',
                    pull: container.closest('.kanban-column')?.classList.contains('col-completed') ? false : true,
                    put: true
                },
                animation: 200,
                draggable: '.task-card',
                ghostClass: 'task-ghost',
                chosenClass: 'task-chosen',

                onMove: function (evt) {
                    const targetColumn = evt.to?.closest('.kanban-column');
                    if (!targetColumn) return true;

                    const colName = targetColumn.dataset.columnName?.toLowerCase().trim();

                    // Block: History column
                    if (colName === 'history' || targetColumn.classList.contains('col-history')) {
                        return false;
                    }

                    // Block: Non-admin to completed (unless has review permission)
                    if (colName === 'completed' && role !== 'Admin') {
                        if (!window.boardPermissions || !window.boardPermissions.canReviewTask) {
                            return false;
                        }
                    }

                    return true;
                },

                onStart: function (evt) {
                    // Mark that a drag is in progress to prevent click from firing
                    evt.item._isDragging = true;
                },

                onEnd: function (evt) {
                    // Allow click events again after a short delay
                    setTimeout(() => { evt.item._isDragging = false; }, 100);

                    // Skip if dropped in the same column
                    if (evt.from === evt.to) return;

                    const taskId = parseInt(evt.item.dataset.taskId);
                    // The task container's parent is the kanban-column
                    const targetColumnEl = evt.to.closest('.kanban-column');
                    const newColumnId = parseInt(targetColumnEl?.dataset.columnId);
                    const colName = targetColumnEl?.dataset.columnName?.toLowerCase().trim();

                    // Revalidate restrictions
                    if (colName === 'history' || (colName === 'completed' && role !== 'Admin' && (!window.boardPermissions || !window.boardPermissions.canReviewTask))) {
                        showToast(colName === 'history' ? '📋 History is read-only.' : '🔒 Only authorized reviewers or admins can move tasks to Completed.', 'warning');
                        loadTeamBoard(currentTeamName);
                        return;
                    }

                    if (!taskId || !newColumnId) return;

                    // ✅ Update count badges immediately after drag
                    updateColumnCounts();

                    // ✅ Hide/Show buttons immediately without reload
                    const assignBtn = evt.item.querySelector('.action-btn-assign');
                    const editBtn = evt.item.querySelector('.action-btn-edit');
                    const reviewBtn = evt.item.querySelector('.action-btn-review');
                    const archiveBtn = evt.item.querySelector('.action-btn-archive');

                    const isReview = colName === 'review';
                    const isCompleted = colName === 'completed';
                    const isRestricted = isReview || isCompleted;

                    // Assign/Edit: Hide in Review/Completed
                    if (assignBtn) assignBtn.style.display = isRestricted ? 'none' : 'inline-flex';
                    if (editBtn) editBtn.style.display = isRestricted ? 'none' : 'inline-flex';

                    // Review: Only show in Review column
                    if (reviewBtn) reviewBtn.style.display = isReview ? 'inline-flex' : 'none';

                    // Archive: Only show in Completed column
                    if (archiveBtn) archiveBtn.style.display = isCompleted ? 'inline-flex' : 'none';

                    // ✅ Update Review Badges (Pending/Pass/Fail)
                    const pendingBadge = evt.item.querySelector('.review-badge-pending');
                    const failBadge = evt.item.querySelector('.review-badge-fail');
                    const passBadge = evt.item.querySelector('.review-badge-pass');

                    if (isReview) {
                        // Moving TO Review column: Always resets to Pending on server
                        if (pendingBadge) pendingBadge.style.display = 'inline-flex';
                        if (failBadge) failBadge.style.display = 'none';
                        if (passBadge) passBadge.style.display = 'none';
                    } else if (colName !== 'completed') {
                        // Moving OUT of Review (and not to completed): Hide pending
                        if (pendingBadge) pendingBadge.style.display = 'none';
                    }

                    updateTaskColumn(taskId, newColumnId);
                }
            });
        });
    }



    function updateTaskColumn(taskId, columnId) {
        // ✅ Show toast immediately (optimistic UI — no waiting for server)
        showToast('✅ Task moved successfull!', 'success');

        fetch('/Tasks/MoveTask', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                taskId: taskId,
                columnId: columnId
            })
        })
            .then(res => {
                if (!res.ok) return res.text().then(t => { throw new Error(t || 'Failed to move task'); });
            })
            .catch(err => {
                showToast(err.message || 'Failed to move task', 'danger');
                // reload board to recover UI
                loadTeamBoard(currentTeamName);
            });
    }

    // ✅ Helper to update column counts dynamically
    function updateColumnCounts() {
        document.querySelectorAll('.kanban-column').forEach(col => {
            const count = col.querySelectorAll('.kanban-tasks .task-card:not(.d-none)').length;
            const badge = col.querySelector('.task-count-badge');
            if (badge) badge.textContent = count;
        });
    }

    function deleteProject(id, name) {
        if (!confirm(`Delete project '${name}' and all its contents? This cannot be undone.`)) return;

        fetch('/Project/DeleteProject', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(id)
        })
            .then(res => {
                if (!res.ok) throw new Error('Failed to delete project');
                loadProjectList();
                // clear board if deleted project was active
                const boardContainer = document.getElementById('taskBoardContainer');
                boardContainer.innerHTML = '';
            })
            .catch(err => alert(err.message));
    }

    function filterBoardTasks() {
        const searchText = document.getElementById('taskSearchInput')?.value.toLowerCase() || "";
        const priorityFilter = document.getElementById('priorityFilter')?.value || "";
        const assigneeFilter = document.getElementById('assigneeFilter')?.value || "";
        const adminFilter = document.getElementById('adminAssignedFilter')?.value || "";

        const cards = document.querySelectorAll('.task-card');

        cards.forEach(card => {
            // 1. Search Text (Title, Description, Custom Fields)
            const title = card.querySelector('.task-title-text')?.innerText.toLowerCase() || "";
            const desc = card.querySelector('.task-desc-text')?.innerText.toLowerCase() || "";
            const customFields = card.querySelector('.custom-fields-summary')?.innerText.toLowerCase() || "";

            const matchesSearch = !searchText ||
                title.includes(searchText) ||
                desc.includes(searchText) ||
                customFields.includes(searchText);

            // 2. Priority
            const cardPriority = card.dataset.priority || "";
            const matchesPriority = !priorityFilter || cardPriority === priorityFilter;

            // 3. Assignee
            const cardAssigneeId = card.dataset.assignedToId || "";
            const matchesAssignee = !assigneeFilter || cardAssigneeId === assigneeFilter;

            // 4. Assigned by Admin
            const isAdminAssigned = card.dataset.assignedByAdmin === "true";
            let matchesAdmin = true;
            if (adminFilter === "Admin") {
                matchesAdmin = isAdminAssigned;
            }

            // Combine all
            if (matchesSearch && matchesPriority && matchesAssignee && matchesAdmin) {
                card.style.display = "block";
                card.classList.remove('d-none'); // Ensure no d-none override
            } else {
                card.style.display = "none";
            }
        });
    }

    // ===== PERSISTENT FIELD SETTINGS (Title, Description, etc.) =====
    const EMS_FIELD_SETTINGS = 'EMS_Field_Settings';

    function getFieldSettings() {
        const settings = localStorage.getItem(EMS_FIELD_SETTINGS);
        return settings ? JSON.parse(settings) : { hidden: [], names: {} };
    }

    function saveFieldSettings(settings) {
        localStorage.setItem(EMS_FIELD_SETTINGS, JSON.stringify(settings));
    }

    function applyFieldSettings() {
        const settings = getFieldSettings();
        console.log("Applying field settings:", settings);
        
        // Apply hidden states
        (settings.hidden || []).forEach(groupId => {
            const el = document.getElementById(groupId);
            if (el) el.style.display = 'none';
        });

        // Apply custom names
        for (const [labelId, name] of Object.entries(settings.names || {})) {
            const el = document.getElementById(labelId);
            if (el) {
                const isRequired = el.textContent.includes('*');
                el.textContent = name + (isRequired ? ' *' : '');
            }
        }
    }

    function renameField(labelId) {
        const labelEl = document.getElementById(labelId);
        if (!labelEl) return;
        const currentName = labelEl.textContent.replace(' *', '').trim();
        const newName = prompt("Rename field:", currentName);
        
        if (newName !== null && newName.trim() !== "" && newName !== currentName) {
            const name = newName.trim();
            const isRequired = labelEl.textContent.includes('*');
            labelEl.textContent = name + (isRequired ? ' *' : '');

            // Persist
            const settings = getFieldSettings();
            settings.names[labelId] = name;
            saveFieldSettings(settings);
        }
    }

    function hideField(groupId) {
        if (!confirm("Are you sure you want to delete this field from view? This will be saved in your browser.")) return;
        const groupEl = document.getElementById(groupId);
        if (groupEl) {
            groupEl.style.display = 'none';

            // Persist
            const settings = getFieldSettings();
            if (!settings.hidden.includes(groupId)) {
                settings.hidden.push(groupId);
            }
            saveFieldSettings(settings);
        }
    }

    // Call on load
    document.addEventListener('DOMContentLoaded', function() {
        applyFieldSettings();
    });

    function getCsrfToken() {
        const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
        return tokenInput ? tokenInput.value : '';
    }

    // ═══════════════════════════════════════════════════════
    //  EXCEL IMPORT — JAVASCRIPT
    // ═══════════════════════════════════════════════════════

    let _excelFile = null;
    let _previewData = null;

    function openExcelImportModal(teamName) {
        document.getElementById('importTeamName').value = teamName;
        resetExcelImport();

        // Populate target column dropdown from board columns
        const colSelect = document.getElementById('importTargetColumn');
        colSelect.innerHTML = '';
        const columns = document.querySelectorAll('#kanbanBoard .kanban-column[data-column-id]');
        columns.forEach(col => {
            const colId = col.getAttribute('data-column-id');
            const colName = col.getAttribute('data-column-name');
            if (colId && colId !== 'history' && colName) {
                const opt = document.createElement('option');
                opt.value = colId;
                opt.textContent = colName;
                colSelect.appendChild(opt);
            }
        });

        const modal = new bootstrap.Modal(document.getElementById('excelImportModal'));
        modal.show();
    }

    function switchImportTab(tab) {
        document.querySelectorAll('#importTabs .nav-link').forEach(btn => {
            btn.classList.toggle('active', btn.getAttribute('data-tab') === tab);
        });
        document.querySelectorAll('.import-tab-content').forEach(el => el.classList.add('d-none'));
        document.getElementById('importTab-' + tab).classList.remove('d-none');

        if (tab === 'history') {
            loadImportHistory();
        }
    }

    function resetExcelImport() {
        _excelFile = null;
        _previewData = null;

        // Reset file input
        const fileInput = document.getElementById('excelFileInput');
        if (fileInput) fileInput.value = '';

        // Show upload, hide others
        showStep('excelUploadStep');
        hideStep('excelPreviewStep');
        hideStep('excelProgressStep');
        hideStep('excelResultStep');

        // Reset file info
        document.getElementById('excelFileInfo').classList.add('d-none');
        document.getElementById('excelDropZone').style.display = '';

        // Reset buttons
        document.getElementById('btnPreviewExcel').classList.add('d-none');
        document.getElementById('btnStartImport').classList.add('d-none');
        document.getElementById('btnImportMore').classList.add('d-none');

        // Reset tab
        switchImportTab('upload');
    }

    function showStep(stepId) {
        document.getElementById(stepId).classList.remove('d-none');
    }
    function hideStep(stepId) {
        document.getElementById(stepId).classList.add('d-none');
    }

    // ─── Drag & Drop ───
    function handleExcelDragOver(e) {
        e.preventDefault();
        e.stopPropagation();
        document.getElementById('excelDropZone').classList.add('drag-over');
    }
    function handleExcelDragLeave(e) {
        e.preventDefault();
        e.stopPropagation();
        document.getElementById('excelDropZone').classList.remove('drag-over');
    }
    function handleExcelDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        document.getElementById('excelDropZone').classList.remove('drag-over');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            processExcelFile(files[0]);
        }
    }
    function handleExcelFileSelect(input) {
        if (input.files.length > 0) {
            processExcelFile(input.files[0]);
        }
    }

    function processExcelFile(file) {
        const ext = file.name.split('.').pop().toLowerCase();
        if (ext !== 'xlsx' && ext !== 'xls') {
            showToast('Only .xlsx and .xls files are supported', 'danger');
            return;
        }
        _excelFile = file;

        // Show file info
        document.getElementById('excelDropZone').style.display = 'none';
        document.getElementById('excelFileInfo').classList.remove('d-none');
        document.getElementById('excelFileName').textContent = file.name;
        document.getElementById('excelFileSize').textContent = formatFileSize(file.size);

        // Show preview button
        document.getElementById('btnPreviewExcel').classList.remove('d-none');
    }

    function clearExcelFile() {
        _excelFile = null;
        document.getElementById('excelDropZone').style.display = '';
        document.getElementById('excelFileInfo').classList.add('d-none');
        document.getElementById('btnPreviewExcel').classList.add('d-none');
        const fileInput = document.getElementById('excelFileInput');
        if (fileInput) fileInput.value = '';
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // ─── Preview ───
    async function previewExcelFile() {
        if (!_excelFile) return;

        const btn = document.getElementById('btnPreviewExcel');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Analyzing...';

        const formData = new FormData();
        formData.append('file', _excelFile);
        formData.append('teamName', document.getElementById('importTeamName').value);

        try {
            const response = await fetch('/ExcelImport/Preview', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (!data.success) {
                showToast(data.message || 'Preview failed', 'danger');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-eye me-1"></i> Preview Data';
                return;
            }

            _previewData = data;

            // Update stats
            document.getElementById('previewTotalRows').textContent = data.totalRows;
            document.getElementById('previewTotalCols').textContent = data.totalColumns;

            // Populate column mapping dropdowns
            populateMappingDropdowns(data.headers);

            // Build preview table
            buildPreviewTable(data.headers, data.sampleRows);

            // Switch to preview step
            hideStep('excelUploadStep');
            showStep('excelPreviewStep');

            // Show import button
            btn.classList.add('d-none');
            const importBtn = document.getElementById('btnStartImport');
            importBtn.classList.remove('d-none');
            document.getElementById('btnImportCount').textContent = data.totalRows;

        } catch (err) {
            showToast('Error previewing file: ' + err.message, 'danger');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-eye me-1"></i> Preview Data';
        }
    }

    function populateMappingDropdowns(headers) {
        const titleSel = document.getElementById('mappingTitleCol');
        const descSel = document.getElementById('mappingDescCol');

        titleSel.innerHTML = '<option value="-1">Auto (first column)</option>';
        descSel.innerHTML = '<option value="-1">None</option>';

        headers.forEach((h, i) => {
            titleSel.innerHTML += `<option value="${i}">${h}</option>`;
            descSel.innerHTML += `<option value="${i}">${h}</option>`;
        });
    }

    function buildPreviewTable(headers, rows) {
        const thead = document.getElementById('previewTableHead');
        const tbody = document.getElementById('previewTableBody');

        // Header
        let headerHtml = '<tr>';
        headerHtml += '<th class="text-center" style="width: 30px;">#</th>';
        headers.forEach(h => {
            headerHtml += `<th>${escapeHtml(h)}</th>`;
        });
        headerHtml += '</tr>';
        thead.innerHTML = headerHtml;

        // Body
        let bodyHtml = '';
        rows.forEach((row, ri) => {
            bodyHtml += '<tr>';
            bodyHtml += `<td class="text-center text-muted">${ri + 1}</td>`;
            row.forEach(cell => {
                bodyHtml += `<td title="${escapeHtml(cell)}">${escapeHtml(cell)}</td>`;
            });
            bodyHtml += '</tr>';
        });
        tbody.innerHTML = bodyHtml;
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ─── Import ───
    async function startExcelImport() {
        if (!_excelFile || !_previewData) return;

        const teamName = document.getElementById('importTeamName').value;
        const columnId = document.getElementById('importTargetColumn').value;
        const titleCol = document.getElementById('mappingTitleCol').value;
        const descCol = document.getElementById('mappingDescCol').value;

        if (!columnId) {
            showToast('Please select a target column', 'warning');
            return;
        }

        // Switch to progress step
        hideStep('excelPreviewStep');
        showStep('excelProgressStep');
        document.getElementById('btnStartImport').classList.add('d-none');

        // Animate progress
        const progressBar = document.getElementById('importProgressBar');
        const progressText = document.getElementById('importProgressText');

        let fakeProgress = 0;
        const progressInterval = setInterval(() => {
            if (fakeProgress < 90) {
                fakeProgress += Math.random() * 3;
                progressBar.style.width = Math.min(fakeProgress, 90) + '%';
                progressText.textContent = `Processing... ${Math.floor(fakeProgress)}%`;
            }
        }, 500);

        const formData = new FormData();
        formData.append('file', _excelFile);
        formData.append('teamName', teamName);
        formData.append('columnId', columnId);
        if (titleCol !== '-1') formData.append('titleColumnIndex', titleCol);
        if (descCol !== '-1') formData.append('descriptionColumnIndex', descCol);

        try {
            const response = await fetch('/ExcelImport/Import', {
                method: 'POST',
                body: formData
            });

            clearInterval(progressInterval);
            progressBar.style.width = '100%';
            progressText.textContent = 'Complete!';

            const data = await response.json();

            // Wait a moment then show results
            setTimeout(() => {
                showImportResults(data, response.ok);
            }, 500);

        } catch (err) {
            clearInterval(progressInterval);
            showImportResults({
                success: false,
                message: 'Network error: ' + err.message,
                successCount: 0,
                errorCount: 0,
                durationMs: 0
            }, false);
        }
    }

    function showImportResults(data, isOk) {
        hideStep('excelProgressStep');
        showStep('excelResultStep');

        // Show appropriate icon
        document.getElementById('resultIconSuccess').classList.add('d-none');
        document.getElementById('resultIconPartial').classList.add('d-none');
        document.getElementById('resultIconFail').classList.add('d-none');

        if (data.success && data.errorCount === 0) {
            document.getElementById('resultIconSuccess').classList.remove('d-none');
        } else if (data.success && data.errorCount > 0) {
            document.getElementById('resultIconPartial').classList.remove('d-none');
        } else {
            document.getElementById('resultIconFail').classList.remove('d-none');
        }

        // Stats
        document.getElementById('resultSuccessCount').textContent = data.successCount || 0;
        document.getElementById('resultErrorCount').textContent = data.errorCount || 0;
        document.getElementById('resultDuration').textContent =
            data.durationMs ? (data.durationMs / 1000).toFixed(1) + 's' : '—';
        document.getElementById('resultMessage').textContent = data.message || '';

        // Errors
        if (data.errors && data.errors.length > 0) {
            document.getElementById('resultErrors').classList.remove('d-none');
            document.getElementById('resultErrorList').innerHTML =
                data.errors.map(e => `<div class="mb-1">${escapeHtml(e)}</div>`).join('');
        } else {
            document.getElementById('resultErrors').classList.add('d-none');
        }

        // Show import more button
        document.getElementById('btnImportMore').classList.remove('d-none');

        // Reload the board to show new tasks
        if (data.success) {
            const teamName = document.getElementById('importTeamName').value;
            if (teamName && typeof loadTeamBoard === 'function') {
                setTimeout(() => loadTeamBoard(teamName), 1000);
            }
        }
    }

    // ─── Import History ───
    async function loadImportHistory() {
        const teamName = document.getElementById('importTeamName').value;
        const container = document.getElementById('importHistoryContent');

        container.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="text-muted mt-2">Loading import history...</p>
            </div>
        `;

        try {
            const response = await fetch(`/ExcelImport/History?teamName=${encodeURIComponent(teamName)}`);
            const data = await response.json();

            if (!data.success || !data.logs || data.logs.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-inbox text-muted" style="font-size: 2.5rem;"></i>
                        <p class="text-muted mt-2">No imports yet for this board.</p>
                    </div>
                `;
                return;
            }

            let html = '';
            data.logs.forEach(log => {
                const statusClass = log.status === 'Completed' ? 'text-success' :
                    log.status === 'Failed' ? 'text-danger' : 'text-warning';
                const statusIcon = log.status === 'Completed' ? 'bi-check-circle-fill' :
                    log.status === 'Failed' ? 'bi-x-circle-fill' : 'bi-exclamation-triangle-fill';

                html += `
                    <div class="import-history-card">
                        <div class="d-flex align-items-center gap-3">
                            <i class="bi bi-file-earmark-excel-fill text-success fs-4"></i>
                            <div>
                                <div class="fw-bold">${escapeHtml(log.fileName)}</div>
                                <small class="text-muted">
                                    ${log.importedAt} · by ${escapeHtml(log.importedBy)} · 
                                    into <strong>${escapeHtml(log.columnName)}</strong>
                                </small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <div class="text-center">
                                <div class="fw-bold text-success">${log.successCount}</div>
                                <small class="text-muted">OK</small>
                            </div>
                            <div class="text-center">
                                <div class="fw-bold text-danger">${log.errorCount}</div>
                                <small class="text-muted">Err</small>
                            </div>
                            <div class="text-center">
                                <div class="fw-bold text-info">${log.durationMs ? (log.durationMs / 1000).toFixed(1) + 's' : '—'}</div>
                                <small class="text-muted">Time</small>
                            </div>
                            <span class="${statusClass}"><i class="bi ${statusIcon}"></i></span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

        } catch (err) {
            container.innerHTML = `
                <div class="text-center py-4 text-danger">
                    <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                    <p class="mt-2">Error loading history: ${escapeHtml(err.message)}</p>
                </div>
            `;
        }
    }

    // Existing end of script
</script>

<script>
// Function to clear all tasks in a specific column
async function clearColumnTasks(columnId) {
    if (!confirm('Are you sure you want to permanently delete ALL tasks in this column? This action cannot be undone.')) {
        return;
    }

    try {
        const resp = await fetch('/Tasks/DeleteAllTasksInColumn', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
            },
            body: JSON.stringify(columnId)
        });

        if (!resp.ok) {
            const txt = await resp.text();
            throw new Error(txt || 'Failed to clear tasks');
        }

        const res = await resp.json();
        if (typeof showToast === 'function') {
            showToast(`✅ Successfully deleted ${res.count} tasks`, 'success');
        }

        // Refresh board
        if (typeof loadTeamBoard === 'function' && window.currentTeamName) {
            loadTeamBoard(window.currentTeamName);
        }
    } catch (err) {
        console.error(err);
        if (typeof showToast === 'function') {
            showToast(err.message, 'danger');
        } else {
            alert(err.message);
        }
    }
}
</script>
